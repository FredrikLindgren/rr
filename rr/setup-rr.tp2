/*************************************************************************
 *                          Rogue Rebalancing mod
 *                            -=by aVENGER=-
 *                http://www.spellholdstudios.net/ie/rr
 *************************************************************************/


BACKUP ~rr/backup~
AUTHOR "Wisp, www.shsforums.net"
VERSION ~v4.70~

ALWAYS
  INCLUDE ~rr/lib/rr#afix.tph~                                        // Include the Rogue Rebalancing Assorted Fixes macro
  INCLUDE ~rr/lib/rr#bg1v.tpa~                                        // Include the BG1 variables macro (used for proper Tutu and BGT compatibility)
  INCLUDE ~rr/lib/regexp.tph~                                         // allows regexp to match tabs and newlines (borrowed from the G3 BG2 Fixpack)
  INCLUDE ~rr/lib/rr#aglef.tph~                                       // Include my custom "Add Global Effect" function
  INCLUDE ~rr/lib/rr#sp2in.tph~                                       // Include my custom "Spell to Innate" function
  INCLUDE "rr/lib/lib.tpa"
  // INCLUDE ~rr/lib/tobexfix.tph~                                    // obsolete as of TobEx 0022 which RR now ships with

  LAM bgee_language
END

README ~rr/doc/readme_rr.html~
ASK_EVERY_COMPONENT


LANGUAGE ~English~ ~ENGLISH~ ~rr/tra/english/game.tra~ ~rr/tra/english/setup.tra~
LANGUAGE ~Francais (by the d'Oghmatiques)~ ~FRENCH~ ~rr/tra/english/game.tra~ ~rr/tra/english/setup.tra~ ~rr/tra/french/game.tra~ ~rr/tra/french-%WEIDU_OS%.tra~
LANGUAGE ~Espanol (por Immortality, SirLancelot, Nieve, Clan DLAN y Lisandro)~ ~SPANISH~ ~rr/tra/english/game.tra~ ~rr/tra/english/setup.tra~ ~rr/tra/spanish/game.tra~ ~rr/tra/spanish-%WEIDU_OS%.tra~
LANGUAGE ~Deutsch (by Cronox and Leomar)~ ~GERMAN~ ~rr/tra/english/game.tra~ ~rr/tra/english/setup.tra~ ~rr/tra/german/game.tra~ ~rr/tra/german/setup-%WEIDU_OS%.tra~
LANGUAGE ~Russian (by the Aerie.ru and arcanecoast.ru teams)~ ~RUSSIAN~ ~rr/tra/english/game.tra~ ~rr/tra/english/setup.tra~ ~rr/tra/russian/game.tra~
LANGUAGE ~Italian (by Andrea C. and ilot)~ ~ITALIAN~ ~rr/tra/english/game.tra~ ~rr/tra/english/setup.tra~ ~rr/tra/italian/game.tra~ ~rr/tra/italian/setup-%WEIDU_OS%.tra~
LANGUAGE ~Japanese (by Taro)~ ~JAPANESE~ ~rr/tra/english/game.tra~ ~rr/tra/english/setup.tra~ ~rr/tra/japanese/game.tra~ ~rr/tra/japanese/setup-%WEIDU_OS%.tra~
LANGUAGE ~Polski (Clan Children of Bhaal - BoRo & Kinski)~ ~polish~
~rr/tra/english/game.tra~ ~rr/tra/english/setup.tra~
~rr/tra/polish/game.tra~ ~rr/tra/polish/setup-%WEIDU_OS%.tra~


////////////////////////////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Proper dual-wielding implementation for Thieves and Bards
//////////////////////////////////////////////////////////////////////////////////////////////


// *** For fellow modders *** this component can be detected by searching for the following file - RR#DWF.RR

BEGIN @1 DESIGNATED 0
REQUIRE_PREDICATE ENGINE_IS ~bg2 tob bgee bg2ee~ @902

COPY_EXISTING ~sw1h01.itm~ ~override/RR#DWF.RR~

// Thief & Bard TWS fix

DEFINE_ACTION_FUNCTION rogue_twf BEGIN
  OUTER_SET count = 0

  ACTION_FOR_EACH class IN
                  thief
                  bard
                  fighter_thief
                  fighter_mage_thief
                  mage_thief
                  cleric_thief
  BEGIN
    OUTER_SPRINT $rogues("%count%") "%class%"
    OUTER_SET ++count
  END

  COPY_EXISTING kitlist.2da override
    READ_2DA_ENTRIES_NOW kitlist 3
    FOR (i = 2; i < kitlist; ++i) BEGIN // Skip past the header and RESERVE rows
      READ_2DA_ENTRY_FORMER kitlist i 1 label
      READ_2DA_ENTRY_FORMER kitlist i 8 class
      PATCH_IF class = 4 OR class = 5 BEGIN // thief OR bard
        SPRINT $rogues("%count%") "%label%"
        ++count
      END
    END
  BUT_ONLY

  COPY_EXISTING ~WEAPPROF.2DA~ override
    READ_2DA_ENTRIES_NOW weapprof 3
    COUNT_2DA_COLS cols
    PHP_EACH rogues AS _ => symbol BEGIN
      FOR (i = 0; i < cols - 1; ++i) BEGIN
        READ_2DA_ENTRY_FORMER weapprof 0 i column_name
        PATCH_IF "%column_name%" STRING_EQUAL_CASE "%symbol%" BEGIN
          SET_2DA_ENTRY_LATER wweapprof 32 i + 1 3 // 3 stars in two-weapon style
        END
      END
    END
    SET_2DA_ENTRIES_NOW wweapprof 3
    PRETTY_PRINT_2DA
  BUT_ONLY
END

LAF rogue_twf END



///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Thief kit revisions
///////////////////////////////////////////////////////////////////////


// *** For fellow modders *** this component can be detected by searching for the following file - RR#TRNQ.EFF

BEGIN @2 DESIGNATED 1
REQUIRE_PREDICATE ENGINE_IS ~tob bgee bg2ee~ @902

LAUNCH_ACTION_MACRO ~RR#AFIX~

// Assassin kit revision

COPY ~RR/RR_CORE/SPELLS/RR#TAS00.SPL~ override               // Assassin save vs. poison bonus
     ~RR/RR_CORE/BAM/RR#TAS01.BAM~    override               // Assassin Death Attack innate ability icon
     ~RR/RR_CORE/SPELLS/RR#TAS01.EFF~ override               // Death Attack cast secondary spell effect

COPY ~RR/RR_CORE/SPELLS/RR#TAS1B.EFF~ override               // Death Attack protect from secondary spell effect (for Golems, Undead...etc.)
  SAY 0x1C @86 // Unaffected by Death Attack
BUT_ONLY

LAM load_RR#DEATA_var

COPY ~RR/RR_CORE/SPELLS/RR#TAS01.SPL~ override               // Assassin Death Attack innate ability (coat weapons shell)
  SAY NAME1 @36 SAY NAME2 @36 // Death Attack
  WRITE_BYTE 0x27 RR#DEATA                                   // assign new secondary type

COPY ~RR/RR_CORE/SPELLS/RR#TAS1B.SPL~ override               // Death Attack second part (the actual ability)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      PATCH_IF ("%opcode%" = 221) BEGIN                            // effect #221: remove secondary type
        WRITE_LONG  ("%fx_off%" + 0x08 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) RR#DEATA  // set the designated secondary type
      END
    END
  END
BUT_ONLY

COPY ~RR/RR_CORE/SPELLS/RR#TAS02.EFF~ override               // Poison Weapon cast secondary spell effect

COPY ~RR/RR_CORE/SPELLS/RR#TAS2B.EFF~ override               // Poison Weapon protect from secondary spell effect (for Golems, Undead...etc.)
  SAY 0x1C @83 // Unaffected by Poison
BUT_ONLY

COPY ~RR/RR_CORE/SPELLS/RR#TAS2B.SPL~ override               // Poison Weapon second part (the actual ability)

COPY_EXISTING SPCL423.SPL override                           // Poison Weapon Assassin ability
  PATCH_FOR_EACH opcode IN
                 248
                 249
  BEGIN
    LPF DELETE_SPELL_EFFECT INT_VAR opcode_to_delete = opcode END
    LPF ADD_SPELL_EFFECT
      INT_VAR
        opcode
        target = 1
        duration = 30
        insert_point = 0
      STR_VAR
        resource = RR#TAS02
    END
  END
  PATCH_IF GAME_IS ~bgee bg2ee~ BEGIN
    LPF DELETE_SPELL_EFFECT INT_VAR opcode_to_delete = 321 END
    LPF ADD_SPELL_EFFECT
      INT_VAR
        opcode = 321
        target = 1
        resist_dispel = 2
        insert_point = 0
      STR_VAR
        resource = EVAL "%SOURCE_RES%"
    END
  END
BUT_ONLY

COPY_EXISTING CLABTH02.2DA override                           // Assassin kit ability table
  REPLACE_TEXTUALLY ~AP_SPCL421~ ~GA_SPCL423~                 // Remove the Assassin's innate to hit and damage bonus
  READ_2DA_ENTRY 5 1 1 entry
  PATCH_IF "%entry%" STRING_EQUAL_CASE GA_SPCL423 BEGIN
    SET_2DA_ENTRY 5 1 1 ~****~                                // Empty the first column of the row (contains leftover Poison Weapon use)
    SET_2DA_ENTRY 6 1 40 ~AP_SPCL332~                         // Grant a +1 bonus to backstab multiplier at level 1
    SET_2DA_ENTRY 1 21 40 ~****~                              // Remove the +1 bonus to backstab multiplier at level 21
  END
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 8  f_Increment = 8 STR_VAR f_Entry = AP_RR#TAS00 END //Give the Assassin the save vs. poison bonus
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 16 f_Increment = 8 STR_VAR f_Entry = GA_RR#TAS01 END //Give the Assassin the Death Attack ability
  PRETTY_PRINT_2DA
BUT_ONLY

COPY_EXISTING ALIGNMNT.2DA override                           // Disallow good alignments for Assassins
 SET_2DA_ENTRY_LATER ~RR#TALIGN~ 38 1 ~0~                     // Dissallow Lawful Good alignment
 SET_2DA_ENTRY_LATER ~RR#TALIGN~ 38 4 ~0~                     // Dissallow Neutral Good alignment
 SET_2DA_ENTRY_LATER ~RR#TALIGN~ 38 7 ~0~                     // Dissallow Chaotic Good alignment
 SET_2DA_ENTRIES_NOW ~RR#TALIGN~ 1
 PRETTY_PRINT_2DA
BUT_ONLY

OUTER_SPRINT desc @35
LAF set_kit_description STR_VAR kit = assassin desc END


// Swashbuckler kit revision

COPY_EXISTING CLABTH04.2DA override                           // Swashbuckler's kit ability table
  REPLACE_TEXTUALLY ~AP_SPCL141~ ~****~                       // Remove the Swashbuckler's innate damage bonus
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 2 f_MaxLevel = 20 f_Increment = 2 STR_VAR f_Entry = AP_RR#TSB01 END // Give the Swashbuckler the new to hit bonus
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 1 f_MaxLevel = 1                  STR_VAR f_Entry = AP_RR#TSB03 END // Prevent Swashbucklers from recieving a backstab bonus from items
  PRETTY_PRINT_2DA
BUT_ONLY

COPY ~RR/RR_CORE/SPELLS/RR#TSB01.SPL~ override                // Swashbuckler's new to hit bonus
COPY ~RR/RR_CORE/SPELLS/RR#TSB03.SPL~ override                // This prevents Swashbucklers from recieving a backstab bonus from items which grant it (such as my revised SSoB)

COPY_EXISTING dualclas.2da override                           // dual-class list
  SET_2DA_ENTRY 40 1 1 ~0~                                    // prevent Swashbucklers from dual-classing to Fighters
BUT_ONLY

OUTER_SPRINT desc @28
LAF set_kit_description STR_VAR kit = swashbuckler desc END


// Bounty Hunter kit revision

COPY_EXISTING CLABTH03.2DA override                           // Bounty Hunter's kit ability table
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 1  f_MaxLevel = 1    STR_VAR f_Entry = GA_RR#TRNQ END // Give the Bounty Hunter the Paralytic Toxin ability at level 1
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 10 f_Increment = 10  STR_VAR f_Entry = GA_RR#TRNQ END // Give the Bounty Hunter the Paralytic Toxin ability
  PRETTY_PRINT_2DA
BUT_ONLY

COPY_EXISTING ~SPCL414.SPL~ override                          // patch the Special Snare shell spell to use the revised RR version and rename it
SAY NAME1 @38 SAY NAME2 @38 // Set Alchemical Trap
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      PATCH_IF ("%opcode%" = 252) BEGIN // effect #252: Set Trap
        WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "RR#TBH01" #8 // use RR's revised Special Snares
      END
    END
  END
  WHILE ("%abil_num%" > 0) BEGIN
    SET "abil_num" = ("%abil_num%" - 1)
    WRITE_SHORT ("%abil_off%" + 0x0e + (0x28 * "%abil_num%")) 1     // reduce casting range to 1
  END
BUT_ONLY

ADD_PROJECTILE ~RR/RR_CORE/PRO/RR#TBH01.PRO~                   // New projectile for Special Snares (this also assures Trap Cap Removal compatibility)

COPY ~RR/RR_CORE/SPELLS/RR#TBH01.SPL~ override                 // RR's revised Bounty Hunter Special Snares (casting shell)
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) "%RR#TBH01%"              // use new projectile
  END

COPY ~RR/RR_CORE/SPELLS/RR#TBH1A.SPL~ override                 // Special Snares secondary effect level 1-5 (dazzle)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
     READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
     READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 14052)) BEGIN           // display string: "THAC0 Modification"
       SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @715  // Dazzled
      END
    END
  END

COPY ~RR/RR_CORE/SPELLS/RR#TBH1A.SPL~ override                 // Alchemical Trap subdual damage

COPY ~RR/RR_CORE/SPELLS/RR#TBH1A.EFF~ override                 // Alchemical Trap subdual damage immunity
  SAY 0x1C @90 // Immune to subdual damage

COPY ~RR/RR_CORE/SPELLS/RR#TBH1B.SPL~ override                 // Alchemical Trap secondary effects
     ~RR/RR_CORE/SPELLS/RR#TBH1B.EFF~ override                 // Alchemical Trap secondary effects immunity
     ~RR/RR_CORE/BAM/RR#TRNQ.BAM~     override                 // Bounty Hunter's Paralytic Toxin innate ability icon
     ~RR/RR_CORE/SPELLS/RR#TRNQ.EFF~  override                 // Paralytic Toxin cast secondary spell effect

COPY ~RR/RR_CORE/SPELLS/RR#TRNQ2.EFF~ override                 // Paralytic Toxin protect from secondary spell effect (for Golems, Undead...etc.)
  SAY 0x1C @88 // Unaffected by Paralytic Toxin

COPY ~RR/RR_CORE/SPELLS/RR#TRNQ.SPL~  override                 // Bounty Hunter's Paralytic Toxin innate ability (coat weapons shell)
  SAY NAME1 @55 SAY NAME2 @55 // Paralytic Toxin

COPY ~RR/RR_CORE/SPELLS/RR#TRNQ2.SPL~ override                 // Paralytic Toxin second part (the actual ability)

COPY_EXISTING ~LUABBR.2DA~            override                 // Master HLA table
  SET_2DA_ENTRY 39 1 1 ~Th3~                                   // Give Bounty Hunters a new HLA table designation
BUT_ONLY

COPY_EXISTING  ~LUTH0.2DA~           ~override/LUTH3.2DA~      // Bountu Hunter's new HLA table (spawned from default Thief)
  LPF set_lu_2da_entries STR_VAR f_Ability = GA_SPCL922 f_ExcludedBy = GA_SPCL922 END //Tracking HLA
  PRETTY_PRINT_2DA
BUT_ONLY

ACTION_IF GAME_IS ~tob bgt bg2ee~ BEGIN
  STRING_SET ~71467~ @34                                       // Tracking HLA description updated to include Bounty Hunters
END

OUTER_SPRINT desc @54
LAF set_kit_description STR_VAR kit = bounty_hunter desc END





///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Thief HLA revisions
///////////////////////////////////////////////////////////////////////

// *** For fellow modders *** this component can be detected by searching for the following file - RR#THL01.SPL


BEGIN @19 DESIGNATED 2
REQUIRE_PREDICATE ENGINE_IS ~tob bg2ee~ AND !GAME_IS ~tutu tutu_totsc bgee~ @902

LAUNCH_ACTION_MACRO ~RR#AFIX~


// Update the Thief 2DAs with RR's revised HLA versions
// Note: the default 2DA block won't execute if Refinements is installed
// In that case, the compatibility 2DA block will trigger instead

ACTION_IF NOT FILE_EXISTS_IN_GAME ~tg#mass.spl~ BEGIN          // Begin default (non-Refinements) 2DA block
  COPY_EXISTING ~LUTH0.2DA~ override
                ~LUTH1.2DA~ override
                ~LUTH2.2DA~ override
                ~LUTH3.2DA~ override
                ~LUMT0.2DA~ override
                ~LUCT0.2DA~ override
                ~LUFT0.2DA~ override
                ~LUFMT.2DA~ override                           // G3 BG2 Fixpack Fighter/Mage/Thief (triple class)
    REPLACE_TEXTUALLY ~SPCL912~ ~RR#THL04~                     // Replace Time Trap with Acid Trap
    REPLACE_TEXTUALLY ~SPCL913~ ~RR#THL02~                     // Replace (unmodded) Evasion with Danger Sense
    REPLACE_TEXTUALLY ~SPCL914~ ~RR#THL03~                     // Replace (unmodded) Greater Evasion with Evasion (RR version)
    REPLACE_TEXTUALLY ~SPCL918~ ~RR#ALCHT~                     // Replace (unmodded) Alchemy with Alchemy (RR Thief version)
    READ_2DA_ENTRY 10 1 7 RR#TSCR
    READ_2DA_ENTRY 10 7 7 RR#TUAI
    READ_2DA_ENTRY 20 1 7 RR#TSCR2
    READ_2DA_ENTRY 20 7 7 RR#TUAI2
                                                               // This patching block handles all thieves except multiclass fighter thieves
    PATCH_IF ("%RR#TSCR%" STRING_COMPARE_CASE "GA_SPCL919" = 0 AND "%RR#TUAI%" STRING_COMPARE_CASE "AP_SPCL915" = 0) BEGIN
        SET_2DA_ENTRY 10 1 7 ~GA_RR#THL01~                     // Thieves get Crippling Strike instead of Scribe Scrolls
        SET_2DA_ENTRY 10 7 7 ~GA_SPCL916~                      // Crippling Strike requires Assassination instead of UAI
    END
                                                               // This patching block handled multiclassed fighter thieves since they have a different 2DA setup
    PATCH_IF ("%RR#TSCR2%" STRING_COMPARE_CASE "GA_SPCL919" = 0 AND "%RR#TUAI2%" STRING_COMPARE_CASE "AP_SPCL915" = 0) BEGIN
        SET_2DA_ENTRY 20 1 7 ~GA_RR#THL01~                     // Thieves get Crippling Strike instead of Scribe Scrolls
        SET_2DA_ENTRY 20 7 7 ~GA_SPCL916~                      // Crippling Strike requires Assassination instead of UAI
    END
    PATCH_IF ("%SOURCE_FILE%" STRING_COMPARE_CASE "LUTH1.2DA" = 0) BEGIN
        SET_2DA_ENTRY 10 1 7 ~GA_RR#THL05~                     // Give Insightful Strike to Swashbucklers
        SET_2DA_ENTRY 10 7 7 ~*~                               // Insightful Strike has no prerequisites
    END
    PRETTY_PRINT_2DA
  BUT_ONLY
END

// Refinements 2DA compatibility block
// This code will only execute if Refinements is detected
// Therefore, this component must be installed AFTER Refinements

ACTION_IF FILE_EXISTS_IN_GAME ~tg#mass.spl~ BEGIN              // Begin Refinements compatible 2DA block
  COPY_EXISTING ~LUTH0.2DA~ override
                ~LUTH1.2DA~ override
                ~LUTH2.2DA~ override
                ~LUTH3.2DA~ override
                ~LUTH4.2DA~ override                           // Refinements Swashbuckler
                ~LUMT0.2DA~ override
                ~LUCT0.2DA~ override
                ~LUFT0.2DA~ override
                ~LUFMT.2DA~ override                           // G3 BG2 Fixpack Fighter/Mage/Thief (triple class)
    REPLACE_TEXTUALLY ~TG#EVAS~ ~RR#THL02~                     // Replace Refinements' Evasion with Danger Sense
    REPLACE_TEXTUALLY ~SPCL912~ ~RR#THL04~                     // Replace Time Trap with Acid Trap
    REPLACE_TEXTUALLY ~SPCL914~ ~RR#THL03~                     // Replace (unmodded) Greater Evasion with Evasion (RR version)
    REPLACE_TEXTUALLY ~SPCL918~ ~RR#ALCHT~                     // Replace (unmodded) Alchemy with Alchemy (RR Thief version)
    LPF set_lu_2da_entries STR_VAR f_Replace = GA_TG#CRIP f_Ability = GA_RR#THL01 f_Prereq = GA_SPCL916 END // Replace Refinements' Cripple with RR's Crippling Strike
    PATCH_IF ("%SOURCE_FILE%" STRING_COMPARE_CASE "LUTH4.2DA" = 0) BEGIN
      LPF set_lu_2da_entries STR_VAR f_Replace = GA_RR#THL01 f_Ability = GA_RR#THL05 END // Replace Crippling Strike with Insightful Strike for Swashbucklers
    END
    PRETTY_PRINT_2DA
  BUT_ONLY

  //Avoid Death requires Danger Sense, rather than Evasion
  COPY_EXISTING spcl917.spl override
    SAY 0x50 @8014
  BUT_ONLY
END

COPY ~RR/RR_CORE/BAM/RR#THL2B.BAM~    override                 // Danger Sense icon

COPY ~RR/RR_CORE/SPELLS/RR#THL02.SPL~ override                 // Danger Sense (replaces default Evasion)
  SAY NAME1 @8000 SAY NAME2 @8000
  SAY UNIDENTIFIED_DESC @8001 SAY DESC @8001

COPY ~RR/RR_CORE/BAM/RR#THL3B.BAM~    override                 // New Evasion icon

COPY ~RR/RR_CORE/SPELLS/RR#THL03.SPL~ override                 // Evasion (replaces default Greater Evasion)
  SAY UNIDENTIFIED_DESC @8003 SAY DESC @8003
  READ_LONG  0x64 "abil_off"                                   // Make Evasion display the proper "Evades effects" string
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 206) AND ("%param1%" = 14094)) BEGIN // display string: "Immunity To Effect"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @8002 // Evades Effects
      END
    END
  END
  PATCH_FOR_EACH spell IN rr#wi103 rr#wi304 rr#wi308 rr#pr302 rr#pflam rr#mligt BEGIN
    LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = RESOLVE_STR_REF (@8002) insert_point = "-1" duration = 30 STR_VAR resource = EVAL "%spell%" END
  END


COPY ~RR/RR_CORE/BAM/RR#THL1B.BAM~    override                 // Crippling Strike icon
COPY ~RR/RR_CORE/SPELLS/RR#THL01.SPL~ override                 // Crippling Strike (coat weapons shell + maximum damage effect)
  SAY NAME1 @8004 SAY NAME2 @8004
  SAY UNIDENTIFIED_DESC @8005 SAY DESC @8005

COPY ~RR/RR_CORE/SPELLS/RR#THL1A.SPL~ override                 // Crippling Strike (the actual ability)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 14042)) BEGIN           // display string: "Strength Modification"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @716  // Crippled
      END
    END
  END

COPY ~RR/RR_CORE/SPELLS/RR#THL1A.EFF~ override                 // Crippling Strike cast secondary spell EFF
     ~RR/RR_CORE/SPELLS/RR#THL1B.EFF~ override                 // Crippling Strike protect from secondary spell EFF (for Golems, Undead...etc.)
     ~RR/RR_CORE/BAM/RR#THL4B.BAM~    override                 // Acid Trap icon
     ~RR/RR_CORE/BAM/RR#TRPAC.BAM~    override                 // Acid Trap ground effect BAM
     ~RR/RR_CORE/VVC/RR#TRPAC.VVC~    override                 // Acid Trap VVC #1 (ground effect animation)
     ~RR/RR_CORE/VVC/RR#THL04.VVC~    override                 // Acid Trap VVC #2 (acid blob animation)

COPY ~RR/RR_CORE/SPELLS/RR#THL04.SPL~ override                 // Acid Trap (casting shell)
  SAY NAME1 @8010 SAY NAME2 @8010
  SAY UNIDENTIFIED_DESC @8011 SAY DESC @8011

ADD_PROJECTILE ~RR/RR_CORE/PRO/RR#THL4B.PRO~                   // Acid Trap projectile

COPY ~RR/RR_CORE/SPELLS/RR#THL4B.SPL~ override                 // Acid Trap (the actual ability)
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) "%RR#THL4B%"              // use new projectile
  END

COPY ~RR/RR_CORE/SPELLS/RR#THL4B.EFF~ override                 // Acid Trap no save against secondary effect (used via EFF targeting for Trolls)

COPY ~RR/RR_CORE/BAM/RR#THL5B.BAM~    override                 // Insightful Strike icon

COPY ~RR/RR_CORE/SPELLS/RR#THL05.SPL~ override                 // Insightful Strike (replaces Crippling Strike for Swashbucklers)
  SAY NAME1 @8012 SAY NAME2 @8012
  SAY UNIDENTIFIED_DESC @8013 SAY DESC @8013

COPY ~RR/RR_STIM/ITEMS/RR#INV.ITM~    override                 // Invulnerability item for cutscene creatures
     ~RR/RR_CORE/ACTORS/RR#ALCH.CRE~  override                 // Alchemy invisible creature (used for initiating the dialogue)
     ~RR/RR_CORE/SPELLS/RR#ALCH.EFF~  override                 // Alchemy invisible creature summoning EFF

COMPILE ~RR/RR_CORE/COMPILE/RR#ALCH.D~                         // Alchemy invisible creature dialogue file (used for choosing potions)
        ~RR/RR_CORE/COMPILE/RR#ALCH.BAF~                       // Alchemy invisible creature AI script (used for initiating the dialogue)

COPY ~RR/RR_CORE/SPELLS/RR#ALCHT.SPL~ override                 // Alchemy (Thief version)
  SAY UNIDENTIFIED_DESC @8100 SAY DESC @8100


// Set Exploding Trap HLA

COPY ~rr/rr_core/bam/rr#trpex.bam~    override                 // Exploding Trap ground effect BAM
     ~rr/rr_core/vvc/rr#trpex.vvc~    override                 // Exploding Trap VVC (ground effect animation)
     ~rr/rr_core/spells/rr#thl6a.eff~ override                 // Set Exploding Trap EFF1 (immunity to pushback, for dragons, golems and such)
     ~rr/rr_core/spells/rr#thl6b.eff~ override                 // Set Exploding Trap EFF2 (immunity to knock down, for dragons, golems and such)

ADD_PROJECTILE ~rr/rr_core/pro/rr#trpex.pro~                   // Exploding Trap projectile

COPY ~rr/rr_core/spells/rr#thl06.spl~ override                 // Set Exploding Trap (secondary SPL)
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) "%rr#trpex%"              // use new projectile
  END

COPY_EXISTING ~spcl911.spl~ override                           // Set Exploding Trap (primary SPL)
  SAY UNIDENTIFIED_DESC @8016 SAY DESC @8016                   // updated description
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
     READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
     READ_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "resref"
      PATCH_IF (("%opcode%" = 252) AND ("%resref%" STRING_EQUAL_CASE ~SPCL911B~)) BEGIN  // effect #252: Set Trap
       WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "RR#THL06" #8 // use RR's revised Exploding Trap
      END
      PATCH_IF (("%opcode%" = 215) AND ("%resref%" STRING_EQUAL_CASE ~SPSETSCD~)) BEGIN  // effect #215: Play 3D Effect
       WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "RR#TRPEX" #8 // use RR's Exploding Trap VVC animation
      END
    END
  END
BUT_ONLY


// Set Spike Trap HLA
ACTION_IF FILE_EXISTS_IN_GAME spcl910.spl BEGIN
  COPY_EXISTING ~spcl910.spl~ override                         // Set Spike Trap (primary SPL)
    SAY UNIDENTIFIED_DESC @8017 SAY DESC @8017
  BUT_ONLY

  COPY_EXISTING ~spcl910b.spl~ override                        // Set Spike Trap (secondary SPL)
    READ_LONG  0x64 "abil_off"
    READ_SHORT 0x68 "abil_num"
    READ_LONG  0x6a "fx_off"
    FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
      READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
      READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
      FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
       READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
       READ_LONG  ("%fx_off%" + 0x08 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param2"
        PATCH_IF (("%opcode%" = 12) AND ("%param2%" = 4194304)) BEGIN  // effect #12: HP Damage, type - magical
         WRITE_LONG ("%fx_off%" + 0x08 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) 1048576 // change damage type to piercing
        END
      END
    END
    WRITE_LONG 0x34 1                                          // Set the spell level to 1
  BUT_ONLY
END






///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Proper racial adjustments for thieving skills
///////////////////////////////////////////////////////////////////////

// *** For fellow modders *** this component can be detected by searching for the following file - RR#PPTSK.RR

BEGIN @17 DESIGNATED 3
REQUIRE_PREDICATE ENGINE_IS ~bg2 tob bgee bg2ee~ @902

COPY_EXISTING ~sw1h01.itm~ ~override/RR#PPTSK.RR~

COPY_EXISTING ~SKILLRAC.2DA~ override
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 0 6 ~10~ // Human Detect Illusion correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 1 6 ~15~ // Dwarf Detect Illusion correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 2 6 ~10~ // Elf Detect Illusion correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 3 6 ~20~ // Gnome Detect Illusion correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 4 6 ~15~ // Half-Elf Detect Illusion correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 5 6 ~10~ // Halfling Detect Illusion correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 6 6 ~5~  // Half-Orc Detect Illusion correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 2 4 ~15~ // Elf Move Silently correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 4 4 ~10~ // Half-Elf Move Silently correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 5 4 ~20~ // Halfling Move Silently correction
  SET_2DA_ENTRY_LATER ~RR#SKILLRAC~ 6 3 ~10~ // Half-Orc Find Traps correction
  SET_2DA_ENTRIES_NOW ~RR#SKILLRAC~ 8
  PRETTY_PRINT_2DA
BUT_ONLY



///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Bard kit revisions
///////////////////////////////////////////////////////////////////////

// *** For fellow modders *** this component can be detected by searching for the following file - RR#BDF01.SPL


BEGIN @3 DESIGNATED 4
REQUIRE_PREDICATE ENGINE_IS ~tob bgee bg2ee~ @902

LAUNCH_ACTION_MACRO ~RR#AFIX~

// True Bard

COPY_EXISTING ~CLABBA01.2DA~ override                         // True Bard ability table
  SET_2DA_ENTRY 3 1 3 ~AP_RR#BDF01~                           // Assign the new song to the True Bard
  PRETTY_PRINT_2DA
BUT_ONLY

COPY ~RR/RR_CORE/SPELLS/RR#BDF01.SPL~ override                // True Bard new song part 1
     ~RR/RR_CORE/SPELLS/RR#BDF02.SPL~ override                // True Bard new song part 2

//String remains #9562 in BGEE
STRING_SET ~9562~ @29                                         // Updated True Bard kit description


// Blade kit revision


COPY_EXISTING ~WEAPPROF.2DA~ override
  SET_2DA_ENTRY 34 42 1 ~0~                                   // Prevent Blades from assigning any proficiency points in TWS at the character creation screen
  PRETTY_PRINT_2DA
BUT_ONLY

COPY ~RR/RR_CORE/SPELLS/RR#BBLIT.SPL~ override                // New innate traits for the Blade kit

COPY_EXISTING ~CLABBA02.2DA~ override                         // Blade kit ability table
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 1  f_MaxLevel = 1 STR_VAR f_Entry = GA_RR#WDIS END // Assign the Weapons Display ability at level 1
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 10 f_Increment = 10 STR_VAR f_Entry = GA_RR#WDIS END // Assign the Weapons Display ability
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 1  f_MaxLevel = 1 STR_VAR f_Entry = AP_RR#BBL01 END // Grant the Blade his own version of the Bard song
  LPF set_clab_2da_entries INT_VAR f_MinLevel = 1  f_MaxLevel = 1 STR_VAR f_Entry = AP_RR#BBLIT END // Grant the Blade 3 points in TWF
  PRETTY_PRINT_2DA
BUT_ONLY

COPY ~RR/RR_CORE/SPELLS/RR#BBL01.SPL~ override                // Blade new song part 1
     ~RR/RR_CORE/SPELLS/RR#BBL02.SPL~ override                // Blade new song part 2
     ~RR/RR_CORE/BAM/RR#WDIS.BAM~     override                // Weapons Display icon

COPY ~RR/RR_CORE/SPELLS/RR#WDIS.EFF~  override                // Weapons Display immunity (prevents Undead, Demons, Golems... from being affected)
  SAY 0x1C @84 // Unaffected by the Weapons Display

COPY ~RR/RR_CORE/SPELLS/RR#WDIS.SPL~  override                // Weapons Display ability
  SAY NAME1 @31 SAY NAME2 @31                                 // Weapons Display
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
       PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 14094)) BEGIN             // display string: "Immunity To Effect"
        SAY  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @85  // Weapons Display failed: target has too many hit dice
       END
    END
  END

OUTER_SPRINT desc @30
LAF set_kit_description STR_VAR kit = blade desc END



// Skald kit revision

COPY ~RR/RR_CORE/SPELLS/RR#BSKIT.SPL~ override                // New innate traits for the Skald kit

COPY_EXISTING ~CLABBA04.2DA~ override                         // Skald kit ability table
  SET "rr#once" = "0"
  COUNT_2DA_ROWS ~5~ "rows"
  FOR ( index = 0 ; index < rows ; index = index + 1 ) BEGIN
    READ_2DA_ENTRY "index" 1 5 "2datmp"
     PATCH_IF (("%2datmp%" STRING_EQUAL_CASE ~****~) AND ("rr#once" = "0")) BEGIN    // find the first free entry in the first row
       SET_2DA_ENTRY "index" 1 5 ~AP_RR#BSKIT~                                       // assign the file which grants the Skald his innate traits
       SET "rr#once" = "1"
     END
  END
  PRETTY_PRINT_2DA
BUT_ONLY

COPY_EXISTING ~SPCL542.SPL~ override                          // Skald song change
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
        PATCH_IF ("%opcode%" = 251) BEGIN // effect #251: Change Bard Song
          WRITE_BYTE  ("%fx_off%" + 0x02 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) 1             // target: self
          WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "RR#BSK00" #8 // song change
        END
    END
  END
BUT_ONLY

COPY ~RR/RR_CORE/SPELLS/RR#BSK00.SPL~ override                // Revised Skald song

OUTER_SPRINT desc @33
LAF set_kit_description STR_VAR kit = skald desc END



// Jester kit revision

COPY ~RR/RR_CORE/SPELLS/RR#BJSIT.SPL~ override                // New innate traits for the Jester kit

COPY_EXISTING ~CLABBA03.2DA~ override                         // Jester kit ability table
  SET "rr#once" = "0"
  COUNT_2DA_ROWS ~5~ "rows"
  FOR ( index = 0 ; index < rows ; index = index + 1 ) BEGIN
    READ_2DA_ENTRY "index" 1 5 "2datmp"
    PATCH_IF (("%2datmp%" STRING_EQUAL_CASE ~****~) AND ("rr#once" = "0")) BEGIN    // find the first free entry in the first row
      SET_2DA_ENTRY "index" 1 5 ~AP_RR#BJSIT~                                       // assign the file which grants the Jester his innate traits
      SET "rr#once" = "1"
    END
  END
  PRETTY_PRINT_2DA
BUT_ONLY

COPY_EXISTING ~SPCL751.SPL~ override                          // Jester song change
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF ("%opcode%" = 251) BEGIN // effect #251: Change Bard Song
        WRITE_BYTE  ("%fx_off%" + 0x02 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) 1             // target: self
        WRITE_ASCII ("%fx_off%" + 0x14 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "RR#BJS00" #8 // song change
      END
    END
  END
BUT_ONLY

COPY ~RR/RR_CORE/SPELLS/RR#BJS00.SPL~ override                // Revised Jester song
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 17424)) BEGIN // display string: "Bad Luck"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @81 // Distracted
      END
    END
  END

LAM load_RR#FSCNT_var

COPY ~RR/RR_CORE/SPELLS/RR#BJS10.SPL~ override                // Revised Jester song part 2 (a Feeblemind spell used for the Mesmerize effect)
  WRITE_BYTE 0x27 RR#FSCNT                                    // assign new secondary type for Mesmerize effects
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 23744)) BEGIN // display string: "Feebleminded"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @91 // Mesmerized
      END
    END
  END



COPY_EXISTING ~ALIGNMNT.2DA~ override                          // disallow all non-chaotic alignments for Jesters
  SET_2DA_ENTRY_LATER ~RR#BALIGN~ 42 1 ~0~                     // dissallow Lawful Good alignment for Jesters
  SET_2DA_ENTRY_LATER ~RR#BALIGN~ 42 2 ~0~                     // dissallow Lawful Neutral alignment for Jesters
  SET_2DA_ENTRY_LATER ~RR#BALIGN~ 42 3 ~0~                     // dissallow Lawful Evil alignment for Jesters
  SET_2DA_ENTRY_LATER ~RR#BALIGN~ 42 4 ~0~                     // dissallow Neutral Good alignment for Jesters
  SET_2DA_ENTRY_LATER ~RR#BALIGN~ 42 5 ~0~                     // dissallow True Neutral alignment for Jesters
  SET_2DA_ENTRY_LATER ~RR#BALIGN~ 42 6 ~0~                     // dissallow Neutral Evil alignment for Jesters
  SET_2DA_ENTRY_LATER ~RR#BALIGN~ 42 7 ~1~                     // allow Chaotic Good alignment for Jesters
  SET_2DA_ENTRY_LATER ~RR#BALIGN~ 42 9 ~1~                     // allow Chaotic Evil alignment for Jesters
  SET_2DA_ENTRIES_NOW ~RR#BALIGN~ 1
  PRETTY_PRINT_2DA
BUT_ONLY

COPY_EXISTING ~WEAPPROF.2DA~ override                          // Restrict Jester's proficiency selection to that of a Thief
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 11 43 ~0~                     // Disallow Bastard Sword proficiency
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 14 43 ~0~                     // Disallow Axe proficiency
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 15 43 ~0~                     // Disallow Two Handed Sword proficiency
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 19 43 ~0~                     // Disallow Warhammer proficiency
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 21 43 ~0~                     // Disallow Spear proficiency
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 22 43 ~0~                     // Disallow Halbard proficiency
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 23 43 ~0~                     // Disallow Flail proficiency
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 24 43 ~0~                     // Disallow Mace proficiency
  SET_2DA_ENTRY_LATER ~RR#BSKWR~ 27 43 ~0~                     // Disallow Longbow proficiency
  SET_2DA_ENTRIES_NOW ~RR#BSKWR~ 1
  PRETTY_PRINT_2DA
BUT_ONLY

// Jester song protection EFF (used for mindless creatures such as Golems, Skeletons and Zombies)

COPY ~RR/RR_CORE/SPELLS/RR#BJS00.EFF~ override                 // Jester song immunity EFF
  SAY 0x1C @82 // Unaffected by the Jester's song
BUT_ONLY

OUTER_SPRINT desc @32
LAF set_kit_description STR_VAR kit = jester desc END



// Assign the new party-only projectile (RR#VRPO.PRO) to various Bard songs

LAM load_RR#VRPO_var

COPY_EXISTING ~RR#BSK00.SPL~ override // Skald's regular song
              ~RR#BDF02.SPL~ override // True Bard's regular song
              ~RR#BBL02.SPL~ override // Blade's regular song
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) RR#VRPO
  END
BUT_ONLY

// Assign the new no-party projectile (RR#VRNP.PRO) to the regular Jester song and the Weapons Display ability

LAM load_RR#VRNP_var

COPY_EXISTING ~RR#BJS00.SPL~ override // Jester's regular song
              ~RR#WDIS.SPL~  override // Blade's Weapon's display ability
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) RR#VRNP
  END
BUT_ONLY


// Prevent Enhanced Bard Song from reverting back to the default version after leaving and rejoining the party
// Note: this code is here in case someone installs RR's Bard kit revisions but doesn't want to install RR's Bard HLA Revisions

ACTION_IF FILE_EXISTS_IN_GAME spcl920.spl BEGIN
  COPY_EXISTING ~spcl920.spl~ override     // Enhanced Bard Song
    PATCH_FOR_EACH resource IN
                   RR#BDF01                  // True Bard song (Rogue Rebalancing)
                   RR#BBL01                  // Blade song (Rogue Rebalancing)
    BEGIN
      LPF ADD_SPELL_EFFECT
        INT_VAR
          opcode = 206                       // effect: #206 (Protection from Spell)
          target = 2                         // target: 2 (pre-target)
          timing = 9                         // timing mode: 9 (permanent after death)
          insert_point = "-1"                // Add them as the last effects
        STR_VAR
          resource
      END
    END
  BUT_ONLY
END



///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Bard HLA revisions
///////////////////////////////////////////////////////////////////////

// *** For fellow modders *** this component can be detected by searching for the following file - RR#BHL01.SPL


BEGIN @4 DESIGNATED 5
REQUIRE_PREDICATE ENGINE_IS ~tob bg2ee~ AND !GAME_IS ~tutu tutu_totsc bgee~ @902

LAUNCH_ACTION_MACRO ~RR#AFIX~

INCLUDE "rr/lib/ds.tpa"                                              // Detectable Spells


// Update the Bard 2DAs with RR's revised HLA versions
// Note: the default 2DA block won't execute if Refinements is installed
// In that case, the compatibility 2DA block will trigger instead

ACTION_IF NOT FILE_EXISTS_IN_GAME ~tg#mass.spl~ BEGIN                // Begin default (non-Refinements) 2DA block
COPY_EXISTING ~LUBA0.2DA~ override
  REPLACE_TEXTUALLY ~SPCL913~ ~RR#BHL05~                             // Replace Evasion with Resonating Weapon for all Bards
  REPLACE_TEXTUALLY ~SPCL914~ ~RR#BHL06~                             // Replace Greater Evasion with Sound Barrier for all Bards
  REPLACE_TEXTUALLY ~SPCL918~ ~RR#ALCHB~                             // Replace (unmodded) Alchemy with Alchemy (RR Bard version)
  REPLACE_TEXTUALLY ~SPCL921~ ~RR#BHL07~                             // Replace Magic Flute with the revised RR version for all Bards
  COUNT_2DA_ROWS ~9~ "rows"
  FOR ( index = 0 ; index < rows ; index = index + 1 ) BEGIN
    READ_2DA_ENTRY "index" 1 9 "rr#2datm"
    PATCH_IF ("%rr#2datm%" STRING_EQUAL_CASE ~GA_SPCL919~) BEGIN     // Find the Scribe Scrolls entry
      SET_2DA_ENTRY "index" 1 9 "GA_RR#SCRL"                         // Replace (unmodded) Scribe Scrolls with Scribe Scrolls (RR version)
      SET_2DA_ENTRY "index" 6 9 "1"                                  // Number of times allowed to pick the HLA
    END
  END
  PRETTY_PRINT_2DA
BUT_ONLY

// Spawn unique Bard HLA tables for all kits
COPY_EXISTING ~LUBA0.2DA~ ~override/LUBA2.2DA~                       // Blade's new HLA Table (spawned from True Bard)
              ~LUBA0.2DA~ ~override/LUBA3.2DA~                       // Jester's new HLA Table (spawned from True Bard)
              ~LUBA0.2DA~ ~override/LUBA4.2DA~                       // Skald's new HLA Table (spawned from True Bard)

// Master HLA table changes
COPY_EXISTING ~LUABBR.2DA~ override                                  // Master HLA table
  SET_2DA_ENTRY  7 1 1 ~Ba0~                                         // Give the True Bard a new HLA table designation
  SET_2DA_ENTRY 41 1 1 ~Ba2~                                         // Give the Blade a new HLA table designation
  SET_2DA_ENTRY 42 1 1 ~Ba3~                                         // Give the Jester a new HLA table designation
  SET_2DA_ENTRY 43 1 1 ~Ba4~                                         // Give the Skald a new HLA table designation
BUT_ONLY

// Blade kit HLA table

COPY_EXISTING ~LUBA2.2DA~ override                                   // Blade's new HLA Table (spawned from True Bard)
  SET_2DA_ENTRY_LATER ~RR#LUBA2~ 3  1 ~GA_RR#BHL01~                  // Replace Spike Trap with Mass Charm
  SET_2DA_ENTRY_LATER ~RR#LUBA2~ 4  1 ~GA_RR#BHL02~                  // Replace Exploding Trap with Enthralling Melody
  SET_2DA_ENTRY_LATER ~RR#LUBA2~ 5  1 ~GA_RR#BHL03~                  // Replace Time Trap with Sound Burst
  SET_2DA_ENTRY_LATER ~RR#LUBA2~ 12 1 ~GA_SPCL900~                   // Replace Enhanced Song with Whirlwind
  SET_2DA_ENTRY_LATER ~RR#LUBA2~ 12 6 ~16~                           // Number of times that Whirlwind can be acquired
  SET_2DA_ENTRIES_NOW ~RR#LUBA2~ 1
BUT_ONLY

// Jester kit HLA table

COPY_EXISTING ~LUBA3.2DA~ override                                   // Jester's new HLA Table (spawned from True Bard)
  SET_2DA_ENTRY_LATER ~RR#LUBA3~ 3  1 ~GA_RR#BHL01~                  // Replace Spike Trap with Mass Charm
  SET_2DA_ENTRY_LATER ~RR#LUBA3~ 4  1 ~GA_RR#BHL02~                  // Replace Exploding Trap with Enthralling Melody
  SET_2DA_ENTRY_LATER ~RR#LUBA3~ 5  1 ~GA_RR#BHL03~                  // Replace Time Trap with Sound Burst
  SET_2DA_ENTRY_LATER ~RR#LUBA3~ 12 1 ~AP_RR#BJS01~                  // Jester's Enhanced Song HLA
  SET_2DA_ENTRIES_NOW ~RR#LUBA3~ 1
  LPF set_lu_2da_entries STR_VAR f_Ability = AP_RR#BJS03 f_Prereq = AP_RR#BJS01 f_ExcludedBy = AP_RR#BJS03 END // Jester's Lingering Song HLA
  PRETTY_PRINT_2DA
BUT_ONLY

// Skald kit HLA table

COPY_EXISTING ~LUBA4.2DA~ override                                   // Skald's new HLA Table (spawned from True Bard)
  SET_2DA_ENTRY_LATER ~RR#LUBA4~ 3  1 ~GA_RR#BHL01~                  // Replace Spike Trap with Mass Charm
  SET_2DA_ENTRY_LATER ~RR#LUBA4~ 4  1 ~GA_RR#BHL02~                  // Replace Exploding Trap with Enthralling Melody
  SET_2DA_ENTRY_LATER ~RR#LUBA4~ 5  1 ~GA_RR#BHL03~                  // Replace Time Trap with Sound Burst
  SET_2DA_ENTRY_LATER ~RR#LUBA4~ 12 1 ~AP_RR#BSK01~                  // Skald's Enhanced Song HLA
  SET_2DA_ENTRIES_NOW ~RR#LUBA4~ 1
  LPF set_lu_2da_entries STR_VAR f_Ability = AP_RR#BSK03 f_Prereq = AP_RR#BSK01 f_ExcludedBy = AP_RR#BSK03 END // Skald's Lingering Song HLA
  PRETTY_PRINT_2DA
BUT_ONLY

// True Bard HLA table  (needs to be processed last due to spawning)

COPY_EXISTING ~LUBA0.2DA~ override                                   // True Bard's new HLA Table
  SET_2DA_ENTRY_LATER ~RR#LUBA0~ 3  1 ~GA_RR#BHL01~                  // Replace Spike Trap with Mass Charm
  SET_2DA_ENTRY_LATER ~RR#LUBA0~ 4  1 ~GA_RR#BHL02~                  // Replace Exploding Trap with Enthralling Melody
  SET_2DA_ENTRY_LATER ~RR#LUBA0~ 5  1 ~GA_RR#BHL03~                  // Replace Time Trap with Sound Burst
  SET_2DA_ENTRY_LATER ~RR#LUBA0~ 12 1 ~AP_RR#BDF03~                  // True Bard's Enhanced Song HLA
  SET_2DA_ENTRIES_NOW ~RR#LUBA0~ 1
  LPF set_lu_2da_entries STR_VAR f_Ability = AP_RR#BDF05 f_Prereq = AP_RR#BDF03 f_ExcludedBy = AP_RR#BDF05 END // True Bard's Lingering Song HLA
  PRETTY_PRINT_2DA
BUT_ONLY

END                                                                  // ends normal (non-Refinements) 2DA block


// Refinements 2DA compatibility block
// This code will only execute if Refinements is detected
// Therefore, this component must be installed AFTER Refinements

ACTION_IF FILE_EXISTS_IN_GAME ~tg#mass.spl~ BEGIN                   // Begin Refinements compatible 2DA block
COPY_EXISTING ~LUBA0.2DA~ override                                  // True Bard HLA table
              ~LUBA2.2DA~ override                                  // Blade HLA table
              ~LUBA3.2DA~ override                                  // Jester HLA table
              ~LUBA4.2DA~ override                                  // Skald HLA table
  REPLACE_TEXTUALLY ~TG#MASS~ ~RR#BHL01~                            // Replace Refinements' Mass Charm with the more recent RR version
  REPLACE_TEXTUALLY ~TG#ENTH~ ~RR#BHL02~                            // Replace Refinements' Enthralling Melody with the more recent RR version
  REPLACE_TEXTUALLY ~TG#SOUN~ ~RR#BHL03~                            // Replace Refinements' Sound Burst with the more recent RR version
  REPLACE_TEXTUALLY ~LI#EN01~ ~RR#BDF03~                            // Replace Refinements' Enhanced Bard Song with the more recent RR version
  REPLACE_TEXTUALLY ~TG#LI01~ ~RR#BDF05~                            // Replace Refinements' Lingering Bard Song with the more recent RR version
  REPLACE_TEXTUALLY ~TG#BFLU~ ~RR#BHL07~                            // Replace Refinements' Magic Flute with the RR version
  REPLACE_TEXTUALLY ~TG#BFL2~ ~RR#BHL07~                            // Replace Refinements' Skald Magic Flute with the RR version
  REPLACE_TEXTUALLY ~TG#EVAS~ ~RR#BHL05~                            // Replace Refinements' Evasion with RR's Resonating Weapon
  REPLACE_TEXTUALLY ~SPCL917~ ~RR#BHL06~                            // Replace Refinements' Avoid Death with RR's Sound Barrier (to be restored later)
  REPLACE_TEXTUALLY ~SPCL918~ ~RR#ALCHB~                            // Replace (unmodded) Alchemy with Alchemy (RR Bard version)
  REPLACE_TEXTUALLY ~TG#EN02~ ~RR#BJS01~                            // Replace Refinements' Enhanced Jester Song with the more recent RR version
  REPLACE_TEXTUALLY ~TG#LI02~ ~RR#BJS03~                            // Replace Refinements' Lingering Jester Song with the more recent RR version
  REPLACE_TEXTUALLY ~TG#EN03~ ~RR#BSK01~                            // Replace Refinements' Enhanced Skald Song with the more recent RR version
  REPLACE_TEXTUALLY ~TG#LI03~ ~RR#BSK03~                            // Replace Refinements' Lingering Skald Song with the more recent RR version
  COUNT_2DA_ROWS ~9~ "rows"
  FOR ( index = 0 ; index < rows ; index = index + 1 ) BEGIN
    READ_2DA_ENTRY "index" 1 9 "rr#2datm"
     PATCH_IF ("%rr#2datm%" STRING_EQUAL_CASE ~GA_TG#SCRB~) BEGIN   // Find the Scribe Scrolls entry
       SET_2DA_ENTRY "index" 1 9 "GA_RR#SCRL"                       // Replace Refinements' Scribe Scrolls with RR's Scribe Scrolls
       SET_2DA_ENTRY "index" 6 9 "1"                                // Number of times allowed to pick the HLA
     END
  END
  PRETTY_PRINT_2DA
BUT_ONLY

//Give Blades the Whirlwind Attack HLA
COPY_EXISTING luba2.2da override
  LPF set_lu_2da_entries STR_VAR f_Ability = GA_SPCL900 END
BUT_ONLY

//Remove mention of a dependency on Evasion from Avoid Death. Thieves still need to pick Evasion if RR's thief HLAs are also installed
COPY_EXISTING spcl917.spl "override/fl#cl917.spl"
  SAY 0x50 @8015
BUT_ONLY

// Restore the Avoid Death HLA to Bards (only needed with Refinements)
COPY_EXISTING ~LUBA0.2DA~ override                                  // True Bard HLA table
              ~LUBA2.2DA~ override                                  // Blade HLA table
              ~LUBA3.2DA~ override                                  // Jester HLA table
              ~LUBA4.2DA~ override                                  // Skald HLA table
  LPF set_lu_2da_entries STR_VAR f_Ability = GA_fl#cl917 END        // Aviod Death HLA
BUT_ONLY

END                                                                 // ends Refinements compatible 2DA block


// Enhanced HLA songs

COPY ~RR/RR_CORE/SPELLS/RR#BDF03.SPL~ override                      // True Bard's Enhanced Song part 1
  SAY NAME1 @47 SAY NAME2 @47 SAY UNIDENTIFIED_DESC @48 SAY DESC @48

COPY ~RR/RR_CORE/SPELLS/RR#BDF04.SPL~ override                      // True Bard's Enhanced Song part 2

COPY ~RR/RR_CORE/SPELLS/RR#BSK01.SPL~ override                      // Skald's Enhanced Song part 1
  SAY NAME1 @49 SAY NAME2 @49 SAY UNIDENTIFIED_DESC @50 SAY DESC @50

COPY ~RR/RR_CORE/SPELLS/RR#BSK02.SPL~ override                      // Skald's Enhanced Song part 2

COPY ~RR/RR_CORE/SPELLS/RR#BJS01.SPL~ override                      // Jester's Enhanced Song part 1
  SAY NAME1 @51 SAY NAME2 @51 SAY UNIDENTIFIED_DESC @52 SAY DESC @52

COPY ~RR/RR_CORE/SPELLS/RR#BJS02.SPL~ override                      // Jester's Enhanced Song part 2
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 17424)) BEGIN // display string: "Bad Luck"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @81 // Distracted
      END
    END
  END



// Lingering songs

COPY ~RR/RR_CORE/BAM/RR#BHL4B.BAM~    override                      // Lingering Song icon

COPY ~RR/RR_CORE/SPELLS/RR#BDF05.SPL~ override                      // True Bard's Lingering Song part 1
  SAY NAME1 @67 SAY NAME2 @67 SAY UNIDENTIFIED_DESC @68 SAY DESC @68

COPY ~RR/RR_CORE/SPELLS/RR#BDF06.SPL~ override                      // True Bard's Lingering Song part 2

COPY ~RR/RR_CORE/SPELLS/RR#BSK03.SPL~ override                      // Skald's Lingering Song part 1
  SAY NAME1 @67 SAY NAME2 @67 SAY UNIDENTIFIED_DESC @68 SAY DESC @68

COPY ~RR/RR_CORE/SPELLS/RR#BSK04.SPL~ override                      // Skald's Lingering Song part 2

COPY ~RR/RR_CORE/SPELLS/RR#BJS03.SPL~ override                      // Jester's Lingering Song part 1
  SAY NAME1 @67 SAY NAME2 @67 SAY UNIDENTIFIED_DESC @68 SAY DESC @68

COPY ~RR/RR_CORE/SPELLS/RR#BJS04.SPL~ override                      // Jester's Lingering Song part 2
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 17424)) BEGIN // display string: "Bad Luck"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @81 // Distracted
      END
    END
  END

LAM load_RR#FSCNT_var

COPY ~RR/RR_CORE/SPELLS/RR#BJS11.SPL~ override                      // Jester's Lingering song part 3 (a Feeblemind spell used for the Mesmerize effect)
  WRITE_BYTE 0x27 RR#FSCNT                                          // assign new secondary type for Mesmerize effects
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 23744)) BEGIN // display string: "Feebleminded"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @91 // Mesmerized
      END
    END
  END


// Jester song protection EFF (used for mindless creatures such as Golems, Skeletons, Slimes and Zombies)

COPY ~RR/RR_CORE/SPELLS/RR#BJS02.EFF~ override                      // Jester's Enhanced song immunity EFF
     ~RR/RR_CORE/SPELLS/RR#BJS04.EFF~ override                      // Jester's Lingering song immunity EFF
  SAY 0x1C @82 // Unaffected by the Jester's song



// New Bard HLAs (trap and evasion replacements)

// Mass Charm

COPY ~RR/RR_CORE/SPELLS/RR#BHL01.EFF~ override                      // Prevents Demons, Dragons, Constructs and Undead from being affected by Mass Charm
     ~RR/RR_CORE/BAM/RR#BHL1B.BAM~    override                      // Mass Charm icon

COPY ~RR/RR_CORE/SPELLS/RR#BHL01.SPL~ override                      // Mass Charm spell file
  SAY NAME1 @40 SAY NAME2 @40 SAY UNIDENTIFIED_DESC @41 SAY DESC @41


// Enthralling Melody

LAM load_RR#FSCNT_var

COPY ~RR/RR_CORE/SPELLS/RR#BHL02.EFF~ override                      // Prevents Demons, Dragons, Constructs and Undead from being affected by Enthralling Melody
     ~RR/RR_CORE/BAM/RR#BHL2B.BAM~    override                      // Enthralling Melody icon

COPY ~RR/RR_CORE/SPELLS/RR#BHL02.SPL~ override                      // Enthralling Melody spell file
  SAY NAME1 @42 SAY NAME2 @42 SAY UNIDENTIFIED_DESC @43 SAY DESC @43
  WRITE_BYTE 0x27 RR#FSCNT                                          // assign new secondary type for Fascinate effects
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 23744)) BEGIN // display string: "Feebleminded"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @93 // Fascinated
      END
    END
  END



// Sound Burst

COPY ~RR/RR_CORE/BAM/RR#BHL3B.BAM~    override                      // Sound Burst icon

COPY ~RR/RR_CORE/SPELLS/RR#BHL03.SPL~ override                      // Sound Burst spell file
  SAY NAME1 @44 SAY NAME2 @44 SAY UNIDENTIFIED_DESC @45 SAY DESC @45


// Magic Flute

COPY ~RR/RR_CORE/SPELLS/RR#BHL07.SPL~ override                      // Revised Magic Flute HLA
  SAY UNIDENTIFIED_DESC @46 SAY DESC @46                            // Updated description for the Magic Flute HLA

COPY ~RR/RR_CORE/2DA/RR#BFEN.2DA~     override                      // A 2DA file containing a list of all arcane Enchantment spells (Mimic Enchantment)

COPY ~RR/RR_CORE/ITEMS/RR#FLUTE.ITM~  override                      // Revised Magic Flute item
  SAY UNIDENTIFIED_DESC @79 SAY DESC @79                            // Updated Magic Flute description

COPY ~RR/RR_CORE/SPELLS/RR#BHL07.EFF~ override                      // Revised Magic Flute EFF file (changes number of charges per ability to 3, 2, 1)
     ~RR/RR_CORE/ACTORS/RR#WSPI.CRE~  override                      // Spirit Warrior CRE
     ~RR/RR_CORE/SPELLS/RR#WSPI.EFF~  override                      // Spirit Warrior summoning EFF

COPY ~RR/RR_CORE/SPELLS/RR#WSIC.SPL~  override                      // Spirit Warrior's Aura of Courage ability
  SAY NAME1 @70 SAY NAME2 @70
  SAY UNIDENTIFIED_DESC @70 SAY DESC @70 // Aura of Courage

COPY ~RR/RR_CORE/SPELLS/RR#WSSK.SPL~  override                      // Spirit Warrior's power up ability (used when summoned by a Skald)
     ~RR/RR_CORE/ITEMS/RR#WSAX1.ITM~  override                      // Spirit Warrior's primary axe (with on hit effects)

COPY ~RR/RR_CORE/ITEMS/RR#WSAX2.ITM~  override                      // Spirit Warrior's secondary axe (with proper spectral undead immunities)
  LAUNCH_PATCH_FUNCTION ~cure_spell_immunities~ END                 // add immunity to cure/cause wound spells

COPY ~RR/RR_CORE/BAM/RR#BF01.BAM~     override                      // Bard Flute's Break Enchantment spell icon
     ~RR/RR_CORE/BAM/RR#BF02.BAM~     override                      // Bard Flute's Mimic Enchantment spell icon
     ~RR/RR_CORE/BAM/RR#BF03.BAM~     override                      // Bard Flute's Summon Spirit Warrior icon

COMPILE ~RR/RR_CORE/COMPILE/RR#WSPI.BAF~                            // Spirit Warrior's AI script

APPEND  ~TOOLTIP.2DA~ ~RR#FLUTE	RR#BF001 RR#BF002 RR#BF003~         // Set temporary tooltip values so that they can be replaced with custom strings later

COPY_EXISTING ~TOOLTIP.2DA~           override                      // Replace temporary values with proper strings
  REPLACE ~RR#BF001~ @76                                            // Break Enchantment
  REPLACE ~RR#BF002~ @77                                            // Mimic Enchantment
  REPLACE ~RR#BF003~ @78                                            // Summon Spirit Warrior
  PRETTY_PRINT_2DA
BUT_ONLY

// Assign the Enchantment school to enchantment based spell-like abilities so that the Magic Flute can dispel them

COPY_EXISTING ~SPPR982.SPL~           override                      // Trap Dire Charm
              ~SPPR983.SPL~           override                      // Trap Confusion
              ~SPPR989.SPL~           override                      // Trap Hold Person
              ~SPWI929.SPL~           override                      // Succubus Charm Female
              ~SPWI930.SPL~           override                      // Succubus Charm Male
              ~SPWI943.SPL~           override                      // Sirine Dire Charm
              ~SPIN553.SPL~           override                      // Nalmissra Charm
              ~SPIN558.SPL~           override                      // Erinyes Charm
              ~SPIN674.SPL~           override                      // Mist Chaos
              ~SPIN839.SPL~           override                      // Umber Hulk Confusion Gaze
  WRITE_SHORT 0x25 4 // Enchantment
BUT_ONLY

// Assign the new party-only projectile (RR#VRPO.PRO) to various Bard HLAs

LAM load_RR#VRPO_var

COPY_EXISTING ~RR#BDF04.SPL~ override                               // True Bard's Enhanced Song
              ~RR#BDF06.SPL~ override                               // True Bard's Lingering Song
              ~RR#BSK02.SPL~ override                               // Skald's Enhanced song
              ~RR#BSK04.SPL~ override                               // Skald's Lingering song
              ~RR#BSK04.SPL~ override                               // Skald's Lingering song
              ~RR#WSIC.SPL~  override                               // Spirit Warrior's Aura of Courage ability
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) RR#VRPO
  END
BUT_ONLY


// Assign the new no-party projectile (RR#VRNP.PRO) to various Bard HLAs

LAM load_RR#VRNP_var

COPY_EXISTING ~RR#BHL01.SPL~ override                               // Mass Charm
              ~RR#BHL02.SPL~ override                               // Enthralling Melody
              ~RR#BHL03.SPL~ override                               // Sound Burst
              ~RR#BJS02.SPL~ override                               // Jester's Enhanced Song
              ~RR#BJS04.SPL~ override                               // Jester's Lingering Song
  READ_LONG  0x64 ab_off
  READ_SHORT 0x68 ab_num
  FOR(i=0; i<ab_num; i+=1) BEGIN
    WRITE_SHORT (ab_off+i*0x28+0x26) RR#VRNP
  END
BUT_ONLY


// Evasion and Greater Evasion replacements for Bards - Resonating Weapon and Sound Barrier

COPY ~RR/RR_CORE/BAM/RR#BHL5B.BAM~    override                      // Resonating Weapon icon

COPY ~RR/RR_CORE/SPELLS/RR#BHL05.SPL~ override                      // Resonating Weapon (coat weapons shell)
  SAY NAME1 @8006 SAY NAME2 @8006 SAY UNIDENTIFIED_DESC @8007 SAY DESC @8007

COPY ~RR/RR_CORE/SPELLS/RR#BHL5A.SPL~ override                      // Resonating Weapon (the actual ability)
     ~RR/RR_CORE/SPELLS/RR#BHL05.EFF~ override                      // Resonating Weapon cast secondary spell EFF

// Evasion replacements

COPY ~RR/RR_CORE/BAM/RR#BHL6A.BAM~    override                      // Sound Barrier animation
     ~RR/RR_CORE/VVC/RR#BHL06.VVC~    override                      // Sound Barrier VVC
     ~RR/RR_CORE/BAM/RR#BHL6B.BAM~    override                      // Sound Barrier icon

COPY ~RR/RR_CORE/SPELLS/RR#BHL06.SPL~ override                      // Sound Barrier (immunities + trigger secondary spell on hit)
  SAY NAME1 @8008 SAY NAME2 @8008
  SAY UNIDENTIFIED_DESC @8009 SAY DESC @8009
  LPF ADD_SPELL_EFFECT INT_VAR opcode = 206 target = 1 parameter1 = 4742 duration = 30 insert_point = "-1" STR_VAR resource = fl#shout END //Immunity to shout spell, used by Ultroloths (message=Spell Ineffective)

COPY ~RR/RR_CORE/SPELLS/RR#BHL6A.SPL~ override                      // Sound Barrier (secondary spell, damage + stun + deafness)

// Alchemy revision (Bard Version)

COPY ~RR/RR_STIM/ITEMS/RR#INV.ITM~    override                      // Invulnerability item for cutscene creatures
     ~RR/RR_CORE/ACTORS/RR#ALCH.CRE~  override                      // Alchemy invisible creature (used for initiating the dialogue)
     ~RR/RR_CORE/SPELLS/RR#ALCH.EFF~  override                      // Alchemy invisible creature summoning EFF

COMPILE ~RR/RR_CORE/COMPILE/RR#ALCH.D~                              // Alchemy invisible creature dialogue file (used for choosing potions)
        ~RR/RR_CORE/COMPILE/RR#ALCH.BAF~                            // Alchemy invisible creature AI script (used for initiating the dialogue)

COPY ~RR/RR_CORE/SPELLS/RR#ALCHB.SPL~ override                      // Alchemy (Bard version)
  SAY UNIDENTIFIED_DESC @8101 SAY DESC @8101

// Scribe Scrolls revision

ACTION_IF FILE_EXISTS_IN_GAME dw#si590.itm BEGIN
  OUTER_SPRINT SCSIISpellImmunity
~~~~~
+ ~HaveSpell(2590)~ + @8271 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2590) GiveItemCreate("dw#si590",Myself,1,1,1)~ EXIT //Spell Immunity: Abjuration
+ ~HaveSpell(2591)~ + @8272 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2591) GiveItemCreate("dw#si591",Myself,1,1,1)~ EXIT //Spell Immunity: Conjuration
+ ~HaveSpell(2592)~ + @8273 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2592) GiveItemCreate("dw#si592",Myself,1,1,1)~ EXIT //Spell Immunity: Divination
+ ~HaveSpell(2593)~ + @8274 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2593) GiveItemCreate("dw#si593",Myself,1,1,1)~ EXIT //Spell Immunity: Enchantment
+ ~HaveSpell(2594)~ + @8275 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2594) GiveItemCreate("dw#si594",Myself,1,1,1)~ EXIT //Spell Immunity: Illusion
+ ~HaveSpell(2595)~ + @8276 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2595) GiveItemCreate("dw#si595",Myself,1,1,1)~ EXIT //Spell Immunity: Evocation
+ ~HaveSpell(2596)~ + @8277 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2596) GiveItemCreate("dw#si596",Myself,1,1,1)~ EXIT //Spell Immunity: Necromancy
+ ~HaveSpell(2597)~ + @8278 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2597) GiveItemCreate("dw#si597",Myself,1,1,1)~ EXIT //Spell Immunity: Alteration
~~~~~
END ELSE BEGIN
  OUTER_SPRINT SCSIISpellImmunity ~~
END

ACTION_IF FILE_EXISTS_IN_GAME rr#scr1v.itm AND !VARIABLE_IS_SET RR#DimensionDoor BEGIN // aTweaks' Dimension Door
  OUTER_SPRINT RR#DimensionDoor
~~~~~
+ ~HaveSpell(2402)~ + #12082 DO ~TakePartyGold(250) DestroyGold(250) RemoveSpell(2402) GiveItemCreate("rr#scr1v",Myself,1,1,1)~ EXIT //Dimension Door
~~~~~
END

ACTION_IF FILE_EXISTS_IN_GAME bgscrl1v.itm AND !VARIABLE_IS_SET RR#DimensionDoor BEGIN // BGT Dimension Door scroll
  OUTER_SPRINT RR#DimensionDoor
~~~~~
+ ~HaveSpell(2402)~ + #12082 DO ~TakePartyGold(250) DestroyGold(250) RemoveSpell(2402) GiveItemCreate("bgscrl1v",Myself,1,1,1)~ EXIT //Dimension Door
~~~~~
END

ACTION_IF FILE_EXISTS_IN_GAME _scrl1v.itm AND !VARIABLE_IS_SET RR#DDoor450 BEGIN // Tutu Dimension Door scroll
  OUTER_SPRINT RR#DDoor450
~~~~~
+ ~HaveSpell(2450)~ + #12082 DO ~TakePartyGold(250) DestroyGold(250) RemoveSpell(2402) GiveItemCreate("_scrl1v",Myself,1,1,1)~ EXIT //Dimension Door
~~~~~
END

ACTION_IF FILE_EXISTS_IN_GAME d0scrldd.itm AND !VARIABLE_IS_SET RR#DDoor450 BEGIN // D0Tweaks Dimension Door scroll
  OUTER_SPRINT RR#DDoor450
~~~~~
+ ~HaveSpell(2450)~ + #12082 DO ~TakePartyGold(250) DestroyGold(250) RemoveSpell(2402) GiveItemCreate("d0scrldd",Myself,1,1,1)~ EXIT //Dimension Door
~~~~~
END

ACTION_IF MOD_IS_INSTALLED spell_rev.tp2 0 BEGIN
  COPY_EXISTING spwi111.spl override
    READ_STRREF 0x8 InfravisionText
  BUT_ONLY
  COPY_EXISTING spwi208.spl override
    READ_STRREF 0x8 KnowAlignmentText
  BUT_ONLY
  COPY_EXISTING spwi410.spl override
    READ_STRREF 0x8 RemoveCurseText
  BUT_ONLY
  COPY_EXISTING spwi501.spl override
    READ_STRREF 0x8 AnimateDeadText
  BUT_ONLY
  COPY_EXISTING spwi614.spl override
    READ_STRREF 0x8 DeathFogText
  BUT_ONLY
  COPY_EXISTING spwi623.spl override
    READ_STRREF 0x8 CarrionText
  BUT_ONLY
  COPY_EXISTING spwi707.spl override
    READ_STRREF 0x8 CacofiendText
  BUT_ONLY
  OUTER_SPRINT ProtectionFromFireLevel3 ~~
  OUTER_SPRINT ProtectionFromColdLevel3 ~~
  OUTER_SPRINT ProtectionFromFireLevel5
~~~~~
+ ~HaveSpell(2319)~ + #12086 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2319) GiveItemCreate("SCRL6H",Myself,1,1,1)~ EXIT // Protection from Fire
~~~~~
  OUTER_SPRINT ProtectionFromColdLevel5
~~~~~
+ ~HaveSpell(2320)~ + #7539 DO ~TakePartyGold(500) DestroyGold(500) RemoveSpell(2320) GiveItemCreate("SCRL6I",Myself,1,1,1)~ EXIT // Protection from Cold
~~~~~
END ELSE BEGIN
  OUTER_SPRINT InfravisionText #12039
  OUTER_SPRINT KnowAlignmentText #12043
  OUTER_SPRINT RemoveCurseText #12087
  OUTER_SPRINT AnimateDeadText #12073
  OUTER_SPRINT DeathFogText #7621
  OUTER_SPRINT CarrionText #29211
  OUTER_SPRINT CacofiendText #17320
  OUTER_SPRINT ProtectionFromFireLevel3
~~~~~
+ ~HaveSpell(2319)~ + #12086 DO ~TakePartyGold(150) DestroyGold(150) RemoveSpell(2319) GiveItemCreate("SCRL6H",Myself,1,1,1)~ EXIT // Protection from Fire
~~~~~
  OUTER_SPRINT ProtectionFromColdLevel3
~~~~~
+ ~HaveSpell(2320)~ + #7539 DO ~TakePartyGold(150) DestroyGold(150) RemoveSpell(2320) GiveItemCreate("SCRL6I",Myself,1,1,1)~ EXIT // Protection from Cold
~~~~~
  OUTER_SPRINT ProtectionFromFireLevel5 ~~
  OUTER_SPRINT ProtectionFromColdLevel5 ~~
END

OUTER_SPRINT SpellPackL1 ~~
OUTER_SPRINT SpellPackL2 ~~
OUTER_SPRINT SpellPackL3 ~~
OUTER_SPRINT SpellPackL4 ~~
OUTER_SPRINT SpellPackL5 ~~
OUTER_SPRINT SpellPackL6 ~~
OUTER_SPRINT SpellPackL7 ~~
OUTER_SPRINT SpellPackL8 ~~
OUTER_SPRINT SpellPackL9 ~~

ACTION_IF FILE_EXISTS_IN_GAME lclist_scrolls.2da BEGIN //Galactycon's Spell Pack

  ACTION_DEFINE_ARRAY SPGold BEGIN 0 50 100 150 250 500 1000 1500 2500 5000 END

  COPY_EXISTING lclist_scrolls.2da override
    READ_2DA_ENTRIES_NOW r2en_lclist_scrolls 6
    FOR (i = 0; i < r2en_lclist_scrolls; ++i) BEGIN
      READ_2DA_ENTRY_FORMER r2en_lclist_scrolls i 0 symbol
      READ_2DA_ENTRY_FORMER r2en_lclist_scrolls i 1 scroll
      ids = IDS_OF_SYMBOL (spell "%symbol%")
      INNER_PATCH "%ids%" BEGIN
        READ_ASCII 0 type (1)
        READ_ASCII 1 res (3)
      END
      SPRINT spell ""
      PATCH_MATCH type WITH
        1 BEGIN SPRINT spell "sppr%res%" END
        2 BEGIN SPRINT spell "spwi%res%" END
        DEFAULT END
      PATCH_IF FILE_EXISTS_IN_GAME "%spell%.spl" AND FILE_EXISTS_IN_GAME "%scroll%.itm" BEGIN
        INNER_ACTION BEGIN
          COPY_EXISTING "%spell%.spl" override
            READ_LONG 0x8 name
            READ_LONG 0x34 level
          BUT_ONLY
        END
        SPRINT gold $SPGold("%level%")
        PATCH_MATCH level WITH
          1 BEGIN SPRINT SpellPackL1 ~~~~~%SpellPackL1% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          2 BEGIN SPRINT SpellPackL2 ~~~~~%SpellPackL2% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          3 BEGIN SPRINT SpellPackL3 ~~~~~%SpellPackL3% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          4 BEGIN SPRINT SpellPackL4 ~~~~~%SpellPackL4% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          5 BEGIN SPRINT SpellPackL5 ~~~~~%SpellPackL5% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          6 BEGIN SPRINT SpellPackL6 ~~~~~%SpellPackL6% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          7 BEGIN SPRINT SpellPackL7 ~~~~~%SpellPackL7% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          8 BEGIN SPRINT SpellPackL8 ~~~~~%SpellPackL8% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          9 BEGIN SPRINT SpellPackL9 ~~~~~%SpellPackL9% + ~HaveSpell(%symbol%)~ + #%name% DO ~TakePartyGold(%gold%) DestroyGold(%gold%) RemoveSpell(%symbol%) GiveItemCreate("%scroll%",Myself,1,1,1)~ EXIT~~~~~ END
          DEFAULT END
      END
    END
  BUT_ONLY
END

ACTION_IF !VARIABLE_IS_SET RR#DimensionDoor BEGIN
  OUTER_SPRINT RR#DimensionDoor ~~
END

ACTION_IF !VARIABLE_IS_SET RR#DDoor450 BEGIN
  OUTER_SPRINT RR#DDoor450 ~~
END

COPY ~RR/RR_CORE/ACTORS/RR#SCRL.CRE~ override                // Scribe Scrolls invisible creature (used for initiating the dialogue)
     ~RR/RR_CORE/SPELLS/RR#SCRL.EFF~ override                // Scribe Scrolls invisible creature summoning EFF

COMPILE ~RR/RR_CORE/COMPILE/RR#SCRL.D~ EVAL                  // Scribe Scrolls invisible creature dialogue file (used for choosing which spell to scribe)

COMPILE ~RR/RR_CORE/COMPILE/RR#SCRL.BAF~                     // Scribe Scrolls invisible creature AI script (used for initiating the dialogue)

COPY    ~RR/RR_CORE/SPELLS/RR#SCRL.SPL~    override          // Scribe Scrolls (Bard version)
  SAY UNIDENTIFIED_DESC @8200 SAY DESC @8200



///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Proper spell progression for Bards
///////////////////////////////////////////////////////////////////////

// *** For fellow modders *** this component can be detected by searching for the following file - RR#PPBRD.RR


BEGIN @9 DESIGNATED 6
REQUIRE_PREDICATE ENGINE_IS ~tob bgee bg2ee~ @902

COPY_EXISTING ~sw1h01.itm~ ~override/RR#PPBRD.RR~

// PnP spell progression table based on AD&D "Dungen Master's Option: High-Level Campaigns" supplement and Blucher's work in BG2 Tweaks for levels past 30
// 2DA patching code borrowed from Nythrun with thanks :)

OUTER_PATCH HELLOEVERYBODY BEGIN                                              // Linefeed code, needed for the complex 2DA patching which comes afterwards
    WRITE_BYTE 0 10
    READ_ASCII 0 lnl (1)
END

COPY_EXISTING ~MXSPLBRD.2DA~ override
  COUNT_2DA_COLS cols
  PATCH_IF cols < 9 BEGIN
    READ_2DA_ENTRIES_NOW rows cols
    SPRINT new ~~
    READ_2DA_ENTRY 0 cols - 2 cols - 1 new_level
    FOR (i_0 = cols; i_0 < 9; i_0 += 1) BEGIN
      SPRINT new ~%new%   0~
      SPRINT new_level ~%new_level%   %i_0%~
    END
    FOR (i_0 = 0; i_0 < rows; i_0 += 1) BEGIN
      READ_2DA_ENTRY_FORMER rows i_0 cols - 1 old
      SET_2DA_ENTRY_LATER mxsplbrd_set i_0 cols - 1 ~%old%   %new%~
    END
    SET_2DA_ENTRIES_NOW mxsplbrd_set cols
    SET_2DA_ENTRY 0 cols - 2 cols - 1 ~%new_level%~
    SET cols = 9
  END
  READ_2DA_ENTRIES_NOW rows cols
  SET $level(9) = 0
  FOR (i_0 = 0; i_0 < rows; i_0 += 1) BEGIN
    READ_2DA_ENTRY_FORMER rows i_0 0 level
    SET $level(1) = level < 2  ? 0 : level < 3  ? 1 : level < 5  ? 2 : level < 16 ? 3 : level < 25 ? 4 : level < 28 ? 5 : level < 35 ? 6 : 7
    SET $level(2) = level < 4  ? 0 : level < 6  ? 1 : level < 8  ? 2 : level < 17 ? 3 : level < 25 ? 4 : level < 29 ? 5 : level < 36 ? 6 : 7
    SET $level(3) = level < 7  ? 0 : level < 9  ? 1 : level < 11 ? 2 : level < 18 ? 3 : level < 26 ? 4 : level < 30 ? 5 : level < 37 ? 6 : 7
    SET $level(4) = level < 10 ? 0 : level < 12 ? 1 : level < 14 ? 2 : level < 19 ? 3 : level < 26 ? 4 : level < 31 ? 5 : level < 38 ? 6 : 7
    SET $level(5) = level < 13 ? 0 : level < 15 ? 1 : level < 17 ? 2 : level < 20 ? 3 : level < 27 ? 4 : level < 32 ? 5 : level < 39 ? 6 : 7
    SET $level(6) = level < 16 ? 0 : level < 18 ? 1 : level < 20 ? 2 : level < 21 ? 3 : level < 27 ? 4 : level < 33 ? 5 : level < 40 ? 6 : 7
    SET $level(7) = level < 21 ? 0 : level < 22 ? 1 : level < 23 ? 2 : level < 24 ? 3 : level < 28 ? 4 : level < 34 ? 5 : 6
    SET $level(8) = level < 29 ? 0 : level < 35 ? 1 : 2
    FOR (i_1 = 1; i_1 < cols; i_1 += 1) BEGIN
      SET_2DA_ENTRY_LATER mxsplbrd_set i_0 i_1 $level(~%i_1%~)
    END
  END
  SET_2DA_ENTRIES_NOW mxsplbrd_set cols
  PRETTY_PRINT_2DA
  WHILE level < 50 BEGIN
    REPLACE_EVALUATE ~^\(%level%\)\(.+\)~ BEGIN
      SET level += 1
    END              ~\1\2%lnl%%level%\2~
  END
BUT_ONLY



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Additional equipment for Thieves and Bards
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


// *** For fellow modders *** this component can be detected by searching for the following file - RR#GUARA.ITM

BEGIN @5 DESIGNATED 7                                               // Additional equipment for Thieves and Bards
REQUIRE_PREDICATE ENGINE_IS ~tob bgee bg2ee~ AND !GAME_IS ~iwd-in-bg2~ @902

INCLUDE ~RR/LIB/RR#SSOB.TPH~                                        // Include the Short Sword of Backstabbing patch macro
LAUNCH_ACTION_MACRO ~RR#AFIX~

INCLUDE "rr/lib/ds.tpa"                                             // Detectable Spells


ACTION_IF NOT MOD_IS_INSTALLED ITEM_REV.TP2 0 BEGIN
COPY ~RR/RR_CORE/BAM/RR#CKIEL.BAM~ override                         // Kiel's Buckler description icon (CSHLD20.BAM is missing in BG2)

// Patch the changes into Kiel's buckler

COPY_EXISTING ~%tutu_var%SHLD20.ITM~ override                       // Kiel's Buckler
  PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
    SAY DESC @111                                                                  // updated description
    WRITE_LONG 0x34 4000                                                           // price increase
    WRITE_ASCII 0x3a ~ISHLD20~ #8                                                  // use the proper inventory icon
    WRITE_SHORT 0x42 55                                                            // require lore value of 55 to identify
    WRITE_ASCII 0x44 ~GSHLD08~ #8                                                  // use the proper ground icon
    WRITE_ASCII 0x58 ~RR#CKIEL~ #8                                                 // use the proper description icon (CSHLD20.BAM is missing in BG2)
    READ_LONG   0x64 "abil_off"
    READ_SHORT  0x68 "abil_num"
    READ_LONG   0x6a "fx_off"
    READ_SHORT  0x70 "fx_num"
    FOR (index2 = 0 ; index2 < fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        ("%index2%" * 0x30)) "opcode"
      READ_SHORT ("%fx_off%" + 0x04 + ("%index2%" * 0x30)) "param1"
      READ_SHORT ("%fx_off%" + 0x08 + ("%index2%" * 0x30)) "param2"
      PATCH_IF (("%opcode%" = 0) AND  ("%param2%" = 0)) BEGIN                      // AC vs. all weapons
        WRITE_LONG ("%fx_off%" + 0x04 + ("%index2%" * 0x30)) "2"                     // set AC vs. all weapons to 2
      END
      PATCH_IF (("%opcode%" = 0) AND ("%param2%" = 2)) BEGIN                       // AC vs. missile weapons
        WRITE_LONG ("%fx_off%" + 0x04 + ("%index2%" * 0x30)) "-2"                    // set AC vs. missile weapons to -2
      END
      PATCH_IF (("%opcode%" = 0) AND ("%param2%" = 4)) BEGIN                       // AC vs. piercing weapons
        WRITE_LONG ("%fx_off%" + 0x04 + ("%index2%" * 0x30)) "-2"                    // set AC vs. piercing weapons to -2
      END
    END
    LPF ADD_ITEM_EQEFFECT
      INT_VAR
        opcode = 7      // effect: #7 (set character colours by palette)
        target = 1      // target: 1 (self)
        parameter1 = 2  // param1: 2(gradient)
        parameter2 = 33 // param2: 33 (location)
        timing = 2      // timing mode: 2 (while equipped)
    END
    LPF ADD_ITEM_EQEFFECT
      INT_VAR
        opcode = 7      // effect: #7 (set character colours by palette)
        target = 1      // target: 1 (self)
        parameter1 = 39 // param1: 39(gradient)
        parameter2 = 34 // param2: 34 (location)
        timing = 2      // timing mode: 2 (while equipped)
    END
    LPF ADD_ITEM_EQEFFECT
      INT_VAR
        opcode = 7      // effect: #7 (set character colours by palette)
        target = 1      // target: 1 (self)
        parameter1 = 43 // param1: 43 (gradient)
        parameter2 = 36 // param2: 36 (location)
        timing = 2      // timing mode: 2 (while equipped)
    END
  END
BUT_ONLY
END                                                                                // end Item Revisions check


COPY ~RR/RR_CORE/BAM/RR#BUC01.BAM~    override               // Fading Glory icon
     ~RR/RR_CORE/SPELLS/RR#BUC01.SPL~ override               // Fading Glory anti-undead main spell (affects only undead thanks to EFF targeting)
     ~RR/RR_CORE/SPELLS/RR#BUC1A.EFF~ override               // Deals 1d2 points of dire damage
     ~RR/RR_CORE/SPELLS/RR#BUC1B.EFF~ override               // Blinds target for 12 seconds
     ~RR/RR_CORE/SPELLS/RR#BUC1C.EFF~ override               // Displays the "Blinded" icon for 12 seconds
     ~RR/RR_CORE/SPELLS/RR#BUC1D.EFF~ override               // Displays the first part of the "Blinded" animation
     ~RR/RR_CORE/SPELLS/RR#BUC1E.EFF~ override               // Displays the second part of the "Blinded" animation
     ~RR/RR_CORE/SPELLS/RR#BUC1F.EFF~ override               // Displays the "Blinded" text string

COPY ~RR/RR_CORE/ITEMS/RR#BUC01.ITM~  override               // Fading Glory (Buckler +1)
  SAY NAME2 @200 SAY DESC @201

COPY ~RR/RR_CORE/BAM/RR#BUC02.BAM~    override               // Buckler +1 (round)
     ~RR/RR_CORE/ITEMS/RR#BUC02.ITM~  override
     ~RR/RR_CORE/BAM/RR#BUC03.BAM~    override               // Buckler +2

COPY ~RR/RR_CORE/ITEMS/RR#BUC03.ITM~  override
  SAY NAME2 @20 SAY DESC @21

COPY ~RR/RR_CORE/BAM/RR#BUC04.BAM~    override               // Buckler +3

COPY ~RR/RR_CORE/ITEMS/RR#BUC04.ITM~  override
  SAY NAME2 @22 SAY DESC @23

COPY ~RR/RR_CORE/BAM/RR#RWARD.BAM~    override               // Rogue's Ward

COPY ~RR/RR_CORE/ITEMS/RR#RWARD.ITM~  override
  SAY NAME2 @26 SAY DESC @27

COPY ~RR/RR_CORE/BAM/RR#GUARA.BAM~    override               // The Guardian icon

COPY ~RR/RR_CORE/ITEMS/RR#GUARA.ITM~  override               // The Guardian
  SAY NAME2 @24 SAY DESC @25

COPY ~RR/RR_CORE/ITEMS/RR#GUARB.ITM~  override               // The Guardian +2 (gained after summoning a Shambling Mound at Druid level 14)
  SAY NAME2 @5002 SAY DESC @5003

COPY ~RR/RR_CORE/ITEMS/RR#GUARC.ITM~  override               // The Guardian +3 (gained after summoning a Shambling Mound at Druid level 25)
  SAY NAME2 @5004 SAY DESC @5005

COPY ~RR/RR_CORE/ITEMS/RR#SHM01.ITM~  override               // Lesser Shambler's weapon
     ~RR/RR_CORE/ITEMS/RR#SHM02.ITM~  override               // Shambling Mound's weapon
     ~RR/RR_CORE/ITEMS/RR#SHM03.ITM~  override               // Greater Shambler's weapon
  LAUNCH_PATCH_FUNCTION ~cure_spell_immunities~ END          // add immunity to cure/cause wound spells

COPY ~RR/RR_CORE/SPELLS/RR#SHM01.EFF~ override               // Lesser Shambler's summoning EFF
     ~RR/RR_CORE/SPELLS/RR#SHM02.EFF~ override               // Shambling Mound's summoning EFF
     ~RR/RR_CORE/SPELLS/RR#SHM03.EFF~ override               // Greater Shambler's summoning EFF
     ~RR/RR_CORE/SPELLS/RR#SHM.SPL~   override               // Shambler summoning spell
     ~RR/RR_CORE/BAM/RR#SHM.BAM~      override               // Shambler GUI icon
     ~RR/RR_CORE/SPELLS/RR#SMENT.EFF~ override               // Shambler entanglement immunity (for huge and incorporeal creatures)
     ~RR/RR_CORE/SPELLS/RR#SMENT.SPL~ override               // Shambler entanglement ability
     ~RR/RR_CORE/SPELLS/RR#INVIS.SPL~ override               // Custom Invisibility spell, used for shambler blending

COPY ~RR/RR_CORE/ACTORS/RR#SHM01.CRE~ override               // Lesser Shambler
  SAY NAME1 @63 SAY NAME2 @63 SAY INITIAL_MEETING @421
  SAY BATTLE_CRY1 @421 SAY BATTLE_CRY2 @422 SAY ATTACK1 @423
  SAY ATTACK2 @424 SAY ATTACK3 @425 SAY DAMAGE @426
  SAY DYING @427 SAY SELECT_COMMON1 @421 SAY SELECT_COMMON2 @422

COPY ~RR/RR_CORE/ACTORS/RR#SHM02.CRE~ override               // Shambling Mound
  SAY INITIAL_MEETING @421 SAY BATTLE_CRY1 @421
  SAY BATTLE_CRY2 @422 SAY ATTACK1 @423 SAY ATTACK2 @424
  SAY ATTACK3 @425 SAY DAMAGE @426 SAY DYING @427
  SAY SELECT_COMMON1 @421 SAY SELECT_COMMON2 @422

COPY ~RR/RR_CORE/ACTORS/RR#SHM03.CRE~ override               // Greater Shambler
  SAY NAME1 @64 SAY NAME2 @64 SAY INITIAL_MEETING @421
  SAY BATTLE_CRY1 @421 SAY BATTLE_CRY2 @422 SAY ATTACK1 @423
  SAY ATTACK2 @424 SAY ATTACK3 @425 SAY DAMAGE @426
  SAY DYING @427 SAY SELECT_COMMON1 @421 SAY SELECT_COMMON2 @422

COMPILE ~RR/RR_CORE/COMPILE/RR#SHM.BAF~                      // Shambler's AI script


// Fix the wrong proficiency type, enchantment level and missing poison icon on the Dagger of Venom

ACTION_IF NOT MOD_IS_INSTALLED ITEM_REV.TP2 0 BEGIN
COPY_EXISTING ~%tutu_var%misc75.itm~ override                // Dagger of Venom
  WRITE_BYTE  0x31 96 // set proficiency to dagger
  WRITE_LONG 0x60 2   // set enchantment level to 2
  READ_LONG  0x64 "abil_off" ELSE 0
  READ_SHORT 0x68 "abil_num" ELSE 0
  READ_LONG  0x6a "fx_off"   ELSE 0
  SET "abil_length" = 0x38
  SET "fx_delta" = 0
  FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + ("%abil_length%" * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + ("%abil_length%" * "%index%")) "abil_fx_idx"
    SET "abil_fx_idx" = ("%abil_fx_idx%" + "%fx_delta%")
    WRITE_SHORT ("%abil_off%" + 0x20 + ("%abil_length%" * "%index%")) ("%abil_fx_idx%")
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "opcode"
      PATCH_IF ("%opcode%" = 25) BEGIN // poison
        READ_ASCII ("%fx_off%" +        (0x30 * ("%abil_fx_idx%" + "%index2%"))) "clone" (48) // clone poison opcode
        INSERT_BYTES            ("%fx_off%" +        (0x30 * "%abil_fx_idx%")) 0x30      // insert new effect
          WRITE_EVALUATED_ASCII ("%fx_off%" +        (0x30 * "%abil_fx_idx%")) "%clone%" // cloned opcode
          WRITE_SHORT           ("%fx_off%" +        (0x30 * "%abil_fx_idx%")) 142       // opcode: 142 (Display Special Effect Icon)
          WRITE_LONG            ("%fx_off%" + 0x04 + (0x30 * "%abil_fx_idx%")) 0         // param1: 0
          WRITE_LONG            ("%fx_off%" + 0x08 + (0x30 * "%abil_fx_idx%")) 6         // param2: 6 (Poisoned icon)
        SET "fx_delta" = "%fx_delta%" + 1
        SET "abil_fx_num" = "%abil_fx_num%" + 1
        WRITE_SHORT  ("%abil_off%" + 0x1e + ("%abil_length%" * "%index%")) "%abil_fx_num%"
        SET "index2" = "%abil_fx_num%"
      END
    END
  END
BUT_ONLY
END                                                                 // end Item Revisions check

COPY_EXISTING ~%tutu_var%DAGG04.ITM~ override                     // Alter the Longtooth Dagger
  WRITE_LONG 0x80 "01"                                            // Increase range to 1 (was 0)
  WRITE_SHORT 0x42 60                                             // Require Lore value of 60 to identify (was 0 in BG2)
BUT_ONLY

COPY ~RR/RR_CORE/BAM/RR#LYRE.BAM~    override                     // Lyre of Progression

COPY ~RR/RR_CORE/ITEMS/RR#LYRE.ITM~  override
  SAY NAME1 @10000 SAY UNIDENTIFIED_DESC @10001
  SAY NAME2 @56 SAY DESC @57

COPY ~RR/RR_CORE/BAM/RR#FDART.BAM~   override                     // Returning Frost Dart
COPY ~RR/RR_CORE/ITEMS/RR#FDART.ITM~ override
  SAY NAME2 @58 SAY DESC @59

COPY ~RR/RR_CORE/BAM/RR#ACUMN.BAM~   override                     // Dagger of Acumen (for Aran Linvail)

COPY ~RR/RR_CORE/ITEMS/RR#ACUMN.ITM~ override
  SAY NAME2 @146 SAY DESC @147

ACTION_IF GAME_IS ~soa tob bgt bg2ee~ BEGIN
  COPY_EXISTING ~ARAN.CRE~ override                                 // Aran Linvail, non-STI (for the Dagger of Acumen)
    ADD_CRE_ITEM ~RR#ACUMN~ #0 #0 #0 ~NONE~ ~INV7~                  // Give Aran the Dagger of Acumen (for pickpocketing)

  COPY_EXISTING ~ARAN02.CRE~ override                               // Aran Linvail, non-STI (original game and Quest Pack
    ADD_CRE_ITEM ~RR#ACUMN~ #0 #0 #0 ~NONE~ ~INV7~                  // Give Aran the Dagger of Acumen
    ADD_CRE_ITEM ~SW1H10~ #0 #0 #0 ~NONE~ ~INV8~                    // Give Aran the Short Sword of Backstabbing


  COPY_EXISTING ~BOOTER.CRE~ override                               // Booter, non-STI (for Plaguebearer and Longtooth)
    WRITE_SHORT 0x28 25348                                          // Change Booter's avatar to THIEF_MALE_GNOME
    ADD_CRE_ITEM ~RR#PLAG~ #0 #0 #0 ~NONE~ ~INV7~                   // Give Booter the Plaguebearer dagger
    ADD_CRE_ITEM ~DAGG04~ #0 #0 #0 ~NONE~ ~INV8~                    // Give Booter the Longtooth dagger

  COPY_EXISTING ~BMTHIEF.CRE~ override                              // Marina (formerly Black Market Thief)
    SAY NAME1 @62 SAY NAME2 @62                                     // Sets Marina's name
    WRITE_ASCII 0x34 ~RR#MARIN~ #8                                  // Sets Marina's small portrait
    REMOVE_CRE_ITEM ~rndtre03~                                      // removes the random treasure 03 item
    REMOVE_CRE_ITEM ~rndtre04~                                      // removes the random treasure 04 item
    REPLACE_CRE_ITEM ~LEAT08~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~        // Gives Marina the Shadow Armor (for cosmetic purposes)
    REPLACE_CRE_ITEM ~BOW04~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON2~ EQUIP TWOHANDED // Gives Marina a Long Bow +1 (non-composite)
    ADD_CRE_ITEM ~POTN10~ #0 #0 #0 ~UNSTEALABLE~ ~QITEM1~           // Gives Marina a Potion of Invisibility
    WRITE_LONG 0x18 161000                                          // current XP
    WRITE_SHORT 0x24 75                                             // current hit points
    WRITE_SHORT 0x26 75                                             // maximum hit points
    WRITE_SHORT 0x28 25360                                          // Sets avatar to THIEF_FEMALE_HUMAN
    WRITE_BYTE 0x2C 30                                              // metal color
    WRITE_BYTE 0x2D 72                                              // minor color
    WRITE_BYTE 0x2E 21                                              // major color
    WRITE_BYTE 0x2F 108                                             // skin color
    WRITE_BYTE 0x30 30                                              // leather color
    WRITE_BYTE 0x31 29                                              // armor color
    WRITE_BYTE 0x32 0                                               // hair color
    WRITE_BYTE 0x45 15                                              // Hide in Shadows skill
    WRITE_BYTE 0x52 14                                              // THAC0
    WRITE_BYTE 0x54 10                                              // save vs. death
    WRITE_BYTE 0x55 12                                              // save vs. wands
    WRITE_BYTE 0x56 11                                              // save vs. polymorph
    WRITE_BYTE 0x57 12                                              // save vs. breath
    WRITE_BYTE 0x58 13                                              // save vs. spells
    WRITE_BYTE 0x64 0                                               // Detect Illusions skill
    WRITE_BYTE 0x65 0                                               // Set Traps skill
    WRITE_BYTE 0x66 18                                              // Lore
    WRITE_BYTE 0x67 70                                              // Open Locks skill
    WRITE_BYTE 0x68 10                                              // Move Silently skill
    WRITE_BYTE 0x69 85                                              // Find Traps skill
    WRITE_BYTE 0x6a 35                                              // Pick Pockets skill
    WRITE_BYTE 0x6f 0                                               // BG1 Proficiency slot (small sword)
    WRITE_BYTE 0x75 0                                               // BG1 Proficiency slot (missile)
    WRITE_BYTE 0x234 7                                              // level (first class)
    WRITE_BYTE 0x235 8                                              // level (second class)
    WRITE_BYTE 0x236 0                                              // level (third class)
    WRITE_BYTE 0x238 12                                             // Strength
    WRITE_BYTE 0x23a 14                                             // Inteligence
    WRITE_BYTE 0x23b 11                                             // Wisdom
    WRITE_BYTE 0x23c 18                                             // Dexterity
    WRITE_BYTE 0x23d 13                                             // Constitution
    WRITE_BYTE 0x23e 15                                             // Charisma
    WRITE_BYTE 0x23f 18                                             // morale
    WRITE_BYTE 0x240 5                                              // morale break
    WRITE_BYTE 0x242 30                                             // morale recovery
    WRITE_BYTE 0x272 3                                              // race
    WRITE_BYTE 0x273 9                                              // class
    WRITE_BYTE 0x27b 34                                             // alignment
    WRITE_ASCII 0x248 ~RR#MARIN~ #8                                 // override AI script
    WRITE_ASCII 0x268 ~~ #8                                         // disable default AI script (WTARSGT.BCS)
    SET_BG2_PROFICIENCY ~PROFICIENCYLONGBOW~ 2                      // Give Marina 2 stars in the BG2 Longbow proficiency
    SET_BG2_PROFICIENCY ~PROFICIENCYLONGSWORD~ 2                    // Give Marina 2 stars in the BG2 Longsword proficiency
    SET_BG2_PROFICIENCY ~PROFICIENCYSHORTSWORD~ 2                   // Give Marina 2 stars in the BG2 Shortsword proficiency
  BUT_ONLY


  // Make Marina's and Arledrian's dialogue files pause the game

  COPY_EXISTING ~BMTHIEF.DLG~ override
                ~ARLED.DLG~ override
    WRITE_LONG 0x30 0
  BUT_ONLY

  // AR0306 script fix to prevent the player from acquiring multiple SSoB items

  COPY_EXISTING ~AR0306.ARE~ override                                                                 // AR0306 (Renal's room) is missing its area script in the unmodded game
    READ_ASCII 0x94 ~areascript~
    PATCH_IF ~%areascript%~ STRING_EQUAL_CASE ~~ OR ~%areascript%~ STRING_EQUAL_CASE ~None~ BEGIN
      WRITE_EVALUATED_ASCII 0x94 ~AR0306~ #8
      SPRINT ~areascript~ ~AR0306~
    END
  BUT_ONLY

  ACTION_IF !FILE_EXISTS_IN_GAME ~%areascript%.bcs~ BEGIN
    COMPILE ~RR/RR_CORE/COMPILE/AR0306.BAF~
  END ELSE BEGIN
    EXTEND_BOTTOM ~%areascript%.bcs~ ~RR/RR_CORE/COMPILE/AR0306.BAF~
  END

  // Replace Mae'Var's SSoB with a generic Short Sword +3 (only in case he's wielding the SSoB)

  EXTEND_BOTTOM ~AR0301.BCS~  ~RR/RR_CORE/COMPILE/AR0301.BAF~         // Update AR0301.BCS to replace SW1H10 with SW1H74 for Mae'Var

  ACTION_IF NOT FILE_EXISTS_IN_GAME ~rr#stf01.bcs~ BEGIN
    COMPILE ~RR/RR_CORE/COMPILE/ARAN.D~                             // Aran Linvail's Chapter 6 SSoB dialogue line
            ~RR/RR_CORE/COMPILE/RENAL.D~                            // Renal awards the party with a regular +3 Shortsword instead of the SSoB
  END

  // Marina's stores, dialogue and AI script

  COPY ~RR/RR_CORE/BAM/RR#MARIN.BMP~   override                          // Marina's portrait
       ~RR/RR_CORE/ITEMS/RR#MARIN.STO~ override                          // Marina's premium store

  COMPILE ~RR/RR_CORE/COMPILE/RR#MARIN.BAF~                              // Marina's AI script
          ~RR/RR_CORE/COMPILE/BMTHIEF.D~                                 // Marina's new dialogue

  COPY_EXISTING ~BMTHIEF.STO~ override                                   // Some minor additions to Marina's default store
    ADD_STORE_ITEM + ~DAGG16~ #40 #0 #0 ~IDENTIFIED~ #3                  // Sets Poisoned Dagger stack to 40
    ADD_STORE_ITEM + ~DART01~ #40 #0 #0 ~IDENTIFIED~ #3                  // Sets Dart stack to 40
    ADD_STORE_ITEM ~STAF01~   AFTER  ~BLUN06~ #0 #0 #0 ~IDENTIFIED~ #6   // Adds 6x Quarterstaff
    ADD_STORE_ITEM ~STAF02~   AFTER  ~STAF01~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Quarterstaff +1
    ADD_STORE_ITEM ~BLUN01~   AFTER  ~STAF02~ #0 #0 #0 ~IDENTIFIED~ #6   // Adds 6x Club
    ADD_STORE_ITEM ~RR#SAP01~ AFTER  ~BLUN01~ #0 #0 #0 ~IDENTIFIED~ #6   // Adds 6x Sap
    ADD_STORE_ITEM ~BOW04~    AFTER  ~BOW03~ #0 #0 #0 ~IDENTIFIED~ #2    // Adds 2x Long Bow +1
    ADD_STORE_ITEM ~BOW06~    AFTER  ~BOW05~ #0 #0 #0 ~IDENTIFIED~ #2    // Adds 2x Short Bow +1
    ADD_STORE_ITEM ~RR#BOW02~ AFTER  ~BOW06~ #0 #0 #0 ~IDENTIFIED~ #6    // Adds 6x Composite Short Bow
    ADD_STORE_ITEM ~DAGG02~   AFTER  ~DAGG01~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Dagger +1
    ADD_STORE_ITEM ~DAGG05~   AFTER  ~DAGG16~ #40 #0 #0 ~IDENTIFIED~ #3  // Adds 3x40 Throwing Daggers
    ADD_STORE_ITEM ~DART02~   AFTER  ~DART01~ #40 #0 #0 ~IDENTIFIED~ #3  // Adds 3x40 Darts +1
    ADD_STORE_ITEM ~SLNG02~   AFTER  ~SLNG01~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Sling +1
    ADD_STORE_ITEM ~SW1H05~   AFTER  ~SW1H04~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Long Sword +1
    ADD_STORE_ITEM ~SW1H08~   AFTER  ~SW1H07~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Short Sword +1
    ADD_STORE_ITEM ~SW1H20~   AFTER  ~SW1H08~ #0 #0 #0 ~IDENTIFIED~ #6   // Adds 6x Scimitar
    ADD_STORE_ITEM ~SW1H22~   AFTER  ~SW1H20~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Scimitar +1
    ADD_STORE_ITEM ~SW1H47~   AFTER  ~SW1H46~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Wakizashi +1
    ADD_STORE_ITEM ~SW1H48~   AFTER  ~SW1H47~ #0 #0 #0 ~IDENTIFIED~ #3   // Adds 3x Ninja To
    ADD_STORE_ITEM ~SW1H49~   AFTER  ~SW1H48~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Ninja To +1
    ADD_STORE_ITEM ~SW1H43~   AFTER  ~SW1H49~ #0 #0 #0 ~IDENTIFIED~ #3   // Adds 3x Katana
    ADD_STORE_ITEM ~SW1H44~   AFTER  ~SW1H43~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Katana +1
    ADD_STORE_ITEM ~XBOW02~   AFTER  ~XBOW01~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Heavy Crossbow +1
    ADD_STORE_ITEM ~XBOW04~   AFTER  ~XBOW02~ #0 #0 #0 ~IDENTIFIED~ #3   // Adds 2x Light Crossbow
    ADD_STORE_ITEM ~XBOW05~   AFTER  ~XBOW04~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Light Crossbow +1
    ADD_STORE_ITEM ~LEAT02~   AFTER  ~LEAT01~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Leather Armor +1
    ADD_STORE_ITEM ~LEAT05~   AFTER  ~LEAT04~ #0 #0 #0 ~IDENTIFIED~ #2   // Adds 2x Studded Leather Armor +1
    ADD_STORE_ITEM ~LEAT10~   AFTER  ~LEAT05~ #0 #0 #0 ~IDENTIFIED~ #3   // Adds 3x Hide Armor
    ADD_STORE_ITEM ~SCRL1J~   AFTER  ~SCRL90~ #1 #0 #0 ~IDENTIFIED~ #3   // Adds 3x Invisibility 10' Radius scroll
    ADD_STORE_ITEM ~SCRLA6~   AFTER  ~SCRL71~ #1 #0 #0 ~IDENTIFIED~ #3   // Adds 3x Spook scroll
    ADD_STORE_ITEM ~SCRLA7~   AFTER  ~SCRL1E~ #1 #0 #0 ~IDENTIFIED~ #3   // Adds 3x Remove Magic scroll


  // Arledrian's Silverblaze Quest
  COPY_EXISTING ~ARLED.CRE~ override                                  // Arledrian
    WRITE_ASCII 0x34 ~RR#ARLDS~ #8                                    // Sets Arledrian's small portrait
    REMOVE_CRE_ITEM ~rndtre04~                                        // removes the random treasure 04 item
    REMOVE_CRE_ITEM ~bow05~                                           // removes the Short Bow (which messes up his DW)
    REMOVE_CRE_ITEM ~sw1h08~                                          // removes the Short Sword +1
    REMOVE_CRE_ITEM ~arow02~                                          // removes the Arrows +1
    REPLACE_CRE_ITEM ~CHAN02~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // replaces Arledrian's armor with Chain Mail +1
    ADD_CRE_ITEM ~DAGG02~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON1~ EQUIP      // Replaces Arledrian Short Sword +1 with a Dagger +1
    ADD_CRE_ITEM ~DAGG15~ #0 #0 #0 ~UNSTEALABLE~ ~SHIELD~             // Gives Arledrian a Dagger +2
    ADD_CRE_ITEM ~RR#SILV~ #0 #3 #0 ~NONE~ ~INV1~                     // Gives Arledrian the Silverblaze dagger
    ADD_CRE_ITEM ~POTN10~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM1~             // Gives Arledrian 1x Potion of Invisibility
    ADD_CRE_ITEM ~POTN52~ #1 #0 #0 ~NONE~ ~QITEM2~                    // Gives Arledrian 1x Potion of Extra Healing
    WRITE_LONG 0x14 3000                                              // XP value (when killed)
    WRITE_LONG 0x18 161000                                            // current XP
    WRITE_SHORT 0x24 67                                               // current hit points
    WRITE_SHORT 0x26 67                                               // maximum hit points
    WRITE_SHORT 0x28 24833                                            // Sets avatar to FIGHTER_MALE_ELF
    WRITE_BYTE 0x2C 35                                                // metal color
    WRITE_BYTE 0x2D 32                                                // minor color
    WRITE_BYTE 0x2E 32                                                // major color
    WRITE_BYTE 0x2F 108                                               // skin color
    WRITE_BYTE 0x30 60                                                // leather color
    WRITE_BYTE 0x31 60                                                // armor color
    WRITE_BYTE 0x32 2                                                 // hair color
    WRITE_BYTE 0x45 5                                                 // Hide in Shadows skill
    WRITE_BYTE 0x52 14                                                // THAC0
    WRITE_BYTE 0x54 10                                                // save vs. death
    WRITE_BYTE 0x55 12                                                // save vs. wands
    WRITE_BYTE 0x56 11                                                // save vs. polymorph

    WRITE_BYTE 0x57 12                                                // save vs. breath
    WRITE_BYTE 0x58 13                                                // save vs. spells
    WRITE_BYTE 0x64 0                                                 // Detect Illusions skill
    WRITE_BYTE 0x65 50                                                // Set Traps skill
    WRITE_BYTE 0x66 24                                                // Lore
    WRITE_BYTE 0x67 55                                                // Open Locks skill
    WRITE_BYTE 0x68 0                                                 // Move Silently skill
    WRITE_BYTE 0x69 55                                                // Find Traps skill
    WRITE_BYTE 0x6a 50                                                // Pick Pockets skill
    WRITE_LONG 0xa4 4942                                              // initial meeting string
    WRITE_LONG 0xec 12586                                             // damage string
    WRITE_LONG 0xf0 12587                                             // death string
    WRITE_LONG 0x10c 4942                                             // select common 1
    WRITE_LONG 0x110 4941                                             // select common 2
    WRITE_BYTE 0x234 7                                                // level (first class)
    WRITE_BYTE 0x235 8                                                // level (second class)
    WRITE_BYTE 0x236 0                                                // level (third class)
    WRITE_BYTE 0x238 12                                               // Strength
    WRITE_BYTE 0x23a 16                                               // Inteligence
    WRITE_BYTE 0x23b 11                                               // Wisdom
    WRITE_BYTE 0x23c 19                                               // Dexterity
    WRITE_BYTE 0x23d 10                                               // Constitution
    WRITE_BYTE 0x23e 13                                               // Charisma
    WRITE_BYTE 0x23f 18                                               // morale
    WRITE_BYTE 0x240 5                                                // morale break
    WRITE_BYTE 0x242 30                                               // morale recovery
    WRITE_BYTE 0x272 2                                                // race
    WRITE_BYTE 0x273 9                                                // class
    WRITE_BYTE 0x27b 34                                               // alignment
    WRITE_ASCII 0x248 ~RR#ARLED~ #8                                   // assign override AI script
    WRITE_ASCII 0x250 ~None~ #8                                       // disable class AI script (STEALAMN.BCS)
    WRITE_ASCII 0x258 ~None~ #8                                       // disable race AI script (GPUSE.BCS)
    WRITE_ASCII 0x260 ~None~ #8                                       // disable general AI script (NONE)
    WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTARSGT.BCS)
    SET_BG2_PROFICIENCY ~PROFICIENCYDAGGER~ 2                         // Give Arledrian 2 stars in the BG2 Dagger proficiency
    SET_BG2_PROFICIENCY ~PROFICIENCY2WEAPON~ 3                        // Give Arledrian 3 stars in the BG2 Two Weapon Style proficiency
  BUT_ONLY

  COPY ~RR/RR_CORE/BAM/RR#ARLDS.BMP~    override               // Arledrian's portrait

  COPY ~RR/RR_CORE/ITEMS/RR#BK01.ITM~   override               // Arledrian's Journal (translated)
    SAY NAME1 @160 SAY NAME2 @160 SAY DESC @161

  COPY ~RR/RR_CORE/ITEMS/RR#BK02.ITM~   override               // Arledrian's Journal (if Silverblaze was stolen)
    SAY NAME1 @160 SAY NAME2 @160 SAY DESC @162

  COPY ~RR/RR_CORE/ITEMS/RR#BK03.ITM~   override               // Arledrian's Journal (in Elvish)
    SAY NAME1 @160 SAY NAME2 @160 SAY DESC @163

  COPY ~RR/RR_CORE/ITEMS/RR#BK04.ITM~   override               // Arledrian's Poster
    SAY NAME1 @164 SAY NAME2 @164 SAY DESC @165

  COPY ~RR/RR_CORE/ACTORS/RR#ARLEJ.CRE~ override               // Arledrian's Journal (invisible creature)
    SAY NAME1 @160  SAY NAME2 @160

  COPY ~RR/RR_CORE/ACTORS/RR#VAM01.CRE~ override               // Arledrian's vampiric opponents
       ~RR/RR_STIM/ITEMS/RR#INV.ITM~    override               // Invulnerability item for cutscene creatures

  COMPILE ~RR/RR_CORE/COMPILE/RR#VAM01.BAF~                           // Modified vampire AI for Arledrian's vampires
  COMPILE ~RR/RR_CORE/COMPILE/RR#ARLED.BAF~                           // Arledrian's AI script

  EXTEND_BOTTOM ~AR0511.BCS~  ~RR/RR_CORE/COMPILE/AR0511.BAF~         // Arledrian's journal triggers
  EXTEND_BOTTOM ~AR0312.BCS~  ~RR/RR_CORE/COMPILE/AR0312.BAF~         // Arledrian's poster trigger

  COMPILE ~RR/RR_CORE/COMPILE/RR#ARLEJ.D~                             // Arledrian's journal dialogue
  COMPILE ~RR/RR_CORE/COMPILE/ARLED.D~                                // Arledrian's new dialogue
  COMPILE ~RR/RR_CORE/COMPILE/GAELAN.D~                               // Gaelan's dialogue additions
  COMPILE ~RR/RR_CORE/COMPILE/FFBART.D~                               // Samuel's dialogue additions (Five Flaggons innkeeper)
  COMPILE ~RR/RR_CORE/COMPILE/RR#INT02.D~                             // Arledrian's journal party interjections
END

// PnP Short Sword of Backstabbing

LAUNCH_ACTION_MACRO ~RR#SSOB~                                     // Launch the Short Sword of Backstabbing patch

COPY ~RR/RR_CORE/ITEMS/RR#SSOBA.EFF~ override                     // SSoB to hit bonus (main hand only)
     ~RR/RR_CORE/ITEMS/RR#SSOBB.EFF~ override                     // SSoB backstab bonus

// Trollmelter (Dagger +2)

COPY ~RR/RR_CORE/BAM/RR#TROL.BAM~    override
     ~RR/RR_CORE/ITEMS/RR#TROLH.EFF~ override                // +2 bonus to attack rolls vs. trolls (always)
     ~RR/RR_CORE/ITEMS/RR#TROLD.EFF~ override                // +2 bonus acid damage vs. trolls (always)
     ~RR/RR_CORE/ITEMS/RR#TROLA.EFF~ override                // 15 bonus acid damage vs. trolls (15% chance)
     ~RR/RR_CORE/ITEMS/RR#TROLB.EFF~ override                // Acid Arrow effect plays when the bonus damage occurs
     ~RR/RR_CORE/ITEMS/RR#TROLC.EFF~ override                // lighting effect plays when the bonus damage occurs

COPY ~RR/RR_CORE/ITEMS/RR#TROL.ITM~  override
  SAY NAME2 @120 SAY DESC @121  // Trollmelter


// Silverblaze (Dagger +3)

COPY ~RR/RR_CORE/BAM/RR#SILV.BAM~    override
     ~RR/RR_CORE/ITEMS/RR#SILVH.EFF~ override                // +2 bonus to attack rolls vs. vampires (always)
     ~RR/RR_CORE/ITEMS/RR#SILVD.EFF~ override                // +2 bonus to damage rolls vs. vampires (always)
     ~RR/RR_CORE/ITEMS/RR#SILVA.EFF~ override                // stuns vampires (15% chance, no save)
     ~RR/RR_CORE/ITEMS/RR#SILVB.EFF~ override                // displays "Stunned" message (15% chance, no save)
     ~RR/RR_CORE/ITEMS/RR#SILVC.EFF~ override                // Play Power Word:Stun 3D effect (15% chance, no save)

COPY ~RR/RR_CORE/ITEMS/RR#SILV.ITM~  override
  SAY NAME2 @122 SAY DESC @123


// Plaguebearer (Dagger +3)

COPY ~RR/RR_CORE/BAM/RR#PLAG.BAM~    override

COPY ~RR/RR_CORE/ITEMS/RR#PLAG.ITM~  override
  SAY NAME2 @124 SAY DESC @125 // Plaguebearer

COPY ~RR/RR_CORE/SPELLS/RR#PLAG1.EFF~ override                // Filthy Fever immunity effect (applies to Undead, Constructs, Slimes and Elementals)
  SAY 0x1C @87 // Unaffected by Disease

COPY ~RR/RR_CORE/SPELLS/RR#PLAG1.SPL~ override                // Filthy Fever disease (-2 to DEX and CON)
  SAY NAME1 @717 SAY NAME2 @717 // Filthy Fever

COPY ~RR/RR_CORE/SPELLS/RR#PLAG2.EFF~ override                // Devil Chills immunity effect (applies to Undead, Constructs, Slimes and Elementals)
  SAY 0x1C @87 // Unaffected by Disease

COPY ~RR/RR_CORE/SPELLS/RR#PLAG2.SPL~ override                // Devil Chills disease (-2 to STR + Slow effect)
  SAY NAME1 @718 SAY NAME2 @718 // Devil Chills

COPY ~RR/RR_CORE/SPELLS/RR#PLAG3.EFF~ override                // Mummy Rot immunity effect (applies to Undead, Constructs, Slimes and Elementals)
  SAY 0x1C @87 // Unaffected by Disease

COPY ~RR/RR_CORE/SPELLS/RR#PLAG3.SPL~ override                // Mummy Rot disease (deals 20 points of disease damage, 2 per round)
  SAY NAME1 @719 SAY NAME2 @719 // Mummy Rot




// Keeper of the Law (Wakizashi +2)

COPY ~RR/RR_CORE/BAM/RR#KEEP.BAM~    override
     ~RR/RR_CORE/ITEMS/RR#KEEPH.EFF~ override                // +2 to attack rolls vs. chaotic creatures
     ~RR/RR_CORE/ITEMS/RR#KEEPD.EFF~ override                // +2 bonus to damage rolls vs. chaotic creatures

COPY ~RR/RR_CORE/ITEMS/RR#KEEP.ITM~  override
  SAY NAME2 @126 SAY DESC @127


// Cat's Claw (Ninja-To +2)

COPY ~RR/RR_CORE/BAM/RR#CATC.BAM~    override

COPY ~RR/RR_CORE/ITEMS/RR#CATC.ITM~  override
  SAY NAME2 @128 SAY DESC @129


// Stonesmasher (Club +2)

COPY ~RR/RR_CORE/BAM/RR#STON.BAM~    override
     ~RR/RR_CORE/ITEMS/RR#STONH.EFF~ override                // +2 to attack rolls vs. golems
     ~RR/RR_CORE/ITEMS/RR#STOND.EFF~ override                // +2 bonus to damage rolls vs. golems
     ~RR/RR_CORE/ITEMS/RR#STONA.EFF~ override                // shatters Stone, Clay and Sand Golems into pieces

COPY ~RR/RR_CORE/ITEMS/RR#STON.ITM~  override
  SAY NAME2 @130 SAY DESC @131


// Stalwart Defender (Buckler +1)

COPY ~RR/RR_CORE/BAM/RR#SHL01.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#SHL01.ITM~ override
  SAY NAME2 @132 SAY DESC @133


// Safeguard (Buckler +2)

COPY ~RR/RR_CORE/BAM/RR#SHL02.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#SHL02.ITM~ override
  SAY NAME2 @134 SAY DESC @135


// Masterbelt (Belt)

COPY ~RR/RR_CORE/BAM/RR#BEL01.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#BEL01.ITM~ override
  SAY NAME2 @136 SAY DESC @137


// Tri-Souled Saphire (Ioun Stone)

COPY ~RR/RR_CORE/BAM/RR#HEL01.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#HEL01.ITM~ override
  SAY NAME1 @10002 SAY UNIDENTIFIED_DESC @10003
  SAY NAME2 @138 SAY DESC @139

// Cowl of Acuity

COPY ~RR/RR_CORE/BAM/RR#HEL02.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#HEL02.ITM~ override
  SAY NAME1 @10004 SAY UNIDENTIFIED_DESC @10005
  SAY NAME2 @140 SAY DESC @141

// Greagan's Harp changes

COPY ~RR/RR_CORE/BAM/RR#CGREA.BAM~   override                // Greagan's Harp description icon (CMISC2P.BAM is missing in BG2)
     ~RR/RR_CORE/BAM/RR#HEL02.BAM~   override

COPY_EXISTING ~%tutu_var%MISC2P.ITM~ override                // Greagan's Harp
  SAY NAME2 @142 SAY DESC @143
  WRITE_ASCII 0x58 ~RR#CGREA~ #8                             // use the proper description icon (CMISC2P.BAM is missing in BG2)
  READ_LONG   0x64 "abil_off"
  READ_SHORT  0x68 "abil_num"
  READ_LONG   0x6a "fx_off"
  READ_SHORT  0x70 "fx_num"
  FOR (index = 0 ; index < abil_num ; index = index + 1) BEGIN                    // look for magical ability header
    WRITE_BYTE  ("%abil_off%" + 0x17 + ("%index%" * 0x38)) 4                      // school: enchanter
    WRITE_BYTE  ("%abil_off%" + 0x19 + ("%index%" * 0x38)) 11                     // secondary type: disabling
    WRITE_SHORT ("%abil_off%" + 0x22 + ("%index%" * 0x38)) 3                      // charges: 3
    WRITE_BYTE  ("%abil_off%" + 0x24 + ("%index%" * 0x38)) 3                      // charge removal: per day
    WRITE_BYTE  ("%abil_off%" + 0x27 + ("%index%" * 0x38)) 8                      // item recharges: after rest
    READ_SHORT  ("%abil_off%" + 0x1e + ("%index%" * 0x38)) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + ("%index%" * 0x38)) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        ("%index2%" * 0x30)) "opcode"
      READ_BYTE  ("%fx_off%" + 0x0c + ("%index2%" * 0x30)) "timing"
      PATCH_IF ("%opcode%" = 5) BEGIN                                             // effect: #5 (charm specific creature)
        WRITE_SHORT ("%fx_off%" + 0x08 + ("%index2%" * 0x30)) 0                   // param2: 0 (charmed, target neutral after effect ends)
        WRITE_SHORT ("%fx_off%" + 0x0e + ("%index2%" * 0x30)) 48                  // duration: 48 seconds (8 rounds)
      END
      PATCH_IF ("%opcode%" = 142) BEGIN                                           // effect: #142 (display special effect icon)
        WRITE_SHORT ("%fx_off%" + 0x0e + ("%index2%" * 0x30)) 48                  // duration: 48 seconds (8 rounds)
      END
      PATCH_IF ("%opcode%" = 174 AND "timing" = 4) BEGIN                          // effect: #174 (play sound effect) and timing mode 4 (delayed)
        WRITE_SHORT ("%fx_off%" + 0x0e + ("%index2%" * 0x30)) 48                  // duration: 48 seconds (8 rounds)
      END
      PATCH_IF ("%opcode%" = 141) BEGIN                                           // effect: #141 (lighting effects)
        WRITE_SHORT ("%fx_off%" + ("%index2%" * 0x30)) 215                        // use effect #215 (play 3D effect) instead
        WRITE_SHORT ("%fx_off%" + 0x04 + ("%index2%" * 0x30)) 0                   // param1: 0
        WRITE_SHORT ("%fx_off%" + 0x08 + ("%index2%" * 0x30)) 1                   // param2: 1 (effect plays over target)
        WRITE_BYTE  ("%fx_off%" + 0x0c + ("%index2%" * 0x30)) 0                   // timing mode: duration
        WRITE_SHORT ("%fx_off%" + 0x0e + ("%index2%" * 0x30)) 1                   // duration: 1 second
        WRITE_ASCII ("%fx_off%" + 0x14 + ("%index2%" * 0x30)) ~SPNWCHRM~ #8       // resref: SPNWCHRM (charm vfx)
      END
    END
  END
BUT_ONLY


// Harp of Descant

COPY ~RR/RR_CORE/BAM/RR#HRP01.BAM~      override

COPY ~RR/RR_CORE/ITEMS/RR#HRP01.ITM~    override
  SAY NAME1 @10000 SAY UNIDENTIFIED_DESC @10001
  SAY NAME2 @144 SAY DESC @145
  READ_LONG 0x64 abil_off
  READ_SHORT 0x68 abil_num
  READ_LONG 0x6a fx_off
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 3) BEGIN                                               // only patch the magical ability header (3)
      READ_SHORT (%abil_off% + %i% * 0x38 + 0x1e) abil_fx_num
      READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) abil_fx_idx
      FOR (k = %abil_fx_idx%; k < "%abil_fx_idx%" + "%abil_fx_num%"; k += 1) BEGIN
        READ_SHORT (%fx_off% + %k% * 0x30) opcode
        READ_LONG  (%fx_off% + %k% * 0x30 + 0x04) param1
        PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 18863)) BEGIN               // effect #139: display string - "Enchantment Dispelled"
          SAY (%fx_off% + %k% * 0x30 + 0x04) @80                                   // Confusion Effect Dispelled
        END
      END
    END
  END



// The Weary Cudgel (Club +1)

COPY ~RR/RR_CORE/BAM/RR#WEAR.BAM~      override

COPY ~RR/RR_CORE/ITEMS/RR#WEAR.SPL~    override                                    // a custom fatigue causing spell (cast on hit)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 61410)) BEGIN            // if the opcode is #139 (display string) and param1 is 61410 (Fatigued)
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @712  // replace the existing string with @712 (Fatigue accumulation)
      END
    END
  END

COPY ~RR/RR_CORE/ITEMS/RR#WEAR.EFF~  override               // Immunity to the custom fatigue causing spell (used for undead, constructs, slimes and elementals)

COPY ~RR/RR_CORE/ITEMS/RR#WEAR.ITM~  override               // The Weary Cudgel item file
  SAY NAME2 @148 SAY DESC @149


// PnP Composite Shortbow (grants +1 damage, requires 16 strength)

COPY ~RR/RR_CORE/BAM/RR#BOW02.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#BOW02.ITM~ override
  SAY NAME2 @150 SAY DESC @151


// PnP Composite Shortbow +1 (grants +2 damage, requires 16 strength)

COPY ~RR/RR_CORE/BAM/RR#BOW03.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#BOW03.ITM~ override
  SAY NAME2 @152 SAY DESC @153


// PnP Composite Shortbow +2 (grants +3 damage, requires 16 strength)

COPY ~RR/RR_CORE/BAM/RR#BOW04.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#BOW04.ITM~ override
  SAY NAME2 @154 SAY DESC @155


// PnP Composite Shortbow +3 (grants +4 damage, requires 16 strength)

COPY ~RR/RR_CORE/BAM/RR#BOW05.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#BOW05.ITM~ override
  SAY NAME2 @156 SAY DESC @157

// Sparkburst (Composite Shortbow +2)

COPY ~RR/RR_CORE/BAM/RR#BOW06.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#BOW06.ITM~ override
  SAY NAME2 @112 SAY DESC @113


// Darkveil (thieves' hood which grants immunity to gaze attacks)

COPY ~RR/RR_CORE/BAM/RR#HEL03.BAM~   override
     ~RR/RR_CORE/ITEMS/RR#HEL3A.EFF~ override               // 2 point THAC0 penalty vs. Umber Hulks
     ~RR/RR_CORE/ITEMS/RR#HEL3B.EFF~ override               // 2 point THAC0 penalty vs. Vampires
     ~RR/RR_CORE/ITEMS/RR#HEL3C.EFF~ override               // 2 point THAC0 penalty vs. Basilisks
     ~RR/RR_CORE/ITEMS/RR#HEL3D.EFF~ override               // 2 point THAC0 penalty vs. Tanar'ri

COPY ~RR/RR_CORE/ITEMS/RR#HEL03.ITM~ override
  SAY NAME1 @10004 SAY UNIDENTIFIED_DESC @10005
  SAY NAME2 @158 SAY DESC @159


// Fragment of Enlightment (Ioun Stone, grants +20 to Lore)

COPY ~RR/RR_CORE/BAM/RR#HEL04.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#HEL04.ITM~ override
  SAY NAME1 @10002 SAY UNIDENTIFIED_DESC @10003
  SAY NAME2 @118 SAY DESC @119


// PnP Deep Red Ioun Stone (grants +1 to Dexterity)

COPY ~RR/RR_CORE/BAM/RR#HEL05.BAM~   override

COPY ~RR/RR_CORE/ITEMS/RR#HEL05.ITM~ override
  SAY NAME1 @10002 SAY UNIDENTIFIED_DESC @10003
  SAY NAME2 @116 SAY DESC @117


// Sap (PnP non-lethal weapon)

COPY ~RR/RR_CORE/BAM/RR#SAP01.BAM~   override
     ~RR/RR_CORE/BAM/RR#SAPC.BAM~    override                // item description icon (sketch drawing)

COPY ~RR/RR_CORE/ITEMS/RR#SAP01.ITM~ override
  SAY NAME1 @114 SAY NAME2 @114 SAY UNIDENTIFIED_DESC @115 SAY DESC @115


// Erephine's round buckler animations check
// Should now automatically detect 1PP v2.6 and higher as well as the main component of Item Revisions

ACTION_IF (MOD_IS_INSTALLED 1PP.TP2 7 OR MOD_IS_INSTALLED ITEM_REV.TP2 0 OR FILE_MD5 ~override/wqld1g1.bam~ e1322a2c948b8997fe182603d6284f4a) BEGIN // Checks for 1PP v2.6+ and/or Item Revisions as well as the 1PP D1 standalone archive via MD5 checksum
  COPY_EXISTING ~RR#BUC01.ITM~ override                               // Fading Glory
                ~RR#BUC02.ITM~ override                               // Buckler +1
                ~RR#BUC03.ITM~ override                               // Buckler +2
                ~RR#BUC04.ITM~ override                               // Buckler +3
                ~RR#SHL01.ITM~ override                               // Stalwart Defender
                ~RR#SHL02.ITM~ override                               // Safeguard
                ~RR#RWARD.ITM~ override                               // Rogue's Ward
                ~RR#LYRE.ITM~  override                               // Lyre of Progression
      ~%tutu_var%SHLD20.ITM~   override                               // Kiel's Buckler
    WRITE_ASCII 0x22 ~D1~ #2                                          // Set the animation to round buckler (D1)
  BUT_ONLY
END

// Make the RR ioun stones use WoRm's animations if they are present

ACTION_IF FILE_EXISTS_IN_GAME ~ion1bz.bam~ BEGIN                              // Checks for WoRm's Ioun Stone animations (used by IR and CA)
  COPY_EXISTING ~RR#HEL01.ITM~ override                                          // Tri-Souled Sapphire
    PATCH_FOR_EACH resource IN
                   ION1W                                                           // resref: ION1W (white ioun stone animation part 1)
                   ION2W                                                           // resref: ION2W (white ioun stone animation part 2)
    BEGIN
      LPF add_item_onequip_animation
        STR_VAR
          resource
      END
    END
  BUT_ONLY

  COPY_EXISTING ~RR#HEL04.ITM~ override                                          // Fragment of Enlightment
    PATCH_FOR_EACH resource IN
                   ION1BZ                                                          // resref: ION1BZ (dim blue ioun stone animation part 1)
                   ION2BZ                                                          // resref: ION2BZ (dim blue ioun stone animation part 2)
    BEGIN
      LPF add_item_onequip_animation
        STR_VAR
          resource
      END
    END
  BUT_ONLY

  COPY_EXISTING ~RR#HEL05.ITM~ override                                          // Deep Red Ioun Stone
    PATCH_FOR_EACH resource IN
                   ION1R                                                           // resref: ION1R (red ioun stone animation part 1)
                   ION2R                                                           // resref: ION2R (red ioun stone animation part 2)
    BEGIN
      LPF add_item_onequip_animation
        STR_VAR
          resource
      END
    END
  BUT_ONLY
END


// Add items to BG1 stores for Tutu and BGT


// Taerom's store, Bergost smithy

ACTION_FOR_EACH ~file~ IN
                ~%tutu_var%TAERUM~                                                        // Taerom's store, Bergost smithy (BGT & TuTu only)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#SAP01~ AFTER  ~%tutu_var%BLUN01~ #0 #0 #0 ~IDENTIFIED~ #3      // Adds 3x Sap
        ADD_STORE_ITEM ~RR#BUC02~ AFTER  ~%tutu_var%SHLD10~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Buckler +1
        ADD_STORE_ITEM ~RR#SHL01~ AFTER          ~RR#BUC02~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Stalwart Defender
        ADD_STORE_ITEM ~RR#BEL01~ AFTER  ~%tutu_var%LEAT08~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Masterbelt
        ADD_STORE_ITEM ~RR#BOW02~ AFTER  ~%tutu_var%BOW06~  #0 #0 #0 ~IDENTIFIED~ #3      // Adds 3x Composite Short Bow
        ADD_STORE_ITEM ~RR#BOW03~ AFTER         ~RR#BOW02~  #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Composite Short Bow +1
        ADD_STORE_ITEM ~RR#WEAR~  AFTER          ~RR#SAP01~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x The Weary Cudgel
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Black Lily's store

ACTION_FOR_EACH ~file~ IN
                ~STOBLACK~                                                                // Black Lily's store (BGT)
                ~_TOBLACK~                                                                // Black Lily's store (Tutu)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#BOW02~ AFTER  ~%tutu_var%SLNG02~ #0 #0 #0 ~IDENTIFIED~ #3      // Adds 3x Composite Short Bow
        ADD_STORE_ITEM ~RR#BOW03~ AFTER          ~RR#BOW02~ #0 #0 #0 ~IDENTIFIED~ #2      // Adds 2x Composite Short Bow +1
        ADD_STORE_ITEM ~RR#BOW04~ AFTER          ~RR#BOW03~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Composite Short Bow +2
        ADD_STORE_ITEM ~RR#BOW06~ AFTER          ~RR#BOW04~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Sparkburst
        ADD_STORE_ITEM ~RR#SAP01~ AFTER          ~RR#BOW06~ #0 #0 #0 ~IDENTIFIED~ #6      // Adds 6x Sap
        ADD_STORE_ITEM ~RR#BUC02~ AFTER  ~%tutu_var%CLCK01~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Buckler +1
        ADD_STORE_ITEM ~RR#BUC03~ AFTER          ~RR#BUC02~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Buckler +2
        ADD_STORE_ITEM ~RR#SHL02~ AFTER          ~RR#BUC03~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Safeguard
        ADD_STORE_ITEM ~RR#LYRE~  AFTER          ~RR#SHL02~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Lyre of Progression
        ADD_STORE_ITEM ~RR#HEL02~ AFTER           ~RR#LYRE~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Cowl of Acuity
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// High Hedge store

ACTION_FOR_EACH ~file~ IN
                ~HIGHHEDG~                                                                // High Hedge store (BGT)
                ~_IGHHEDG~                                                                // High Hedge store (Tutu)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#HEL04~ BEFORE           ~MISC73~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Fragment of Enlightenment
        ADD_STORE_ITEM ~RR#HEL05~ AFTER          ~RR#HEL04~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Deep Red Ioun Stone
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Ulgoth's Beard store

ACTION_FOR_EACH ~file~ IN
                ~%tutu_var%ULGOTH~                                                        // Ulgoth's Beard store (BGT & Tutu only)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#SAP01~ AFTER  ~%tutu_var%BLUN01~ #0 #0 #0 ~IDENTIFIED~ #3      // Adds 3x Sap
        ADD_STORE_ITEM ~RR#BOW02~ AFTER   ~%tutu_var%BOW05~ #0 #0 #0 ~IDENTIFIED~ #3      // Adds 3x Composite Short Bow
        ADD_STORE_ITEM ~RR#BOW03~ AFTER          ~RR#BOW02~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Composite Short Bow +1
        ADD_STORE_ITEM ~RR#BOW04~ AFTER          ~RR#BOW03~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Composite Short Bow +2
        ADD_STORE_ITEM ~RR#FDART~ AFTER  ~%tutu_var%DART03~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Returning Frost Dart
        ADD_STORE_ITEM ~RR#BUC02~ AFTER  ~%tutu_var%PLAT01~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Buckler +1
        ADD_STORE_ITEM ~RR#BUC03~ AFTER          ~RR#BUC02~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Buckler +2
        ADD_STORE_ITEM ~RR#BUC01~ AFTER          ~RR#BUC03~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Fading Glory
        ADD_STORE_ITEM                 + ~%tutu_var%MISC2P~ #3 #0 #0 ~IDENTIFIED~ #1      // Gives correct (per day) number of charges to Greagan's Harp
        ADD_STORE_ITEM ~RR#HRP01~ AFTER  ~%tutu_var%MISC2P~ #3 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Harp of Descant
        ADD_STORE_ITEM ~RR#HEL03~ AFTER          ~RR#HRP01~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Darkveil
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add Composite Short Bows to BG2 stores which carry regular Short Bows (BG2/ToB only)

ACTION_FOR_EACH ~file~ IN
                ~AMBAR01~                                                                 // The Zephir (Amkethran Innkeeper)
                ~BERNARD~                                                                 // Copper Coronet
                ~BERNARD2~                                                                // Copper Coronet
                ~BSHOP01~                                                                 // Cutpurse (Bridge District halfling fence)
                ~BSHOP02~                                                                 // Merchant (Bridge District Female Elf Fence)
                ~DMARK~                                                                   // Fovem (Docks District fence)
                ~DSHOP01~                                                                 // Ikert (Docks District merchant)
                ~GORCH~                                                                   // Gorch (Mae'Var's Guildhall fence)
                ~JAYES~                                                                   // Jayes (Waukeen's Promenade fence)
                ~MERCHANT~                                                                // Bel Dalemark (Waukeen's Promenade merchant)
                ~RIBALD~                                                                  // Adventurers' Mart (regular stock)
                ~SARBAR01~                                                                // Saradush Innkeeper
                ~SHOP01~                                                                  // Mira (Waukeen's Promenade merchant)
                ~SHOP05~                                                                  // Perter (Waukeen's Promenade fletcher)
                ~SHOP06~                                                                  // Hes (Waukeen's Promenade merchant)
                ~SHOP07~                                                                  // Storekeep (Waukeen's Promenade merchant)
                ~SHTHSTOR~                                                                // Rettel the Fence (Shadow Thief Guildhall)
                ~SLSHOP01~                                                                // Black Market Thief (Slums Halfling)
                ~SLSHOP02~                                                                // Black Market Thief (Slums female Half-Orc)
                ~TRCAR04~                                                                 // Trademeet merchant
                ~TRMER01~                                                                 // Trademeet merchant
                ~UDDROW23~                                                                // Drow Merchant (Ust Natha)
                ~UHMER01~                                                                 // Umar Hills Merchant
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#BOW02~ AFTER   ~BOW05~ #0 #0 #0 ~IDENTIFIED~ #1                // Adds 1x Composite Short Bow
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add Composite Short Bows to BG1 stores which carry regular Short Bows (Tutu/BGT only)
// Note: this needs to be a separate block in order to prevent %tutu_var% from messing up prerequisite item names in BG2 stores

ACTION_FOR_EACH ~file~ IN
                ~%tutu_var%FRIEND~                                                        // The Friendly Arm
                ~%tutu_var%INN2616~                                                       // Candlekeep Inn
                ~%tutu_var%INN3304~                                                       // Jovial Juggler
                ~%tutu_var%STO4803~                                                       // Nashkel Store
                ~%tutu_var%STO4909~                                                       // Carnival Shop
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#BOW02~ AFTER   ~%tutu_var%BOW05~ #0 #0 #0 ~IDENTIFIED~ #1      // Adds 1x Composite Short Bow
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add Composite Short Bows +1 to BG2 stores which carry regular Short Bows +1 (BG2 and ToB only)

ACTION_FOR_EACH ~file~ IN
                ~AMSMUG01~                                                                // Amkethran Smugglers
                ~AMSMUG02~                                                                // Amkethran Smugglers
                ~ARLED~                                                                   // Shadow Thief Fence (Arledrian)
                ~BSHOP01~                                                                 // Cutpurse (Bridge District halfling fence)
                ~PPSTOR01~                                                                // Brynlaw merchant
                ~RIBALD~                                                                  // Adventurers' Mart (regular stock)
                ~SARBAR01~                                                                // Saradush Innkeeper
                ~TRCAR04~                                                                 // Trademeet merchant
                ~TRGENI01~                                                                // Khan Zahraa (Trademeet Genie)
                ~TRMER02~                                                                 // Trademeet merchant
                ~TRMER04~                                                                 // Trademeet blacksmith
                ~TRTHF02~                                                                 // Kich (Trademeet fence)
                ~UDDUER02~                                                                // Duergar Merchant (Underdark)
                ~UDSVIR05~                                                                // Svirfneblin General Store (Underdark)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#BOW03~ AFTER   ~BOW06~ #0 #0 #0 ~IDENTIFIED~ #1                // Adds 1x Composite Short Bow +1
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add Composite Short Bows +2 to BG2 stores which carry regular Short Bows +2 (BG2 and ToB only)

ACTION_FOR_EACH ~file~ IN
                ~GORCH~                                                                  // Gorch (Mae'Var's Guildhall fence)
                ~HGKAR01~                                                                // Karthis al-Hezzar (ToB merchant on the meadow in front of Saradush)
                ~JAYES~                                                                  // Jayes (Waukeen's Promenade fence)
                ~RIBALD~                                                                 // Adventurers' Mart (regular stock)
                ~RIBALD3~                                                                // Adventurers' Mart (special stock)
                ~SARBAR01~                                                               // Saradush Innkeeper
                ~SLSHOP01~                                                               // Black Market Thief (Slums Halfling)
                ~TRMER02~                                                                // Trademeet merchant
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================

        ADD_STORE_ITEM ~RR#BOW04~ AFTER   ~BOW18~ #0 #0 #0 ~IDENTIFIED~ #1               // Adds 1x Composite Short Bow +2
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add Composite Short Bows +3 to BG2 stores which carry regular Short Bows +3 (BG2 and ToB only)

ACTION_FOR_EACH ~file~ IN
                ~AMSMUG01~                                                               // Amkethran Smugglers
                ~AMSMUG02~                                                               // Amkethran Smugglers
                ~HGKAR01~                                                                // Karthis al-Hezzar (ToB merchant on the meadow in front of Saradush)
                ~SARBAR01~                                                               // Saradush Innkeeper
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#BOW05~ AFTER   ~BOW26~ #0 #0 #0 ~IDENTIFIED~ #1               // Adds 1x Composite Short Bow +3
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add a Sap to most fences (BG2/ToB only)

ACTION_FOR_EACH ~file~ IN
                ~AMSMUG01~                                                              // Amkethran Smugglers
                ~AMSMUG02~                                                              // Amkethran Smugglers
                ~ARLED~                                                                 // Shadow Thief Fence (Arledrian)
                ~BSHOP01~                                                               // Cutpurse (Bridge District halfling fence)
                ~BSHOP02~                                                               // Merchant (Bridge District Female Elf Fence)
                ~DMARK~                                                                 // Fovem (Docks District fence)
                ~GORCH~                                                                 // Gorch (Mae'Var's Guildhall fence)
                ~JAYES~                                                                 // Jayes (Waukeen's Promenade fence)
                ~SHTHSTOR~                                                              // Rettel the Fence (Shadow Thief Guildhall)
                ~SLSHOP01~                                                              // Black Market Thief (Slums Halfling)
                ~SLSHOP02~                                                              // Black Market Thief (Slums female Half-Orc)
                ~TRTHF02~                                                               // Kich (Trademeet fence)
                ~UDDUER02~                                                              // Duergar Merchant (Underdark)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        PATCH_IF NOT FILE_CONTAINS_EVALUATED (~%SOURCE_FILE%~ ~BLUN01~) BEGIN            // if the store has no Clubs for sale
          ADD_STORE_ITEM ~BLUN01~ FIRST #0 #0 #0 ~IDENTIFIED~ #1                         // Add 1x Club
        END
        ADD_STORE_ITEM ~RR#SAP01~ AFTER ~BLUN01~ #0 #0 #0 ~IDENTIFIED~ #1                // Add 1x Sap
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add a Sap to most fences (Tutu/BGT only)
// Note: this needs to be a separate block in order to prevent %tutu_var% from messing up prerequisite item names in BG2 stores

ACTION_FOR_EACH ~file~ IN
                ~%tutu_var%INN2616~                                                      // Candlekeep Inn
                ~_TOSILEN~                                                               // Shop of Silence (Tutu version)
                ~STOSILEN~                                                               // Shop of Silence (BGT version)
                ~%tutu_var%ERDANE~                                                       // Erdane's store
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        PATCH_IF NOT FILE_CONTAINS_EVALUATED (~%SOURCE_FILE%~ ~BLUN01~) BEGIN            // if the store has no Clubs for sale
          ADD_STORE_ITEM ~%tutu_var%BLUN01~ FIRST #0 #0 #0 ~IDENTIFIED~ #1               // Add 1x Club
        END
        ADD_STORE_ITEM ~RR#SAP01~ AFTER  ~%tutu_var%BLUN01~ #0 #0 #0 ~IDENTIFIED~ #1     // Add 1x Sap
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add Bucklers +1 to BG2 stores which carry Small Shields +1 (BG2 and ToB only)

ACTION_FOR_EACH ~file~ IN
                ~BERNARD~                                                                // Copper Coronet
                ~BERNARD2~                                                               // Copper Coronet
                ~PPSTOR01~                                                               // Brynlaw merchant
                ~RIBALD~                                                                 // Adventurers' Mart (regular stock)
                ~SARBAR01~                                                               // Saradush Innkeeper
                ~SHOP02~                                                                 // Arnolinus (Waukeen's Promenade armorer)
                ~TRMER02~                                                                // Trademeet merchant
                ~TRMER04~                                                                // Trademeet blacksmith
                ~TRTHF02~                                                                // Kich (Trademeet fence)
                ~UDDUER02~                                                               // Duergar Merchant (Underdark)
                ~UDSVIR05~                                                               // Svirfneblin General Store (Underdark)
                ~UHMER03~                                                                // Umar Hills Merchant
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#BUC02~ BEFORE ~SHLD02~ #0 #0 #0 ~IDENTIFIED~ #1               // Adds 1x Buckler +1
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add Bucklers +2 to BG2 stores which carry Small Shields +2 (BG2 and ToB only)

ACTION_FOR_EACH ~file~ IN
                ~JAYES~                                                                  // Jayes (Waukeen's Promenade fence)
                ~PPSTOR01~                                                               // Brynlaw merchant
                ~RIBALD3~                                                                // Adventurers' Mart (special stock)
                ~SARBAR01~                                                               // Saradush Innkeeper
                ~SHOP02~                                                                 // Arnolinus (Waukeen's Promenade armorer)
                ~TRMER02~                                                                // Trademeet merchant
                ~TRTHF02~                                                                // Kich (Trademeet fence)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        PATCH_IF NOT FILE_CONTAINS_EVALUATED (~%SOURCE_FILE%~ ~RR#BUC02~) BEGIN          // if the store has no Buckler +1 for sale
         ADD_STORE_ITEM ~RR#BUC02~ BEFORE ~SHLD28~ #0 #0 #0 ~IDENTIFIED~ #1              // Adds 1x Buckler +1
        END
        ADD_STORE_ITEM ~RR#BUC03~ AFTER ~RR#BUC02~ #0 #0 #0 ~IDENTIFIED~ #1              // Adds 1x Buckler +2
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Add Bucklers +3 to Ribald's special stock and Saradush Inn

ACTION_FOR_EACH ~file~ IN
                ~RIBALD3~                                                                 // Adventurers' Mart (special stock)
                ~SARBAR01~                                                                // Saradush Innkeeper
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.sto~ BEGIN
    COPY_EXISTING ~%file%.sto~ override
      PATCH_IF (%SOURCE_SIZE% > 0x9b) BEGIN
      // ===============================================================================
        ADD_STORE_ITEM ~RR#BUC04~ AFTER ~RR#BUC03~ #0 #0 #0 ~IDENTIFIED~ #1               // Adds 1x Buckler +3
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Classic Adventures compatibility block

ACTION_IF GAME_IS ~ca~ BEGIN                                                   // checks for Classic Adventures

COPY_EXISTING ~TCMER02.STO~ override                                           // Add items to Rurik's Oakhurst store
 ADD_STORE_ITEM ~RR#BOW02~ AFTER             ~BOW05~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Composite Short Bow

COPY_EXISTING ~TRMER02.STO~ override                                           // Add items to Saltmarsh merchant's store
 ADD_STORE_ITEM ~SHLD17~ AFTER              ~SHLD10~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Buckler +1
 ADD_STORE_ITEM ~RR#BEL01~ BEFORE           ~BELT10~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Masterbelt

COPY_EXISTING ~TRMER04.STO~ override                                           // Add items to Rurik's Saltmarsh store
 ADD_STORE_ITEM ~RR#BOW02~ AFTER             ~BOW06~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Composite Short Bow
 ADD_STORE_ITEM ~RR#BOW03~ AFTER          ~RR#BOW02~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Composite Short Bow +1

COPY_EXISTING ~TCMER04.STO~ override                                           // Add items to Fielding's Magic Shoppe
 ADD_STORE_ITEM ~RR#HEL04~ AFTER            ~CLCK14~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Fragment of Enlightenment

COPY_EXISTING ~TC2008.STO~ override                                            // Add items to Suderham merchant's store
 ADD_STORE_ITEM ~RR#BUC02~ AFTER            ~SHLD10~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Buckler +1
 ADD_STORE_ITEM ~RR#BUC03~ AFTER          ~RR#BUC02~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Buckler +2
 ADD_STORE_ITEM ~RR#BOW02~ AFTER             ~BOW06~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Composite Short Bow
 ADD_STORE_ITEM ~RR#BOW03~ AFTER          ~RR#BOW02~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Composite Short Bow +1
 ADD_STORE_ITEM ~RR#BOW04~ AFTER          ~RR#BOW03~ #0 #0 #0 ~IDENTIFIED~ #1  // Adds 1x Composite Short Bow +2

COPY_EXISTING ~TC0071.ARE~ override                                            // Guard tower (Lizardmen swamp)
  SPRINT ~item_to_add~ ~RR#WEAR~                                               // item to be added (The Weary Cudgel)
  SET container_to_add_to = "1"                                                // container number (Container 1)
  SPRINT ~flags~ ~NONE~                                                        // item flags: NONE
  SET charges1 = "1"                                                           // stock/first magical ability charges
  SET charges2 = "0"                                                           // second magical ability charges
  SET charges3 = "0"                                                           // third magical ability charges
  LAUNCH_PATCH_MACRO ~ADD_AREA_ITEM~

COPY_EXISTING ~TC0082.ARE~ override                                            // Sahuagin lair (prism level)
  SPRINT ~old_item~ ~SHLD17~                                                   // old item (Buckler +1)
  SPRINT ~new_item~ ~RR#SHL01~                                                 // new item (Stalwart Defender)
  SPRINT ~flags~ ~NONE~                                                        // item flags: NONE
  SET charges1 = "1"                                                           // stock/first magical ability charges
  SET charges2 = "0"                                                           // second magical ability charges
  SET charges3 = "0"                                                           // third magical ability charges
  LAUNCH_PATCH_MACRO ~REPLACE_AREA_ITEM~

COPY_EXISTING ~MM0215.ARE~ override                                            // Mistmoor mannor (Vault)
  SPRINT ~item_to_add~ ~RR#FDART~                                              // item to be added (Returning Frost Dart)
  SET container_to_add_to = "2"                                                // container number (Pile1)
  SPRINT ~flags~ ~NONE~                                                        // item flags: NONE
  SET charges1 = "1"                                                           // stock/first magical ability charges
  SET charges2 = "0"                                                           // second magical ability charges
  SET charges3 = "0"                                                           // third magical ability charges
  LAUNCH_PATCH_MACRO ~ADD_AREA_ITEM~

COPY_EXISTING ~TC1103.ARE~ override                                            // Temple near Westgate, level 2
  SPRINT ~item_to_add~ ~RR#BUC01~                                              // item to be added (Fading Glory)
  SET container_to_add_to = "1"                                                // container number (Shield Pile)
  SPRINT ~flags~ ~NONE~                                                        // item flags: NONE
  SET charges1 = "1"                                                           // stock/first magical ability charges
  SET charges2 = "0"                                                           // second magical ability charges
  SET charges3 = "0"                                                           // third magical ability charges
  LAUNCH_PATCH_MACRO ~ADD_AREA_ITEM~

COPY_EXISTING ~TC1206.ARE~ override                                            // Slaver Fortress, level 3
  SPRINT ~item_to_add~ ~RR#KEEP~                                               // item to be added (Keeper of the Law)
  SET container_to_add_to = "3"                                                // container number (Treasure Table 3)
  SPRINT ~flags~ ~NONE~                                                        // item flags: NONE
  SET charges1 = "1"                                                           // stock/first magical ability charges
  SET charges2 = "2"                                                           // second magical ability charges
  SET charges3 = "0"                                                           // third magical ability charges
  LAUNCH_PATCH_MACRO ~ADD_AREA_ITEM~

END                                                                            // ends check for Classic Adventures


///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Upgradeable Equipment
///////////////////////////////////////////////////////////////////////

// *** For fellow modders *** this component can be detected by searching for the following file - RR#BUC11.ITM


BEGIN @18 DESIGNATED 8
REQUIRE_PREDICATE GAME_IS ~tob bgt bg2ee~ @902

LAUNCH_ACTION_MACRO ~RR#AFIX~


COPY ~RR/RR_UPGR/ITEMS/RR#BUC11.ITM~  override               // Blazing Glory (Fading Glory upgrade)
  SAY NAME2 @5000 SAY DESC @5001

COPY ~RR/RR_UPGR/BAM/RR#BUC11.BAM~    override               // Blazing Glory icon
     ~RR/RR_UPGR/SPELLS/RR#BUC11.SPL~ override               // Blazing Glory anti-undead main spell (affects only undead thanks to EFF targeting)
     ~RR/RR_UPGR/SPELLS/RR#BUC1G.EFF~ override               // Deals 2d4 points of dire damage
     ~RR/RR_UPGR/SPELLS/RR#BUC1H.EFF~ override               // Blinds target for 24 seconds
     ~RR/RR_UPGR/SPELLS/RR#BUC1I.EFF~ override               // Displays the "Blinded" icon for 24 seconds

COPY ~RR/RR_CYRIC/ITEMS/RR#SCAXE.EFF~ override               // Stormcharged Axe stun effect immunity (for Constructs, Undead, Slimes...)
     ~RR/RR_CYRIC/ITEMS/RR#SCAXE.SPL~ override               // Stormcharged Axe stun effect

COPY ~RR/RR_UPGR/ITEMS/RR#SCAX2.ITM~  override               // Stormcharged Axe +5
  SAY NAME2 @5006 SAY DESC @5007

COPY ~RR/RR_UPGR/SPELLS/RR#SCAX2.SPL~ override               // Static Discharge spell
  SAY NAME1 @5018 SAY NAME2 @5018

COPY ~RR/RR_UPGR/BAM/RR#LAPIS.BAM~    override               // Lapis Lazuli icon

COPY ~RR/RR_UPGR/ITEMS/RR#LAPIS.ITM~  override               // Lapis Lazuli (used as a component for upgrading the Stormcharged Axe)
  SAY NAME2 @5016 SAY DESC @5017

EXTEND_BOTTOM ~AR6003.BCS~ ~RR/RR_UPGR/COMPILE/AR6003.BAF~   // Add 1x Lapis Lazuli to Abazigal's Lair (near Iycanth the Mad)

COPY ~RR/RR_UPGR/ITEMS/RR#SSOB.ITM~   override               // Short Sword of Backstabbing +5
  SAY NAME2 @5008 SAY DESC @5009

COPY ~RR/RR_CORE/ITEMS/RR#SSOBB.EFF~  override               // SSoB backstab bonus
     ~RR/RR_UPGR/ITEMS/RR#SSOBC.EFF~  override               // SSoB critical hit bonus

COPY ~RR/RR_UPGR/ITEMS/RR#BEL11.ITM~  override               // Masterbelt of Fortune
  SAY NAME2 @5010 SAY DESC @5011

COPY ~RR/RR_UPGR/ITEMS/RR#FDAR2.ITM~  override               // Returning Frost Dart +3
  SAY NAME2 @5012 SAY DESC @5013

COPY ~RR/RR_UPGR/ITEMS/RR#STON2.ITM~  override               // Stonesmasher +3
  SAY NAME2 @5025 SAY DESC @5026

COPY ~RR/RR_UPGR/ITEMS/RR#STON3.ITM~  override               // Stonesmasher +4
  SAY NAME2 @5014 SAY DESC @5015

COPY ~RR/RR_UPGR/ITEMS/RR#KEEP2.ITM~  override               // Keeper of the Law +3
  SAY NAME2 @5019 SAY DESC @5020

COPY ~RR/RR_UPGR/ITEMS/RR#WEAR2.ITM~  override               // The Weary Cudgel +3
  SAY NAME2 @5021 SAY DESC @5022

COPY ~RR/RR_UPGR/ITEMS/RR#RWAR2.ITM~  override               // Rogue's Ward +3
  SAY NAME2 @5023 SAY DESC @5024



// Cromwell's upgrade dialogue additions (note: upgrade dialogues must be compiled in serial so that COPY_TRANS can work properly)

COMPILE ~RR/RR_UPGR/COMPILE/RR#CRM01.D~                             // Fading Glory upgrade
COMPILE ~RR/RR_UPGR/COMPILE/RR#CRM02.D~                             // Returning Frost Dart upgrade
COMPILE ~RR/RR_UPGR/COMPILE/RR#CRM03.D~                             // Keeper of the Law upgrade
COMPILE ~RR/RR_UPGR/COMPILE/RR#CRM04.D~                             // The Weary Cudgel upgrade
COMPILE ~RR/RR_UPGR/COMPILE/RR#CRM05.D~                             // Rogue's Ward upgrade
COMPILE ~RR/RR_UPGR/COMPILE/RR#CRM06.D~                             // Stonesmasher upgrade (to +3 version)

EXTEND_BOTTOM ~AR0334.BCS~ ~RR/RR_UPGR/COMPILE/AR0334.BAF~          // additions for Cromwell's item forging script


// Cespenars's upgrade dialogue additions (note: upgrade dialogues must be compiled in serial so that COPY_TRANS can work properly)

COMPILE ~RR/RR_UPGR/COMPILE/RR#CSP01.D~                             // Masterbelt upgrade
COMPILE ~RR/RR_UPGR/COMPILE/RR#CSP02.D~                             // Stomesmasher upgrade
COMPILE ~RR/RR_UPGR/COMPILE/RR#CSP03.D~                             // Stormcharged Axe upgrade
COMPILE ~RR/RR_UPGR/COMPILE/RR#CSP04.D~                             // Short Sword of Backstabbing upgrade

EXTEND_BOTTOM ~BOTSMITH.BCS~ ~RR/RR_UPGR/COMPILE/BOTSMITH.BAF~      // additions for Cespenar's item forging script


// Erephine's round buckler animations check
// Should now automatically detect 1PP v2.6 and higher as well as the main component of Item Revisions
ACTION_IF (MOD_IS_INSTALLED 1PP.TP2 7 OR MOD_IS_INSTALLED ITEM_REV.TP2 0 OR FILE_MD5 ~override/wqld1g1.bam~ e1322a2c948b8997fe182603d6284f4a) BEGIN // Checks for 1PP v2.6+ and/or Item Revisions as well as the 1PP D1 standalone archive via MD5 checksum
  COPY_EXISTING ~RR#BUC11.ITM~ override                               // Blazing Glory
                ~RR#RWAR2.ITM~ override                               // Rogue's Ward +3
    WRITE_ASCII 0x22 ~D1~ #2                                          // Set the animation to round buckler (D1)
  BUT_ONLY
END



///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Revised Thievery
///////////////////////////////////////////////////////////////////////

BEGIN @15 DESIGNATED 9  // Use PnP thievery potions and prevent their effects from stacking
SUBCOMPONENT @8  // Revised Thievery
REQUIRE_PREDICATE ENGINE_IS ~tob bgee bg2ee~ @902

INCLUDE ~RR/LIB/RR#IDTLS.TPH~                                       // Include my custom "Identify Top Level Script" function
INCLUDE ~RR/LIB/RR#THVRY.TPH~                                       // Include the Revised Thievery macro (hosts main code)
LAUNCH_ACTION_MACRO ~RR#AFIX~

// *** For fellow modders *** this subcomponent can be detected by searching for the following file - RR#PNP36.SPL

LAUNCH_ACTION_MACRO ~RR#THVRY~


// New spells which contain the effects for the PnP potions

COPY ~RR/RR_CORE/SPELLS/RR#PNP36.SPL~ override                             // PnP Potion of Master Thievery spell (for non-stacking)
     ~RR/RR_CORE/SPELLS/RR#PNP39.SPL~ override                             // PnP Potion of Perception spell (for non-stacking)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 206) AND ("%param1%" = 14094)) BEGIN                 // display string: "Immunity To Effect"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @72      // Consuming multiple potions of the same type does not grant additional benefits
      END
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 4742)) BEGIN                  // display string: "Spell Ineffective"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @75      // The potion had no effect on you
      END
    END
  END


// Alter Potions of Master Thievery to match their PnP versions and make their effects non-stackable

ACTION_FOR_EACH ~file~ IN
                ~POTN36~                  // Potion of Master Thievery
                ~_POTN36~                 // Potion of Master Thievery (Tutu)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.itm~ BEGIN
    COPY_EXISTING ~%file%.itm~ override
      PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
      // ===============================================================================
        SAY DESC @74                                                                       // PnP Potion of Master Thievery description
        LAUNCH_PATCH_FUNCTION ~DELETE_ITEM_EFFECT~ INT_VAR opcode_to_delete = "-1" header = 1 END   // delete all opcodes in the item's extended header
        LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EFFECT~
          INT_VAR
            opcode = 146                                                                   // effect: #146 (cast spell at creature)
            target = 1                                                                     // target: self
            timing = 1                                                                     // timing: permanent
            parameter1 = 0                                                                 // param1: casting level
            parameter2 = 1                                                                 // param2: cast instantly
            probability1 = 100                                                             // probability1: 100
            insert_point = 0
          STR_VAR resource = ~RR#PNP36~                                                    // resref: (RR#PNP36.SPL)
        END
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Alter Potions of Perception to match their PnP versions and make their effects non-stackable

ACTION_FOR_EACH ~file~ IN
                ~POTN39~                  // Potion of Perception
                ~_POTN39~                 // Potion of Perception (Tutu)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.itm~ BEGIN
    COPY_EXISTING ~%file%.itm~ override
      PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
      // ===============================================================================
        SAY DESC @73                                                                       // PnP Potion of Perception description
        LAUNCH_PATCH_FUNCTION ~DELETE_ITEM_EFFECT~ INT_VAR opcode_to_delete = "-1" header = 1 END   // delete all opcodes in the item's extended header
        LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EFFECT~
          INT_VAR
            opcode = 146                                                                   // effect: #146 (cast spell at creature)
            target = 1                                                                     // target: self
            timing = 1                                                                     // timing: permanent
            parameter1 = 0                                                                 // param1: casting level
            parameter2 = 1                                                                 // param2: cast instantly
            probability1 = 100                                                             // probability1: 100
            insert_point = 0
          STR_VAR resource = ~RR#PNP39~                                                    // resref: (RR#PNP39.SPL)
        END
      // ===============================================================================
      END
    BUT_ONLY
  END
END




// ************************************ Subcomponent marker ***************************************************************************


BEGIN @16 DESIGNATED 10  // Retain default thievery potions and prevent their effects from stacking
SUBCOMPONENT @8  // Revised Thievery

LAUNCH_ACTION_MACRO ~RR#AFIX~

// *** For fellow modders *** this subcomponent can be detected by searching for the following file - RR#PTN36.SPL

INCLUDE ~RR/LIB/RR#IDTLS.TPH~                                                      // Include my custom "Identify Top Level Script" function
INCLUDE ~RR/LIB/RR#THVRY.TPH~                                                      // Include the Revised Thievery macro (hosts main code)
LAUNCH_ACTION_MACRO ~RR#THVRY~


// New spells which contain the effects for the non-stackable thievery potions

COPY ~RR/RR_CORE/SPELLS/RR#PTN36.SPL~ override                             // Potion of Master Thievery spell (for non-stacking)
     ~RR/RR_CORE/SPELLS/RR#PTN39.SPL~ override                             // Potion of Perception spell (for non-stacking)
  READ_LONG  0x64 "abil_off"
  READ_SHORT 0x68 "abil_num"
  READ_LONG  0x6a "fx_off"
  FOR (index = 0 ; index < abil_num ; index = index + 1 ) BEGIN
    READ_SHORT  ("%abil_off%" + 0x1e + (0x28 * "%index%")) "abil_fx_num"
    READ_SHORT  ("%abil_off%" + 0x20 + (0x28 * "%index%")) "abil_fx_idx"
    FOR (index2 = 0 ; index2 < abil_fx_num ; index2 = index2 + 1) BEGIN
      READ_SHORT ("%fx_off%" +        (0x30 * ("%index2%" + "%abil_fx_idx%"))) "opcode"
      READ_LONG  ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) "param1"
      PATCH_IF (("%opcode%" = 206) AND ("%param1%" = 14094)) BEGIN                 // display string: "Immunity To Effect"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @72      // Consuming multiple potions of the same type does not grant additional benefits
      END
      PATCH_IF (("%opcode%" = 139) AND ("%param1%" = 4742)) BEGIN                  // display string: "Spell Ineffective"
        SAY ("%fx_off%" + 0x04 + (0x30 * ("%index2%" + "%abil_fx_idx%"))) @75      // The potion had no effect on you
      END
    END
  END


// Make Potions of Master Thievery non-stackable
ACTION_IF NOT FILE_EXISTS_IN_GAME ~potn36.spl~ BEGIN                          // check for Item Revisions' potion component

ACTION_FOR_EACH ~file~ IN
                ~POTN36~                  // Potion of Master Thievery
                ~_POTN36~                 // Potion of Master Thievery (Tutu)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.itm~ BEGIN
    COPY_EXISTING ~%file%.itm~ override
      PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
      // ===============================================================================
        LAUNCH_PATCH_FUNCTION ~DELETE_ITEM_EFFECT~ INT_VAR opcode_to_delete = "-1" header = 1 END   // delete all opcodes in the item's extended header
        LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EFFECT~
          INT_VAR
            opcode = 146                                                                   // effect: #146 (cast spell at creature)
            target = 1                                                                     // target: self
            timing = 1                                                                     // timing: permanent
            parameter1 = 0                                                                 // param1: casting level
            parameter2 = 1                                                                 // param2: cast instantly
            probability1 = 100                                                             // probability1: 100
            insert_point = 0
          STR_VAR resource = ~RR#PTN36~                                                    // resref: (RR#PTN36.SPL)
        END
      // ===============================================================================
      END
    BUT_ONLY
  END
END


// Make Potions of Perception non-stackable

ACTION_FOR_EACH ~file~ IN
                 ~POTN39~                 // Potion of Perception
                ~_POTN39~                 // Potion of Perception (Tutu)
BEGIN
  ACTION_IF FILE_EXISTS_IN_GAME ~%file%.itm~ BEGIN
    COPY_EXISTING ~%file%.itm~ override
      PATCH_IF (%SOURCE_SIZE% > 0x71) BEGIN
      // ===============================================================================
        LAUNCH_PATCH_FUNCTION ~DELETE_ITEM_EFFECT~ INT_VAR opcode_to_delete = "-1" header = 1 END   // delete all opcodes in the item's extended header
        LAUNCH_PATCH_FUNCTION ~ADD_ITEM_EFFECT~
          INT_VAR
            opcode = 146                                                                   // effect: #146 (cast spell at creature)
            target = 1                                                                     // target: self
            timing = 1                                                                     // timing: permanent
            parameter1 = 0                                                                 // param1: casting level
            parameter2 = 1                                                                 // param2: cast instantly
            probability1 = 100                                                             // probability1: 100
            insert_point = 0
          STR_VAR resource = ~RR#PTN39~                                                    // resref: (RR#PTN39.SPL)
        END
      // ===============================================================================
      END
    BUT_ONLY
  END
END

END                                                                                // end check for Item Revisions' potion component



///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Chosen of Cyric encounter
///////////////////////////////////////////////////////////////////////

// *** For fellow modders *** this component can be detected by searching for the following file - RR#SDEAT.ITM


BEGIN @6 DESIGNATED 11
REQUIRE_PREDICATE GAME_IS ~tob bgt bg2ee~ @902

LAUNCH_ACTION_MACRO ~RR#AFIX~

INCLUDE "rr/lib/ds.tpa"                                                      // Detectable Spells

// CoC area files

COPY ~RR/RR_CYRIC/AREAS/RR#001.ARE~            override                 // The altered City Gates area
APPEND  ~MASTAREA.2DA~  ~RR#001  value~ UNLESS ~RR#001~                      // Adding the new area to the 2DA masterfile

// Modifying AR0800 to include the new CoC ambush triggers (code based on Pro5's Dragon Trigger from the BG1 NPC project, thanks cmorgan and Pro5!)

COPY_EXISTING ~AR0800.ARE~ override                                        // Graveyard district CoC trigger 1 (bottom exit)
    READ_LONG 0x54 "actor_off"
    READ_LONG 0x5c "info_off"
    READ_SHORT 0x5a "info_num"
    READ_LONG 0x60 "spawn_off"
    READ_LONG 0x68 "ent_off"
    READ_LONG 0x70 "cont_off"
    READ_LONG 0x78 "item_off"
    READ_LONG 0x7c "vert_off"
    READ_SHORT 0x80 "vert_num"
    READ_LONG 0x84 "amb_off"
    READ_LONG 0x88 "var_off"
    READ_LONG 0xa0 "bmp_off"
    READ_LONG 0xa8 "door_off"
    READ_LONG 0xb0 "anim_off"
    READ_LONG 0xb8 "tiled_off"
    READ_LONG 0xbc "song_off"

    READ_LONG 0xc0 "rest_off"
    READ_LONG 0xc4 "note_off"
    SET "Left" = 1675
    SET "Top" = 2125
    SET "Right" = 1968
    SET "Bottom" = 2175
    WRITE_SHORT 0x5a ("%info_num%" + 1)
    INSERT_BYTES "%info_off%" 0xC4                          // Insert new blank info point
      WRITE_ASCII "%info_off%" ~RR#COC01~                   // Trigger name
      WRITE_SHORT ("%info_off%" + 0x20) 1                   // Trigger type (trap, info or travel)
      WRITE_SHORT ("%info_off%" + 0x22) "%Left%"
      WRITE_SHORT ("%info_off%" + 0x24) "%Top%"
      WRITE_SHORT ("%info_off%" + 0x26) "%Right%"
      WRITE_SHORT ("%info_off%" + 0x28) "%Bottom%"
      WRITE_SHORT ("%info_off%" + 0x2A) 4                   // Number of vertices
      WRITE_LONG ("%info_off%" + 0x2C) "%vert_num%"         // First vertex index
      WRITE_SHORT ("%info_off%" + 0x34) 34                  // Cursor type
      WRITE_LONG ("%info_off%" + 0x60) 1280                 // Flags (i.e. trigger is initially deactivated, party must walk to it when clicked on)
      WRITE_ASCII ("%info_off%" + 0x7C) ~RR#CGRAV~ #8       // Trigger script name
      WRITE_LONG ("%info_off%" + 0x84) 1827                 // Walk to X coordinates
      WRITE_LONG ("%info_off%" + 0x86) 2144                 // Walk to Y coordinates
    PATCH_IF NOT ("%actor_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x54 ("%actor_off%" + 0xC4)
    END
    PATCH_IF NOT ("%spawn_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x60 ("spawn_off" + 0xC4)
    END
    PATCH_IF NOT ("%ent_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x68 ("ent_off" + 0xC4)
    END
    PATCH_IF NOT ("%cont_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x70 ("cont_off" + 0xC4)
    END
    PATCH_IF NOT ("%item_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x78 ("item_off" + 0xC4)
    END
    PATCH_IF NOT ("%vert_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x7c ("vert_off" + 0xC4)
    END
    PATCH_IF NOT ("%amb_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x84 ("amb_off" + 0xC4)
    END
    PATCH_IF NOT ("%var_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x88 ("var_off" + 0xC4)
    END
    PATCH_IF NOT ("%bmp_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xa0 ("bmp_off" + 0xC4)
    END
    PATCH_IF NOT ("%door_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xa8 ("door_off" + 0xC4)
    END
    PATCH_IF NOT ("%anim_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xb0 ("anim_off" + 0xC4)
    END
    PATCH_IF NOT ("%tiled_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xb8 ("tiled_off" + 0xC4)
    END
    PATCH_IF NOT ("%song_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xbc ("song_off" + 0xC4)
    END
    PATCH_IF NOT ("%rest_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xc0 ("rest_off" + 0xC4)
    END
    PATCH_IF NOT ("%note_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xc4 ("note_off" + 0xC4)
    END
    // Add 4 new vertices
    READ_LONG 0x54 "actor_off"
    READ_LONG 0x5c "info_off"
    READ_SHORT 0x5a "info_num"
    READ_LONG 0x60 "spawn_off"
    READ_LONG 0x68 "ent_off"
    READ_LONG 0x70 "cont_off"
    READ_LONG 0x78 "item_off"
    READ_LONG 0x7c "vert_off"
    READ_SHORT 0x80 "vert_num"
    READ_LONG 0x84 "amb_off"
    READ_LONG 0x88 "var_off"
    READ_LONG 0xa0 "bmp_off"
    READ_LONG 0xa8 "door_off"
    READ_LONG 0xb0 "anim_off"
    READ_LONG 0xb8 "tiled_off"
    READ_LONG 0xbc "song_off"
    READ_LONG 0xc0 "rest_off"
    READ_LONG 0xc4 "note_off"
    WRITE_SHORT 0x80 ("%vert_num%" + 4)
    INSERT_BYTES ("%vert_off%" + (0x04 * "%vert_num%")) 0x10
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%") 1675    // Vertex1.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 2) 2175 // Vertex1.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 4) 1700  // Vertex2.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 6) 2125 // Vertex2.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 8) 1968 // Vertex3.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +10) 2132  // Vertex3.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +12) 1957 // Vertex4.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +14) 2175  // Vertex4.Y
    PATCH_IF NOT ("%actor_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x54 ("%actor_off%" + 0x10)
    END
    PATCH_IF NOT ("%info_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x5c ("info_off" + 0x10)
    END
    PATCH_IF NOT ("%spawn_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x60 ("spawn_off" + 0x10)
    END
    PATCH_IF NOT ("%ent_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x68 ("ent_off" + 0x10)
    END
    PATCH_IF NOT ("%cont_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x70 ("cont_off" + 0x10)
    END
    PATCH_IF NOT ("%item_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x78 ("item_off" + 0x10)
    END
    PATCH_IF NOT ("%amb_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x84 ("amb_off" + 0x10)
    END
    PATCH_IF NOT ("%var_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x88 ("var_off" + 0x10)
    END
    PATCH_IF NOT ("%bmp_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xa0 ("bmp_off" + 0x10)
    END
    PATCH_IF NOT ("%door_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xa8 ("door_off" + 0x10)
    END
    PATCH_IF NOT ("%anim_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xb0 ("anim_off" + 0x10)
    END
    PATCH_IF NOT ("%tiled_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xb8 ("tiled_off" + 0x10)
    END
    PATCH_IF NOT ("%song_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xbc ("song_off" + 0x10)
    END
    PATCH_IF NOT ("%rest_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xc0 ("rest_off" + 0x10)
    END
    PATCH_IF NOT ("%note_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xc4 ("note_off" + 0x10)
    END

COPY_EXISTING ~AR0800.ARE~ override                                      // Graveyard district CoC trigger 2 (upper exit)
    READ_LONG 0x54 "actor_off"
    READ_LONG 0x5c "info_off"
    READ_SHORT 0x5a "info_num"
    READ_LONG 0x60 "spawn_off"
    READ_LONG 0x68 "ent_off"
    READ_LONG 0x70 "cont_off"
    READ_LONG 0x78 "item_off"
    READ_LONG 0x7c "vert_off"
    READ_SHORT 0x80 "vert_num"
    READ_LONG 0x84 "amb_off"
    READ_LONG 0x88 "var_off"
    READ_LONG 0xa0 "bmp_off"
    READ_LONG 0xa8 "door_off"
    READ_LONG 0xb0 "anim_off"
    READ_LONG 0xb8 "tiled_off"
    READ_LONG 0xbc "song_off"
    READ_LONG 0xc0 "rest_off"
    READ_LONG 0xc4 "note_off"
    SET "Left" = 878
    SET "Top" = 1
    SET "Right" = 1171
    SET "Bottom" = 44
    WRITE_SHORT 0x5a ("%info_num%" + 1)
    INSERT_BYTES "%info_off%" 0xC4                          // Insert new blank info point
      WRITE_ASCII "%info_off%" ~RR#COC02~                   // Trigger name
      WRITE_SHORT ("%info_off%" + 0x20) 1                   // Trigger type (trap, info or travel)
      WRITE_SHORT ("%info_off%" + 0x22) "%Left%"
      WRITE_SHORT ("%info_off%" + 0x24) "%Top%"
      WRITE_SHORT ("%info_off%" + 0x26) "%Right%"
      WRITE_SHORT ("%info_off%" + 0x28) "%Bottom%"
      WRITE_SHORT ("%info_off%" + 0x2A) 4                   // Number of vertices
      WRITE_LONG ("%info_off%" + 0x2C) "%vert_num%"         // First vertex index
      WRITE_SHORT ("%info_off%" + 0x34) 34                  // Cursor type
      WRITE_LONG ("%info_off%" + 0x60) 1280                 // Flags (i.e. trigger is initially deactivated, party must walk to it when clicked on)
      WRITE_ASCII ("%info_off%" + 0x7C) ~RR#CGRAV~ #8       // Trigger script name
      WRITE_LONG ("%info_off%" + 0x84) 1023                 // Walk to X coordinates
      WRITE_LONG ("%info_off%" + 0x86)   31                 // Walk to Y coordinates
    PATCH_IF NOT ("%actor_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x54 ("%actor_off%" + 0xC4)
    END
    PATCH_IF NOT ("%spawn_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x60 ("spawn_off" + 0xC4)
    END
    PATCH_IF NOT ("%ent_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x68 ("ent_off" + 0xC4)
    END
    PATCH_IF NOT ("%cont_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x70 ("cont_off" + 0xC4)
    END
    PATCH_IF NOT ("%item_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x78 ("item_off" + 0xC4)
    END
    PATCH_IF NOT ("%vert_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x7c ("vert_off" + 0xC4)
    END
    PATCH_IF NOT ("%amb_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x84 ("amb_off" + 0xC4)
    END
    PATCH_IF NOT ("%var_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x88 ("var_off" + 0xC4)
    END
    PATCH_IF NOT ("%bmp_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xa0 ("bmp_off" + 0xC4)
    END
    PATCH_IF NOT ("%door_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xa8 ("door_off" + 0xC4)
    END
    PATCH_IF NOT ("%anim_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xb0 ("anim_off" + 0xC4)
    END
    PATCH_IF NOT ("%tiled_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xb8 ("tiled_off" + 0xC4)
    END
    PATCH_IF NOT ("%song_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xbc ("song_off" + 0xC4)
    END
    PATCH_IF NOT ("%rest_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xc0 ("rest_off" + 0xC4)
    END
    PATCH_IF NOT ("%note_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xc4 ("note_off" + 0xC4)
    END
    // Add 4 new vertices
    READ_LONG 0x54 "actor_off"
    READ_LONG 0x5c "info_off"
    READ_SHORT 0x5a "info_num"
    READ_LONG 0x60 "spawn_off"
    READ_LONG 0x68 "ent_off"
    READ_LONG 0x70 "cont_off"
    READ_LONG 0x78 "item_off"
    READ_LONG 0x7c "vert_off"
    READ_SHORT 0x80 "vert_num"
    READ_LONG 0x84 "amb_off"
    READ_LONG 0x88 "var_off"
    READ_LONG 0xa0 "bmp_off"
    READ_LONG 0xa8 "door_off"
    READ_LONG 0xb0 "anim_off"
    READ_LONG 0xb8 "tiled_off"
    READ_LONG 0xbc "song_off"
    READ_LONG 0xc0 "rest_off"
    READ_LONG 0xc4 "note_off"
    WRITE_SHORT 0x80 ("%vert_num%" + 4)
    INSERT_BYTES ("%vert_off%" + (0x04 * "%vert_num%")) 0x10
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%") 878       // Vertex1.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 2) 44    // Vertex1.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 4) 1171  // Vertex2.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 6) 44    // Vertex2.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 8) 1171  // Vertex3.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +10) 1     // Vertex3.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +12) 878   // Vertex4.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +14) 1     // Vertex4.Y
    PATCH_IF NOT ("%actor_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x54 ("%actor_off%" + 0x10)
    END
    PATCH_IF NOT ("%info_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x5c ("info_off" + 0x10)
    END
    PATCH_IF NOT ("%spawn_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x60 ("spawn_off" + 0x10)
    END
    PATCH_IF NOT ("%ent_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x68 ("ent_off" + 0x10)
    END
    PATCH_IF NOT ("%cont_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x70 ("cont_off" + 0x10)
    END
    PATCH_IF NOT ("%item_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x78 ("item_off" + 0x10)
    END
    PATCH_IF NOT ("%amb_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x84 ("amb_off" + 0x10)
    END
    PATCH_IF NOT ("%var_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x88 ("var_off" + 0x10)
    END
    PATCH_IF NOT ("%bmp_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xa0 ("bmp_off" + 0x10)
    END
    PATCH_IF NOT ("%door_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xa8 ("door_off" + 0x10)
    END
    PATCH_IF NOT ("%anim_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xb0 ("anim_off" + 0x10)
    END
    PATCH_IF NOT ("%tiled_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xb8 ("tiled_off" + 0x10)
    END
    PATCH_IF NOT ("%song_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xbc ("song_off" + 0x10)
    END
    PATCH_IF NOT ("%rest_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xc0 ("rest_off" + 0x10)
    END
    PATCH_IF NOT ("%note_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xc4 ("note_off" + 0x10)
    END


// CoC items and icons


COPY ~RR/RR_CYRIC/BAM~                            override              // Icons and portraits for the CoC spell effects, items and characters
COPY ~RR/RR_CYRIC/ITEMS/RR#AMULB.ITM~             override              // Barrier amulet
  SAY NAME2 @202 SAY DESC @203
COPY ~RR/RR_CYRIC/ITEMS/RR#BOOTF.ITM~             override              // Boots of the Fox
  SAY NAME2 @204 SAY DESC @205
COPY ~RR/RR_CYRIC/ITEMS/RR#SCAXE.EFF~             override              // Stormcharged Axe stun effect immunity (for Constructs, Undead, Slimes...)
COPY ~RR/RR_CYRIC/ITEMS/RR#SCAXE.SPL~             override              // Stormcharged Axe stun effect
COPY ~RR/RR_CYRIC/ITEMS/RR#SCAXE.ITM~             override              // Stormcharged Axe
  SAY NAME2 @206 SAY DESC @207
COPY ~RR/RR_CYRIC/ITEMS/RR#BOW01.ITM~             override              // Blindstrike Bow
  SAY NAME2 @234 SAY DESC @235
COPY ~RR/RR_CYRIC/ITEMS/RR#BBOWH.EFF~             override              // Blindstrike Bow THAC0 vs. Beholders bonus
COPY ~RR/RR_CYRIC/ITEMS/RR#BBOWD.EFF~             override              // Blindstrike Bow damage vs. Beholders bonus
COPY ~RR/RR_CYRIC/ITEMS/RR#BBOWS.EFF~             override              // Blindstrike Bow Beholder saving throw penalty vs. blindness effect
COPY ~RR/RR_CYRIC/ITEMS/RR#BBOW.SPL~              override              // Blindstrike Bow blindness effect
COPY ~RR/RR_CYRIC/ITEMS/RR#HOLDF.ITM~             override              // Holdfast longsword
  SAY NAME2 @208 SAY DESC @209
COPY ~RR/RR_CYRIC/ITEMS/RR#ABIH.ITM~              override              // Abishai Hide
  SAY NAME2 @210 SAY DESC @211
COPY ~RR/RR_CYRIC/ITEMS/RR#DIVER.ITM~             override              // Spell Diver
  SAY NAME2 @212 SAY DESC @213
COPY ~RR/RR_CYRIC/ITEMS/RR#RCOWL.ITM~             override              // Rogue's Cowl
  SAY NAME2 @214 SAY DESC @215
COPY ~RR/RR_CYRIC/ITEMS/RR#SHBTS.ITM~             override              // Shadowed Boots
  SAY NAME2 @218 SAY DESC @219
COPY ~RR/RR_CYRIC/ITEMS/RR#STONG.ITM~             override              // Salamander's Tongue
  SAY NAME2 @220 SAY DESC @221
COPY ~RR/RR_CYRIC/ITEMS/RR#HELMD.ITM~             override              // Dead Man's Face helm
  SAY NAME2 @222 SAY DESC @223
COPY ~RR/RR_CYRIC/ITEMS/RR#HELMS.ITM~             override              // Sune's Laurel
  SAY NAME2 @224 SAY DESC @225
COPY ~RR/RR_CYRIC/ITEMS/RR#CHN01.ITM~             override              // Drow Elven Chain (Zaeron's armor)
  SAY NAME2 @236  SAY DESC @237
COPY ~RR/RR_CYRIC/ITEMS/RR#RNG01.ITM~             override              // Geminus, the PnP Ring of Wizardry (doubles 1st and 2nd level mage spells)
  SAY NAME2 @238  SAY DESC @239
COPY ~RR/RR_CYRIC/ITEMS/RR#LCRWN.ITM~             override              // The Blessed Leaf Crown
  SAY NAME2 @240  SAY DESC @241
COPY ~RR/RR_CYRIC/ITEMS/RR#SDEAT.ITM~             override              // Silent Death
SAY NAME2 @216 SAY DESC @217
READ_LONG 0x64 abil_off
READ_SHORT 0x68 abil_num
READ_LONG 0x6a fx_off
  FOR (i = 0; i < "%abil_num%"; i += 1) BEGIN
    READ_BYTE (%abil_off% + %i% * 0x38) abil_type
    PATCH_IF (%abil_type% = 1) BEGIN                                                  // only patch the melee ability header
      READ_SHORT (%abil_off% + %i% * 0x38 + 0x1e) abil_fx_num
      READ_SHORT (%abil_off% + %i% * 0x38 + 0x20) abil_fx_idx
      FOR (k = %abil_fx_idx%; k < "%abil_fx_idx%" + "%abil_fx_num%"; k += 1) BEGIN
        READ_SHORT (%fx_off% + %k% * 0x30) "opcode"
        READ_LONG  (%fx_off% + %k% * 0x30 + 0x04) "param1"
         PATCH_IF ((%opcode% = "139") AND (%param1% = "70396")) BEGIN                 // effect: #139 (Display String) and param1 = 70396 (Hit Points Lowered)
          SAY (%fx_off% + %k% * 0x30 + 0x04) @89                                      // Vital Strike
	 END
      END
    END
  END
BUT_ONLY
COPY ~RR/RR_CYRIC/ITEMS/RR#VLUCK.ITM~             override              // Venduris' Luckstone
  SAY NAME2 @226 SAY DESC @227
COPY ~RR/RR_CYRIC/ITEMS/RR#VRING.ITM~             override              // Venduris' Ring of Concealment
  SAY NAME2 @228 SAY DESC @229
COPY ~RR/RR_CYRIC/ITEMS/RR#VCLK.ITM~              override              // Venduris' Cloak
  SAY NAME2 @232 SAY DESC @233
COPY ~RR/RR_CYRIC/ITEMS/RR#VWARD.ITM~             override              // Venduris' Scroll
 SAY NAME2 @230 SAY DESC @231
COPY ~RR/RR_CYRIC/ITEMS/RR#BT01.ITM~              override              // Venduris' Boots of Speed
COPY ~RR/RR_STIM/ITEMS/RR#INV.ITM~                override              // Invulnerability item for cutscene creatures


// CoC SPELLS

COPY ~RR/RR_CYRIC/SPELLS/RR#VDET.SPL~             override              // Venduris' Enhanced Detect Illusion ability
COPY ~RR/RR_CYRIC/SPELLS/RR#GONE!.SPL~            override              // Cutscene animation removal spell
COPY ~RR/RR_CYRIC/SPELLS/RR#BACK!.SPL~            override              // Cutscene animation restore spell
COPY ~RR/RR_CYRIC/SPELLS/RR#VSBL.SPL~             override              // Spell which renders the caster visible but doesn't remove Improved Invisibility (used after opponents' Spell Triggers and such to ensure fair play)
COPY ~rr/rr_cyric/spells/rr#ahit.spl~             override              // Automatic critical hits for 6 seconds (used in cutscenes)

COPY_EXISTING rr#ahit.spl ~override/fl#akill.spl~
  LPF ADD_SPELL_EFFECT
    INT_VAR
      opcode = 248
      target = 1
      resist_dispel = 2
      duration = 6
    STR_VAR
      resource = fl#akill
  END

COPY_EXISTING  spcl902.eff ~override/fl#akill.eff~
  WRITE_LONG 0x10 13 // opcode
  WRITE_LONG 0x14 2  // target
  WRITE_LONG 0x1c 0  // p1
  WRITE_LONG 0x20 8  // p2
  WRITE_LONG 0x24 1  // timing
  WRITE_LONG 0x28 6  // duration

// CoC creatures and characters

COPY ~RR/RR_CYRIC/ACTORS/RR#BODK.CRE~             override  // Bodak
  SAY NAME1 @300 SAY NAME2 @300
COPY ~RR/RR_CYRIC/ACTORS/RR#GROK.CRE~             override  // Grok
  SAY NAME1 @301 SAY NAME2 @301
COPY ~RR/RR_CYRIC/ACTORS/RR#KERT.CRE~             override  // Kerith
  SAY NAME1 @302 SAY NAME2 @302
COPY ~RR/RR_CYRIC/ACTORS/RR#SELI.CRE~             override  // Selina
  SAY NAME1 @303 SAY NAME2 @303

COPY ~RR/RR_CYRIC/ACTORS/RR#VEND.CRE~             override  // Venduris
  SAY NAME1 @304 SAY NAME2 @304
PATCH_IF FILE_EXISTS_IN_GAME ~RR#TAS00.SPL~ BEGIN           // check for the Thief kit revisions component
  SET opcode_to_delete = "278"                                   // mark opcode #278 (To Hit Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode_to_delete = "73"                                    // mark opcode #73 (Extra Damage Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  ADD_MEMORIZED_SPELL ~RR#TAS01~ #0 ~innate~                     // adds 1x Death Attack
  SET opcode = "33"                                              // effect: #33 (Save vs. Death Modifier)
  SET target = "1"                                               // target: 1 (self)
  SET timing = "9"                                               // timing mode: 9 (permanent after death)
  SET parameter1 = "1"                                           // param1: 1
  SET parameter2 = "0"                                           // param2: 0
  SET parameter3 = "0"                                           // param3: 0
  SET parameter4 = "0"                                           // param4: 0
  SET power = "0"                                                // power: 0
  SET resist_dispel = "0"                                        // dispel/resistance: 0 (non-magical)
  SET duration = "0"                                             // duration: 0
  SET probability1 = "100"                                       // probability1: 100%
  SET probability2 = "0"                                         // probability2: 0%
  SET dicenumber = "0"                                           // dicenumber: 0
  SET dicesize = "0"                                             // dicesize: 0
  SET savingthrow = "0"                                          // saving throw type: 0 (none)
  SET savebonus = "0"                                            // save bonus: 0
  SET school = "0"                                               // school: 0 (schoolless)
  SET lowestafflvl = "0"                                         // lowest level affected: 0
  SET highestafflvl = "0"                                        // highest level affected: 0
  SET casterx = "0"                                              // casterx: 0
  SET castery = "0"                                              // castery: 0
  SET targetx = "0"                                              // targetx: 0
  SET targety = "0"                                              // targety: 0
  SET casterlvl  = "8"                                           // caster level: 8
  SET sectype = "0"                                              // secondary type: 0
  SPRINT ~resource~ ~~                                           // resref: none
  SPRINT ~resource2~ ~~                                          // resref2: none
  SPRINT ~resource3~ ~~                                          // resref3: none
  SPRINT ~vvcresource~ ~~                                        // vvcresref: none
  SPRINT ~effsource~ ~RR#TAS00~                                  // effsource: RR#TAS00.SPL (Poison Expertise)
  SPRINT ~effvar~ ~~                                             // effvar: none
  LAUNCH_PATCH_MACRO ~ADD_CRE_EFFECT~
  SET opcode = "33"                                              // effect: #33 (Save vs. Death Modifier)
  SET target = "1"                                               // target: 1 (self)
  SET timing = "9"                                               // timing mode: 9 (permanent after death)
  SET parameter1 = "1"                                           // param1: 1
  SET parameter2 = "0"                                           // param2: 0
  SET parameter3 = "0"                                           // param3: 0
  SET parameter4 = "0"                                           // param4: 0
  SET power = "0"                                                // power: 0
  SET resist_dispel = "0"                                        // dispel/resistance: 0 (non-magical)
  SET duration = "0"                                             // duration: 0
  SET probability1 = "100"                                       // probability1: 100%
  SET probability2 = "0"                                         // probability2: 0%
  SET dicenumber = "0"                                           // dicenumber: 0
  SET dicesize = "0"                                             // dicesize: 0
  SET savingthrow = "0"                                          // saving throw type: 0 (none)
  SET savebonus = "0"                                            // save bonus: 0
  SET school = "0"                                               // school: 0 (schoolless)
  SET lowestafflvl = "0"                                         // lowest level affected: 0
  SET highestafflvl = "0"                                        // highest level affected: 0
  SET casterx = "0"                                              // casterx: 0
  SET castery = "0"                                              // castery: 0
  SET targetx = "0"                                              // targetx: 0
  SET targety = "0"                                              // targety: 0
  SET casterlvl  = "16"                                          // caster level: 16
  SET sectype = "0"                                              // secondary type: 0
  SPRINT ~resource~ ~~                                           // resref: none
  SPRINT ~resource2~ ~~                                          // resref2: none
  SPRINT ~resource3~ ~~                                          // resref3: none
  SPRINT ~vvcresource~ ~~                                        // vvcresref: none
  SPRINT ~effsource~ ~RR#TAS00~                                  // effsource: RR#TAS00.SPL (Poison Expertise)
  SPRINT ~effvar~ ~~                                             // effvar: none
  LAUNCH_PATCH_MACRO ~ADD_CRE_EFFECT~
END


COPY ~RR/RR_CYRIC/ACTORS/RR#ZAER.CRE~             override  // Zaeron
  SAY NAME1 @305 SAY NAME2 @305
COPY ~RR/RR_CYRIC/ACTORS/RR#CAMN.CRE~             override  // CoC cutscene soldier
COPY ~RR/RR_CYRIC/ACTORS/RR#VWARD.CRE~            override  // CoC ward guard (Venduris' scroll dialogue)
  SAY NAME1 @230  SAY NAME2 @230
COPY ~RR/RR_CYRIC/ACTORS/RR#CTEST.CRE~            override  // CoC test creature (used for manually testing the encounter)
COPY ~RR/RR_CYRIC/ACTORS/RR#OBSRV.CRE~            override  // CoC cutscene observer (reveals fog of war)
COPY_EXISTING ~RR#VEND.CRE~             ~override/RR#VEND2.CRE~  // Venduris clone (needed for the EVILCUTOFF trap setting cutscene sequence)
  WRITE_ASCII 0x2cc ~None~ #8                                    // disable dialogue file (was RR#VEND.DLG)
  WRITE_ASCII 0x248 ~None~ #8                                    // disable override AI script (was RR#VEND.BCS)
  WRITE_BYTE  0x270 255                                          // set allegiance to ENEMY
  WRITE_ASCII 0x280 ~RR#VEND2~ #32                               // assign new death variable (needs to be different from the actual Venduris)



// CoC cutscenes and area scripts

EXTEND_BOTTOM ~AR0800.BCS~  ~RR/RR_CYRIC/COMPILE/AR0800.BAF~                 // Add the CoC spawn script to the Graveyard area
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CAMB0.BAF~                                   // CoC starting cutscene, party rendered invisible
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CAMB1.BAF~                                   // CoC Amnish soldier cutscene and Venduris' enterance
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CAMB2.BAF~                                   // CoC prep sequence (potion drinking and spellcasting)
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CAMB3.BAF~                                   // Venduris invoking the magical wards
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CEND1.BAF~                                   // Player reads the command phrase and safely exits
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CEND2.BAF~                                   // Player destroys Venduris' scroll and suffers a magical backslash
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CEND3.BAF~                                   // The CoC party departs peacefully
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CEND4.BAF~                                   // The CoC party departs after being intimidated by the Slayer
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CGRAV.BAF~                                   // The graveyard cutscene (fade to black and play ambushed sound)
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CSLY1.BAF~                                   // Slayer cutscene part 1 (a.k.a. the threat)
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CSLY2.BAF~                                   // Slayer cutscene part 2 (a.k.a. the gibbing :)
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CTEST.BAF~                                   // CoC test script (used by the CoC test creature)
COMPILE ~RR/RR_CYRIC/COMPILE/RR#001.BAF~                                     // The area script for the CoC battlefield
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CSAVE.BAF~                                   // The cutscene script for the CoC Final Save
COMPILE ~RR/RR_CYRIC/COMPILE/RR#CUTCY.BAF~                                   // A new cutscene for Cyric (pocketplane challenge in ToB)


// CoC AI scripts

COMPILE ~RR/RR_CYRIC/COMPILE/RR#BODK.BAF~                                    // Bodak's AI script
COMPILE ~RR/RR_CYRIC/COMPILE/RR#GROK.BAF~                                    // Grok's AI script
COMPILE ~RR/RR_CYRIC/COMPILE/RR#KERT.BAF~                                    // Kerith's AI script
COMPILE ~RR/RR_CYRIC/COMPILE/RR#SELI.BAF~                                    // Selina's AI script
COMPILE ~RR/RR_STIM/COMPILE/RR#MSLD.BAF~                                     // Mislead AI script (for Zaeron's clone)
COMPILE ~RR/RR_CYRIC/COMPILE/RR#ZAER.BAF~                                    // Zaeron's AI script
COMPILE ~RR/RR_CYRIC/COMPILE/RR#VEND.BAF~                                    // Venduris' AI script


COPY_EXISTING ~BALDUR.BCS~ override                                        // delay Malchor Harpell's appearance until the CoC encounter is over, also delay quests etc
  DECOMPILE_BCS_TO_BAF
    REPLACE_TEXTUALLY EXACT_MATCH ~!Exists("c6harp")~ ~!Exists("c6harp") !AreaCheck("RR#001") !AreaCheck("AR0800")~
    REPLACE_TEXTUALLY CASE_INSENSITIVE EVALUATE_REGEXP ~\(^ +!Global("Chapter","GLOBAL",4)[ %lnl%]+!Global("Chapter","GLOBAL",5)[ %lnl%]+!Global("Chapter","GLOBAL",7)\)~ ~\1 !AreaCheck("RR#001")~
  COMPILE_BAF_TO_BCS
UNLESS ~16510 0 1 0 0 "RR#001" "" OB~
BUT_ONLY

                                                                             //Delay party member's quests etc
COPY_EXISTING nalia.bcs   override
              jan.bcs     override
              aerie.bcs   override
              anomen.bcs  override
              cernd.bcs   override
              edwin.bcs   override
              jaheira.bcs override
              keldorn.bcs override
              korgan.bcs  override
              mazzy.bcs   override
              minsc.bcs   override
              yoshimo.bcs override
  DECOMPILE_BCS_TO_BAF
    REPLACE_TEXTUALLY CASE_INSENSITIVE EVALUATE_REGEXP ~^\( +!Global("Chapter","GLOBAL",4)[ %lnl%]+!Global("Chapter","GLOBAL",5)[ %lnl%]+!Global("Chapter","GLOBAL",7)\)~ ~\1 !AreaCheck("RR#001")~
  COMPILE_BAF_TO_BCS
UNLESS ~16510 0 1 0 0 "RR#001" "" OB~
BUT_ONLY

// CoC dialogues

COMPILE ~RR/RR_CYRIC/COMPILE/RR#VWARD.D~                                     // Ward guard's dialogue (Venduris' scroll)
COMPILE ~RR/RR_CYRIC/COMPILE/RR#VEND.D~                                      // Venduris' dialogue along with the interjections of other CoC members
COMPILE ~RR/RR_CYRIC/COMPILE/CHALCY01.D~                                     // Additional dialogue for Cyric (pocketplane challenge in ToB)
COMPILE ~RR/RR_CYRIC/COMPILE/RR#INT01.D~                                     // Party member interjections during Venduris' dialogue

// Make the RR ioun stones use WoRm's animations if they are present

ACTION_IF FILE_EXISTS_IN_GAME ~ion1bz.bam~ BEGIN                        // Checks for WoRm's Ioun Stone animations (used by IR and CA)
COPY_EXISTING ~RR#VLUCK.ITM~ override                                            // Venduris' Luckstone
SET opcode = "215"                                                                 // effect: #215 (play 3d effect)
SET target = "1"                                                                   // target: 1 (self)
SET timing = "2"                                                                   // timing mode: 2 (while equipped)
SET parameter1 = "0"                                                               // param1: 0 (play over target)
SET parameter2 = "1"                                                               // param2: 2 (play over target)
SET power = "0"                                                                    // power: 0
SET resist_dispel = "0"                                                            // dispel/resistance: 0 (non-magical)
SET duration = "0"                                                                 // duration: 0
SET probability1 = "100"                                                           // probability1: 100%
SET probability2 = "0"                                                             // probability2: 0%
SET dicenumber = "0"                                                               // dicenumber: 0
SET dicesize = "0"                                                                 // dicesize: 0
SET savingthrow = "0"                                                              // saving throw type: 0 (none)
SET savebonus = "0"                                                                // save bonus: 0
SPRINT ~resource~ ~ION1B~                                                          // resref: ION1B (black ioun stone animation part 1)
LAUNCH_PATCH_MACRO ~ADD_ITEM_EQEFFECT~
SET opcode = "215"                                                                 // effect: #215 (play 3d effect)
SET target = "1"                                                                   // target: 1 (self)
SET timing = "2"                                                                   // timing mode: 2 (while equipped)
SET parameter1 = "0"                                                               // param1: 0 (play over target)
SET parameter2 = "1"                                                               // param2: 2 (play over target)
SET power = "0"                                                                    // power: 0
SET resist_dispel = "0"                                                            // dispel/resistance: 0 (non-magical)
SET duration = "0"                                                                 // duration: 0
SET probability1 = "100"                                                           // probability1: 100%
SET probability2 = "0"                                                             // probability2: 0%
SET dicenumber = "0"                                                               // dicenumber: 0
SET dicesize = "0"                                                                 // dicesize: 0
SET savingthrow = "0"                                                              // saving throw type: 0 (none)
SET savebonus = "0"                                                                // save bonus: 0
SPRINT ~resource~ ~ION2B~                                                          // resref: ION2B (black ioun stone animation part 2)
LAUNCH_PATCH_MACRO ~ADD_ITEM_EQEFFECT~
BUT_ONLY
END                                                                                // WoRm's Ioun Stone animations check block



///////////////////////////////////////////////////////////////////////
// Rogue Rebalancing - Shadow Thief improvements
///////////////////////////////////////////////////////////////////////

// *** For fellow modders *** this component can be detected by searching for the following file - RR#STF01.BCS


BEGIN @7 DESIGNATED 12
REQUIRE_PREDICATE GAME_IS ~tob bgt bg2ee~ @902

LAUNCH_ACTION_MACRO ~RR#AFIX~

INCLUDE "rr/lib/ds.tpa"                                                       // Detectable Spells

// Create scroll and potion distribution markers

COPY_EXISTING ~MISC20.ITM~ ~override/RR#STS01.ITM~ // Bloodstone Gem -> Tier 1 marker (Shield, Blur, Ghost Armor, Potion of Fortitude)
COPY_EXISTING ~MISC21.ITM~ ~override/RR#STS02.ITM~ // Skydrop Gem -> Tier 2 marker (Ray of Enfeeblement, Blindness, Spook, Glitterdust, Deafness)
COPY_EXISTING ~MISC22.ITM~ ~override/RR#STS03.ITM~ // Andar Gem -> Tier 3 marker (Mirror Image, Slow, Hold Person, Vampiric Touch, Potion of Hill Giant Strength)
COPY_EXISTING ~MISC23.ITM~ ~override/RR#STS04.ITM~ // Jasper Gem -> Tier 4 marker (Potion of Haste)

COPY ~RR/RR_STIM/ITEMS/RR#HIDN.ITM~     override                // Item which applies invisibility while equipped (used for initial Hide in Shadows)


// ******************************************
// Allow Single-Classed Thieves to join Bodhi
// ******************************************

COMPILE ~RR/RR_STIM/COMPILE/BODHI.D~                                // single-classed thieves can now join Bodhi if at least one of their mental attributes (INT, WIS, CHA) is higher than 12 or if their Lore is higher than 24, also Palern rescue tweak (accounts for STI stealth path)


// *********************************************************************
// Allow players who have sided with Bodhi to keep the thief stronghold
// *********************************************************************

EXTEND_BOTTOM ~joster.bcs~  ~rr/rr_stim/compile/joster.baf~         // Make Joster (Renal's debt collector) go away if the player has sided with Bodhi
COPY_EXISTING ~BALDUR.BCS~ override                               // Prevent Joster from returning if the player has sided with Bodhi
  DECOMPILE_BCS_TO_BAF
    REPLACE_TEXTUALLY EXACT_MATCH ~GlobalTimerExpired("JosterReturn","GLOBAL")~ ~GlobalTimerExpired("JosterReturn","GLOBAL") Global("WorkingForBodhi","GLOBAL",0)~
    REPLACE_TEXTUALLY EXACT_MATCH ~GlobalTimerExpired("JosterPaid","GLOBAL")~ ~GlobalTimerExpired("JosterPaid","GLOBAL") Global("WorkingForBodhi","GLOBAL",0)~
  COMPILE_BAF_TO_BCS
BUT_ONLY



// **************************************
// Improved Chapter 6 Shadow Thief Allies
// **************************************

COPY_EXISTING ~AR0808.BCS~                           override     // AR0808 script fix for the spawning locations of Yeanasha and Gofus
 DECOMPILE_BCS_TO_BAF
  REPLACE_TEXTUALLY EXACT_MATCH ~CreateCreature("C6YEAN",[1413.1022],8)~ ~CreateCreature("C6YEAN",[1261.971],8)~
  REPLACE_TEXTUALLY EXACT_MATCH ~CreateCreature("C6GOFUS",[1412.1079],8)~ ~CreateCreature("C6GOFUS",[1534.855],8)~
 COMPILE_BAF_TO_BCS
 BUT_ONLY

// Updated .CRE files

COPY_EXISTING ~C6ARKAN.CRE~  override                             // Arkanis (AR0808)
              ~C6ARKAN3.CRE~ override                             // Arkanis (AR0809)
  REMOVE_CRE_ITEM ~SW1H29~                                          // removes the Short Sword +2
  REPLACE_CRE_ITEM ~LEAT08~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // Shadow Armor
  REPLACE_CRE_ITEM ~SW1H74~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON1~ EQUIP  // Short Sword +3
  REPLACE_CRE_ITEM ~SW1H74~ #0 #0 #0 ~UNSTEALABLE~ ~SHIELD~         // Short Sword +3
  ADD_CRE_ITEM ~BELT03~ #0 #0 #0 ~UNSTEALABLE~ ~BELT~               // Girdle of Bluntness
  ADD_CRE_ITEM ~POTN10~ #9 #0 #0 ~UNSTEALABLE~ ~QITEM1~             // 9x Potion of Invisibility
  ADD_CRE_ITEM ~POTN18~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM2~             // 1x Potion of Absorbtion
  ADD_CRE_ITEM ~POTN14~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM3~             // 1x Oil of Speed
  ADD_CRE_ITEM ~POTN11~ #1 #0 #0 ~UNSTEALABLE~ ~INV1~               // 1x Potion of Invulnerability
  ADD_CRE_ITEM ~SCRL96~ #1 #0 #0 ~UNSTEALABLE~ ~INV2~               // 1x Scroll of Mirror Image
  ADD_CRE_ITEM ~SCRL6L~ #1 #0 #0 ~UNSTEALABLE~ ~INV3~               // 1x Scroll of Hold Undead
  ADD_CRE_ITEM ~RESTORE~ #1 #0 #0 ~UNSTEALABLE~ ~INV4~              // 1x Scroll of Lesser Restoration
  ADD_CRE_ITEM ~POTN52~ #5 #0 #0 ~UNSTEALABLE~ ~INV5~               // 5x Potion of Extra Healing
  READ_LONG 0x10 "flags"                                            // flags
  WRITE_LONG 0x10 ("%flags%" BOR 0b00001000)                        // original class: fighter
  WRITE_LONG 0x18 1320000                                           // current XP
  WRITE_SHORT 0x24 95                                               // current hit points
  WRITE_SHORT 0x26 95                                               // maximum hit points
  WRITE_BYTE 0x2C 46                                                // metal color
  WRITE_BYTE 0x2D 47                                                // minor color
  WRITE_BYTE 0x2E 66                                                // major color
  WRITE_BYTE 0x2F 11                                                // skin color
  WRITE_BYTE 0x30 0                                                 // leather color
  WRITE_BYTE 0x31 0                                                 // armor color
  WRITE_BYTE 0x32 2                                                 // hair color
  WRITE_ASCII 0x34 ~RR#ARKNS~ #8                                    // Sets Arkanis' small portrait
  WRITE_BYTE 0x45 80                                                // Hide in Shadows skill
  WRITE_SHORT 0x46 10                                               // natural AC
  WRITE_SHORT 0x48 10                                               // effective AC
  WRITE_BYTE 0x52 8                                                 // THAC0
  WRITE_BYTE 0x53 1                                                 // base number of attacks
  WRITE_BYTE 0x54 5                                                 // save vs. death
  WRITE_BYTE 0x55 7                                                 // save vs. wands
  WRITE_BYTE 0x56 6                                                 // save vs. polymorph
  WRITE_BYTE 0x57 7                                                 // save vs. breath
  WRITE_BYTE 0x58 8                                                 // save vs. spells
  WRITE_BYTE 0x64 0                                                 // Detect Illusions skill
  WRITE_BYTE 0x65 0                                                 // Set Traps skill
  WRITE_BYTE 0x66 52                                                // Lore
  WRITE_BYTE 0x67 110                                               // Open Locks skill
  WRITE_BYTE 0x68 80                                                // Move Silently skill
  WRITE_BYTE 0x69 115                                               // Find Traps skill
  WRITE_BYTE 0x6a 0                                                 // Pick Pockets skill
  WRITE_BYTE 0x6e 0                                                 // BG1 Proficiency slot (large sword)
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x70 0                                                 // BG1 Proficiency slot (bow)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 13                                               // level (first class)
  WRITE_BYTE 0x235 16                                               // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x237 1                                                // sex
  WRITE_BYTE 0x238 18                                               // Strength
  WRITE_BYTE 0x239 77                                               // Strength bonus
  WRITE_BYTE 0x23a 14                                               // Inteligence
  WRITE_BYTE 0x23b 12                                               // Wisdom
  WRITE_BYTE 0x23c 18                                               // Dexterity
  WRITE_BYTE 0x23d 18                                               // Constitution
  WRITE_BYTE 0x23e 10                                               // Charisma
  WRITE_BYTE 0x23f 20                                               // morale
  WRITE_BYTE 0x240 1                                                // morale break
  WRITE_BYTE 0x242 1                                                // morale recovery
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  WRITE_BYTE 0x273 9                                                // class
  SET_BG2_PROFICIENCY ~PROFICIENCYSHORTSWORD~ 5                     // Give Arkanis 5 stars in the BG2 Shortsword proficiency
BUT_ONLY


COPY_EXISTING ~C6KACH.CRE~  override                              // Kachiko (normal)
  REMOVE_CRE_ITEM ~rndtre03~                                        // removes the random treasure 03 item
  REMOVE_CRE_ITEM ~dagg16~                                          // removes the poisoned daggers (they'd mess up dual wielding)
  REPLACE_CRE_ITEM ~LEAT04~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // Unenchanted Studded Leather Armor (for wearing the Amulet of Protection +1)
  REPLACE_CRE_ITEM ~DAGG24~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON1~ EQUIP  // Dagger +3
  ADD_CRE_ITEM ~DAGG24~ #0 #0 #0 ~UNSTEALABLE~ ~SHIELD~             // Dagger +3
  ADD_CRE_ITEM ~AMUL14~ #0 #0 #0 ~UNSTEALABLE~ ~AMULET~             // Amulet of Protection +1
  ADD_CRE_ITEM ~POTN10~ #5 #0 #0 ~UNSTEALABLE~ ~QITEM1~             // 5x Potion of Invisibility
  ADD_CRE_ITEM ~POTN24~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM2~             // 1x Potion of Defense
  ADD_CRE_ITEM ~SCRL3H~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM3~             // 1x Scroll of Protection From Evil
  ADD_CRE_ITEM ~POTN52~ #2 #0 #0 ~UNSTEALABLE~ ~INV1~               // 2x Potion of Extra Healing
  READ_LONG 0x10 "flags"                                            // flags
  WRITE_LONG 0x10 ("%flags%" BOR 0b00001000)                        // original class: fighter
  WRITE_LONG 0x18 660000                                            // current XP
  WRITE_SHORT 0x24 78                                               // current hit points
  WRITE_SHORT 0x26 78                                               // maximum hit points
  WRITE_SHORT 0x28 25360                                            // Sets avatar to THIEF_FEMALE_HUMAN
  WRITE_BYTE 0x2C 25                                                // metal color
  WRITE_BYTE 0x2D 58                                                // minor color
  WRITE_BYTE 0x2E 65                                                // major color
  WRITE_BYTE 0x2F 12                                                // skin color
  WRITE_BYTE 0x30 23                                                // leather color
  WRITE_BYTE 0x31 24                                                // armor color
  WRITE_BYTE 0x32 2                                                 // hair color
  WRITE_BYTE 0x45 65                                                // Hide in Shadows skill
  WRITE_BYTE 0x52 14                                                // THAC0
  WRITE_BYTE 0x54 10                                                // save vs. death
  WRITE_BYTE 0x55 8                                                 // save vs. wands
  WRITE_BYTE 0x56 9                                                 // save vs. polymorph
  WRITE_BYTE 0x57 12                                                // save vs. breath
  WRITE_BYTE 0x58 9                                                 // save vs. spells
  WRITE_BYTE 0x64 0                                                 // Detect Illusions skill
  WRITE_BYTE 0x65 0                                                 // Set Traps skill
  WRITE_BYTE 0x66 39                                                // Lore
  WRITE_BYTE 0x67 50                                                // Open Locks skill
  WRITE_BYTE 0x68 70                                                // Move Silently skill
  WRITE_BYTE 0x69 70                                                // Find Traps skill
  WRITE_BYTE 0x6a 0                                                 // Pick Pockets skill
  WRITE_LONG 0xa4 61895                                             // initial meeting string
  WRITE_LONG 0xb8 61899                                             // unhappy breaking point
  WRITE_LONG 0xc8 61895                                             // battle cry 1
  WRITE_LONG 0xcc 61896                                             // battle cry 2
  WRITE_LONG 0xec 61897                                             // damage string
  WRITE_LONG 0xf0 61898                                             // death string
  WRITE_LONG 0x10c 61892                                            // select common 1
  WRITE_LONG 0x110 61893                                            // select common 2
  WRITE_LONG 0x114 61894                                            // select common 3
  WRITE_BYTE 0x6e 0                                                 // BG1 Proficiency slot (large sword)
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x70 0                                                 // BG1 Proficiency slot (bow)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 7                                                // level (first class)
  WRITE_BYTE 0x235 13                                               // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x237 2                                                // sex
  WRITE_BYTE 0x238 15                                               // Strength
  WRITE_BYTE 0x23a 12                                               // Inteligence
  WRITE_BYTE 0x23b 10                                               // Wisdom
  WRITE_BYTE 0x23c 18                                               // Dexterity
  WRITE_BYTE 0x23d 16                                               // Constitution
  WRITE_BYTE 0x23e 13                                               // Charisma
  WRITE_BYTE 0x23f 20                                               // morale
  WRITE_BYTE 0x240 5                                                // morale break
  WRITE_BYTE 0x242 30                                               // morale recovery
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  WRITE_BYTE 0x273 9                                                // class
  WRITE_BYTE 0x275 2                                                // gender
  SET_BG2_PROFICIENCY ~PROFICIENCYDAGGER~ 3                         // Give Kachiko 3 stars in the BG2 Dagger proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCY2WEAPON~ 3                        // Give Kachiko 3 stars in the BG2 Two Weapon Style proficiency
BUT_ONLY

COPY_EXISTING ~C6GOFUS.CRE~ override                              // Gofus
  REMOVE_CRE_ITEM ~rndtre03~                                        // removes the random treasure 03 item
  REPLACE_CRE_ITEM ~LEAT04~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // Unenchanted Studded Leather Armor (for wearing the Ring of Protection +1)
  REPLACE_CRE_ITEM ~SW1H73~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON1~ EQUIP  // Long Sword +3

  REPLACE_CRE_ITEM ~SW1H73~ #0 #0 #0 ~UNSTEALABLE~ ~SHIELD~         // Long Sword +3
  ADD_CRE_ITEM ~POTN10~ #5 #0 #0 ~UNSTEALABLE~ ~QITEM1~             // 5x Potion of Invisibility
  ADD_CRE_ITEM ~POTN24~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM2~             // 1x Potion of Defense
  ADD_CRE_ITEM ~SCRL1O~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM3~             // 1x Scroll of Slow
  ADD_CRE_ITEM ~POTN52~ #2 #0 #0 ~UNSTEALABLE~ ~INV1~               // 2x Potion of Extra Healing
  ADD_CRE_ITEM ~RING06~ #0 #0 #0 ~UNSTEALABLE~ ~RRING~              // Ring of Protection +1
  ADD_CRE_ITEM ~RR#HIDN~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~ // Undroppable Amulet of Invisibility (for simulating initial Hide in Shadows state)
  WRITE_LONG 0x18 1320000                                           // current XP
  WRITE_SHORT 0x24 72                                               // current hit points
  WRITE_SHORT 0x26 72                                               // maximum hit points
  WRITE_BYTE 0x2C 0                                                 // metal color
  WRITE_BYTE 0x2D 0                                                 // minor color
  WRITE_BYTE 0x2E 0                                                 // major color
  WRITE_BYTE 0x2F 39                                                // skin color
  WRITE_BYTE 0x30 0                                                 // leather color
  WRITE_BYTE 0x31 0                                                 // armor color
  WRITE_BYTE 0x32 1                                                 // hair color
  WRITE_BYTE 0x45 85                                                // Hide in Shadows skill
  WRITE_BYTE 0x53 1                                                 // base number of attacks
  WRITE_BYTE 0x52 13                                                // THAC0
  WRITE_BYTE 0x54 10                                                // save vs. death
  WRITE_BYTE 0x55 8                                                 // save vs. wands
  WRITE_BYTE 0x56 9                                                 // save vs. polymorph
  WRITE_BYTE 0x57 13                                                // save vs. breath
  WRITE_BYTE 0x58 9                                                 // save vs. spells
  WRITE_BYTE 0x64 10                                                // Detect Illusions skill
  WRITE_BYTE 0x65 0                                                 // Set Traps skill
  WRITE_BYTE 0x66 48                                                // Lore
  WRITE_BYTE 0x67 75                                                // Open Locks skill
  WRITE_BYTE 0x68 80                                                // Move Silently skill
  WRITE_BYTE 0x69 90                                                // Find Traps skill
  WRITE_BYTE 0x6a 75                                                // Pick Pockets skill
  WRITE_BYTE 0x6e 0                                                 // BG1 Proficiency slot (large sword)
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x70 0                                                 // BG1 Proficiency slot (bow)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 16                                               // level (first class)
  WRITE_BYTE 0x235 0                                                // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x238 14                                               // Strength
  WRITE_BYTE 0x23a 12                                               // Inteligence
  WRITE_BYTE 0x23b 12                                               // Wisdom
  WRITE_BYTE 0x23c 18                                               // Dexterity
  WRITE_BYTE 0x23d 16                                               // Constitution
  WRITE_BYTE 0x23e 10                                               // Charisma
  WRITE_BYTE 0x23f 20                                               // morale
  WRITE_BYTE 0x240 5                                                // morale break
  WRITE_BYTE 0x242 30                                               // morale recovery
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  WRITE_BYTE 0x275 1                                                // gender
  SET_BG2_PROFICIENCY ~PROFICIENCYLONGSWORD~ 2                      // Give Gofus 2 stars in the BG2 Longsword proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCYSHORTSWORD~ 1                     // Give Gofus 1 star in the BG2 Shortsword proficiency
BUT_ONLY

COPY_EXISTING ~C6YEAN.CRE~ override                               // Yeanasha
  REMOVE_CRE_ITEM ~LEAT11~                                          // removes Leather Armor +2 from Yeanasha (since he's a Kensai)
  REMOVE_CRE_ITEM ~rndtre02~                                        // removes the random treasure 02 item
  REPLACE_CRE_ITEM ~SW1H75~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON1~ EQUIP  // Katana +3
  ADD_CRE_ITEM ~CLCK01~ #0 #0 #0 ~UNSTEALABLE~ ~CLOAK~              // Cloak of Protection +1
  ADD_CRE_ITEM ~POTN10~ #5 #0 #0 ~UNSTEALABLE~ ~QITEM1~             // 5x Potion of Invisibility
  ADD_CRE_ITEM ~POTN11~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM2~             // 1x Potion of Invulnerability
  ADD_CRE_ITEM ~SCRL85~ #1 #0 #0 ~UNSTEALABLE~ ~QITEM3~             // 1x Scroll of Blur
  ADD_CRE_ITEM ~POTN52~ #2 #0 #0 ~UNSTEALABLE~ ~INV1~               // 2x Potion of Extra Healing
  ADD_CRE_ITEM ~RR#HIDN~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~ // Undroppable Amulet of Invisibility (for simulating initial Hide in Shadows state)
  ADD_MEMORIZED_SPELL ~SPCL144~ #0 ~innate~                         // Adds 1x Kai innate ability
  ADD_MEMORIZED_SPELL ~SPCL144~ #0 ~innate~                         // Adds 1x Kai innate ability
  READ_LONG 0x10 "flags"                                            // flags
  WRITE_LONG 0x10 ("%flags%" BOR 0b00001000)                        // original class: fighter
  WRITE_LONG 0x18 700000                                            // current XP
  WRITE_SHORT 0x24 90                                               // current hit points
  WRITE_SHORT 0x26 90                                               // maximum hit points
  WRITE_BYTE 0x2C 35                                                // metal color
  WRITE_BYTE 0x2D 0                                                 // minor color
  WRITE_BYTE 0x2E 80                                                // major color
  WRITE_BYTE 0x2F 16                                                // skin color
  WRITE_BYTE 0x30 24                                                // leather color
  WRITE_BYTE 0x31 67                                                // armor color
  WRITE_BYTE 0x32 0                                                 // hair color
  WRITE_BYTE 0x45 65                                                // Hide in Shadows skill
  WRITE_BYTE 0x52 12                                                // THAC0
  WRITE_BYTE 0x54 8                                                 // save vs. death
  WRITE_BYTE 0x55 8                                                 // save vs. wands
  WRITE_BYTE 0x56 9                                                 // save vs. polymorph
  WRITE_BYTE 0x57 9                                                 // save vs. breath
  WRITE_BYTE 0x58 9                                                 // save vs. spells
  WRITE_BYTE 0x64 85                                                // Detect Illusions skill
  WRITE_BYTE 0x65 40                                                // Set Traps skill
  WRITE_BYTE 0x66 39                                                // Lore
  WRITE_BYTE 0x67 0                                                 // Open Locks skill
  WRITE_BYTE 0x68 75                                                // Move Silently skill
  WRITE_BYTE 0x69 40                                                // Find Traps skill
  WRITE_BYTE 0x6a 15                                                // Pick Pockets skill
  WRITE_BYTE 0x6e 0                                                 // BG1 Proficiency slot (large sword)
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x70 0                                                 // BG1 Proficiency slot (bow)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 9                                                // level (first class)
  WRITE_BYTE 0x235 13                                               // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x238 18                                               // Strength
  WRITE_BYTE 0x239 55                                               // Strength bonus
  WRITE_BYTE 0x23a 10                                               // Inteligence
  WRITE_BYTE 0x23b 12                                               // Wisdom
  WRITE_BYTE 0x23c 18                                               // Dexterity
  WRITE_BYTE 0x23d 16                                               // Constitution
  WRITE_BYTE 0x23e 10                                               // Charisma
  WRITE_BYTE 0x23f 20                                               // morale
  WRITE_BYTE 0x240 5                                                // morale break
  WRITE_BYTE 0x242 30                                               // morale recovery
  WRITE_ASCII 0x248 ~C6THIEF~ #8                                    // override AI script
  WRITE_ASCII 0x250 ~None~ #8                                       // disable class AI script (KENSAI.BCS)
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  WRITE_BYTE 0x27b 34                                               // alignment
  SET_BG2_PROFICIENCY ~PROFICIENCYKATANA~ 5                         // Give Yeanasha 5 stars in the BG2 Katana proficiency
BUT_ONLY

// Updated area and AI scripts

EXTEND_TOP ~C6FLEDG2.BCS~  ~RR/RR_STIM/COMPILE/C6FLEDG2.BAF~        // Fledgling Vampire spawn fix for Kachiko

COPY_EXISTING ~C6ARKAN.BCS~ override                              // Patch for Arkanis Gath's Chapter 6 AI script
  DECOMPILE_BCS_TO_BAF
    REPLACE_TEXTUALLY EXACT_MATCH ~!Detect([PC])~ ~!Detect([PC]) !Detect([EVILCUTOFF])~
    REPLACE_TEXTUALLY EXACT_MATCH ~Global("MoveToBodhi","LOCALS",0)~ ~Global("MoveToBodhi","LOCALS",0) !Detect([EVILCUTOFF])~
    REPLACE_TEXTUALLY EXACT_MATCH ~MoveToObjectNoInterrupt("DOOR01")~ ~DisplayStringHead(Myself,56214) MoveToObject("DOOR01")~
    REPLACE_TEXTUALLY EXACT_MATCH ~Range("Tran0809",8)~ ~Range("Tran0809",8) !Detect([EVILCUTOFF])~
    REPLACE_TEXTUALLY EXACT_MATCH ~Dead("c6harei")~ ~Dead("c6harei") !Detect([EVILCUTOFF]) OR(3) !Dead("C6gofus") !Dead("C6kach") !Dead("C6yean")~
    REPLACE_TEXTUALLY EXACT_MATCH ~!Range([PC],4)~ ~!Range([PC],4) !Detect([EVILCUTOFF])~
    REPLACE_TEXTUALLY EXACT_MATCH ~("c6drizz")~ ~("c6drizz2")~
    REPLACE_TEXTUALLY EXACT_MATCH ~See([PC])~ ~Detect([PC])~
    REPLACE_TEXTUALLY EXACT_MATCH ~DisplayStringHead(Myself,55914)~ ~DisplayStringHead(Myself,55914) Wait(2)~
    REPLACE_TEXTUALLY EXACT_MATCH ~Dead("c6bodhi")~ ~Dead("c6bodhi") !Detect([EVILCUTOFF]) CombatCounter(0)~
  COMPILE_BAF_TO_BCS
BUT_ONLY
EXTEND_BOTTOM ~C6ARKAN.BCS~  ~RR/RR_STIM/COMPILE/C6ARKAN.BAF~       // Extend Arkanis Gath's Chapter 6 AI script (add combat AI)

COPY_EXISTING ~C6THIEF.BCS~ override                              // Patch the script of the Chapter 6 Shadow Thief allies
  DECOMPILE_BCS_TO_BAF
    REPLACE_TEXTUALLY EXACT_MATCH ~Dead("c6harei")~ ~Dead("c6harei") !Detect([EVILCUTOFF])~
    REPLACE_TEXTUALLY EXACT_MATCH ~See([PC])~ ~Detect([PC])~
  COMPILE_BAF_TO_BCS
BUT_ONLY
EXTEND_BOTTOM ~C6THIEF.BCS~  ~RR/RR_STIM/COMPILE/C6THIEF.BAF~       // Extend the script of the Chapter 6 Shadow Thief allies (add combat AI)



// ***************************
// Improved Shadow Thief Guild
// ***************************

// Custom spells

COPY ~RR/RR_CYRIC/SPELLS/RR#VSBL.SPL~             override              // Spell which renders the caster visible but doesn't remove Improved Invisibility (used after opponents' Spell Triggers and such to ensure fair play)

// Updated areas

COPY ~RR/RR_STIM/AREAS/RR#010.ARE~               override               // The altered Shadow Thief Guild basement area (was AR0329)
COPY ~RR/RR_STIM/AREAS/RR#011.ARE~               override               // The altered Shadow Thief Guild main floor (was AR0327)
COPY ~RR/RR_STIM/AREAS/RR#012.ARE~               override               // The altered Shadow Thief Guild top floor (Palern's room, was AR0328)

APPEND  ~MASTAREA.2DA~  ~RR#010  value~ UNLESS ~RR#010~                      // Adding the guildhall basement area to the 2DA masterfile
APPEND  ~MASTAREA.2DA~  ~RR#011  value~ UNLESS ~RR#011~                      // Adding the guildhall main floor area to the 2DA masterfile
APPEND  ~MASTAREA.2DA~  ~RR#012  value~ UNLESS ~RR#012~                      // Adding the guildhall top floor area to the 2DA masterfile

// Patch two new travel triggers into the Docks Area (code based on Pro5's Dragon Trigger from the BG1 NPC project, thanks cmorgan and Pro5!)


COPY_EXISTING ~AR0300.ARE~ override                                      // Docks district STI trigger 1 (guildhall front enterance to RR#011.ARE)
    READ_LONG 0x54 "actor_off"
    READ_LONG 0x5c "info_off"
    READ_SHORT 0x5a "info_num"
    READ_LONG 0x60 "spawn_off"
    READ_LONG 0x68 "ent_off"
    READ_LONG 0x70 "cont_off"
    READ_LONG 0x78 "item_off"
    READ_LONG 0x7c "vert_off"
    READ_SHORT 0x80 "vert_num"
    READ_LONG 0x84 "amb_off"
    READ_LONG 0x88 "var_off"
    READ_LONG 0xa0 "bmp_off"
    READ_LONG 0xa8 "door_off"
    READ_LONG 0xb0 "anim_off"
    READ_LONG 0xb8 "tiled_off"
    READ_LONG 0xbc "song_off"
    READ_LONG 0xc0 "rest_off"
    READ_LONG 0xc4 "note_off"
    SET "Left" = 1327
    SET "Top" = 858
    SET "Right" = 1347
    SET "Bottom" = 950
    WRITE_SHORT 0x5a ("%info_num%" + 1)
    INSERT_BYTES "%info_off%" 0xC4                          // Insert new blank info point
      WRITE_ASCII "%info_off%" ~RR#STI01~                   // Trigger name
      WRITE_SHORT ("%info_off%" + 0x20) 2                   // Trigger type (trap, info or travel)
      WRITE_SHORT ("%info_off%" + 0x22) "%Left%"
      WRITE_SHORT ("%info_off%" + 0x24) "%Top%"
      WRITE_SHORT ("%info_off%" + 0x26) "%Right%"
      WRITE_SHORT ("%info_off%" + 0x28) "%Bottom%"
      WRITE_SHORT ("%info_off%" + 0x2A) 4                   // Number of vertices
      WRITE_LONG ("%info_off%" + 0x2C) "%vert_num%"         // First vertex index
      WRITE_SHORT ("%info_off%" + 0x34) 30                  // Cursor type
   WRITE_ASCII ("%info_off%" + 0x38) ~RR#011~               // Destination area
   WRITE_ASCII ("%info_off%" + 0x40) ~EXIT0300~             // Destination area's entrance name
      WRITE_LONG ("%info_off%" + 0x60) 772                  // Flags (i.e. trigger is initially deactivated, party required, NPC's can't pass)
    PATCH_IF NOT ("%actor_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x54 ("%actor_off%" + 0xC4)
    END
    PATCH_IF NOT ("%spawn_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x60 ("spawn_off" + 0xC4)
    END
    PATCH_IF NOT ("%ent_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x68 ("ent_off" + 0xC4)
    END
    PATCH_IF NOT ("%cont_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x70 ("cont_off" + 0xC4)
    END
    PATCH_IF NOT ("%item_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x78 ("item_off" + 0xC4)
    END
    PATCH_IF NOT ("%vert_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x7c ("vert_off" + 0xC4)
    END
    PATCH_IF NOT ("%amb_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x84 ("amb_off" + 0xC4)
    END
    PATCH_IF NOT ("%var_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x88 ("var_off" + 0xC4)
    END
    PATCH_IF NOT ("%bmp_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xa0 ("bmp_off" + 0xC4)
    END
    PATCH_IF NOT ("%door_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xa8 ("door_off" + 0xC4)
    END
    PATCH_IF NOT ("%anim_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xb0 ("anim_off" + 0xC4)
    END
    PATCH_IF NOT ("%tiled_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xb8 ("tiled_off" + 0xC4)
    END
    PATCH_IF NOT ("%song_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xbc ("song_off" + 0xC4)
    END
    PATCH_IF NOT ("%rest_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xc0 ("rest_off" + 0xC4)
    END
    PATCH_IF NOT ("%note_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xc4 ("note_off" + 0xC4)
    END
    // Add 4 new vertices
    READ_LONG 0x54 "actor_off"
    READ_LONG 0x5c "info_off"
    READ_SHORT 0x5a "info_num"
    READ_LONG 0x60 "spawn_off"
    READ_LONG 0x68 "ent_off"
    READ_LONG 0x70 "cont_off"
    READ_LONG 0x78 "item_off"
    READ_LONG 0x7c "vert_off"
    READ_SHORT 0x80 "vert_num"
    READ_LONG 0x84 "amb_off"
    READ_LONG 0x88 "var_off"
    READ_LONG 0xa0 "bmp_off"
    READ_LONG 0xa8 "door_off"
    READ_LONG 0xb0 "anim_off"
    READ_LONG 0xb8 "tiled_off"
    READ_LONG 0xbc "song_off"
    READ_LONG 0xc0 "rest_off"
    READ_LONG 0xc4 "note_off"

    WRITE_SHORT 0x80 ("%vert_num%" + 4)
    INSERT_BYTES ("%vert_off%" + (0x04 * "%vert_num%")) 0x10
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%") 1327     // Vertex1.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 2) 950  // Vertex1.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 4) 1347 // Vertex2.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 6) 917  // Vertex2.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 8) 1347 // Vertex3.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +10) 858  // Vertex3.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +12) 1327 // Vertex4.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +14)  891  // Vertex4.Y
    PATCH_IF NOT ("%actor_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x54 ("%actor_off%" + 0x10)
    END
    PATCH_IF NOT ("%info_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x5c ("info_off" + 0x10)
    END
    PATCH_IF NOT ("%spawn_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x60 ("spawn_off" + 0x10)
    END
    PATCH_IF NOT ("%ent_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x68 ("ent_off" + 0x10)
    END
    PATCH_IF NOT ("%cont_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x70 ("cont_off" + 0x10)
    END
    PATCH_IF NOT ("%item_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x78 ("item_off" + 0x10)
    END
    PATCH_IF NOT ("%amb_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x84 ("amb_off" + 0x10)
    END
    PATCH_IF NOT ("%var_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x88 ("var_off" + 0x10)
    END
    PATCH_IF NOT ("%bmp_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xa0 ("bmp_off" + 0x10)
    END
    PATCH_IF NOT ("%door_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xa8 ("door_off" + 0x10)
    END
    PATCH_IF NOT ("%anim_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xb0 ("anim_off" + 0x10)
    END
    PATCH_IF NOT ("%tiled_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xb8 ("tiled_off" + 0x10)
    END
    PATCH_IF NOT ("%song_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xbc ("song_off" + 0x10)
    END
    PATCH_IF NOT ("%rest_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xc0 ("rest_off" + 0x10)
    END
    PATCH_IF NOT ("%note_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xc4 ("note_off" + 0x10)
    END


COPY_EXISTING ~AR0300.ARE~ override                                      // Docks district STI trigger 2 (guildhall upper enterance to RR#012.ARE)
    READ_LONG 0x54 "actor_off"
    READ_LONG 0x5c "info_off"
    READ_SHORT 0x5a "info_num"
    READ_LONG 0x60 "spawn_off"
    READ_LONG 0x68 "ent_off"
    READ_LONG 0x70 "cont_off"
    READ_LONG 0x78 "item_off"
    READ_LONG 0x7c "vert_off"
    READ_SHORT 0x80 "vert_num"
    READ_LONG 0x84 "amb_off"
    READ_LONG 0x88 "var_off"
    READ_LONG 0xa0 "bmp_off"
    READ_LONG 0xa8 "door_off"
    READ_LONG 0xb0 "anim_off"
    READ_LONG 0xb8 "tiled_off"
    READ_LONG 0xbc "song_off"
    READ_LONG 0xc0 "rest_off"
    READ_LONG 0xc4 "note_off"
    SET "Left" = 953
    SET "Top" = 1146
    SET "Right" = 1029
    SET "Bottom" = 1234
    WRITE_SHORT 0x5a ("%info_num%" + 1)
    INSERT_BYTES "%info_off%" 0xC4                          // Insert new blank info point
      WRITE_ASCII "%info_off%" ~RR#STI02~                   // Trigger name
      WRITE_SHORT ("%info_off%" + 0x20) 2                   // Trigger type (trap, info or travel)
      WRITE_SHORT ("%info_off%" + 0x22) "%Left%"
      WRITE_SHORT ("%info_off%" + 0x24) "%Top%"
      WRITE_SHORT ("%info_off%" + 0x26) "%Right%"
      WRITE_SHORT ("%info_off%" + 0x28) "%Bottom%"
      WRITE_SHORT ("%info_off%" + 0x2A) 4                   // Number of vertices
      WRITE_LONG ("%info_off%" + 0x2C) "%vert_num%"         // First vertex index
      WRITE_SHORT ("%info_off%" + 0x34) 30                  // Cursor type
   WRITE_ASCII ("%info_off%" + 0x38) ~RR#012~               // Destination area
   WRITE_ASCII ("%info_off%" + 0x40) ~EXIT0300~             // Destination area's entrance name
      WRITE_LONG ("%info_off%" + 0x60) 772                  // Flags (i.e. trigger is initially deactivated, party required, NPC's can't pass)
    PATCH_IF NOT ("%actor_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x54 ("%actor_off%" + 0xC4)
    END
    PATCH_IF NOT ("%spawn_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x60 ("spawn_off" + 0xC4)
    END
    PATCH_IF NOT ("%ent_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x68 ("ent_off" + 0xC4)
    END
    PATCH_IF NOT ("%cont_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x70 ("cont_off" + 0xC4)
    END
    PATCH_IF NOT ("%item_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x78 ("item_off" + 0xC4)
    END
    PATCH_IF NOT ("%vert_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x7c ("vert_off" + 0xC4)
    END
    PATCH_IF NOT ("%amb_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x84 ("amb_off" + 0xC4)
    END
    PATCH_IF NOT ("%var_off%" < "%info_off%") BEGIN
      WRITE_LONG 0x88 ("var_off" + 0xC4)
    END
    PATCH_IF NOT ("%bmp_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xa0 ("bmp_off" + 0xC4)
    END
    PATCH_IF NOT ("%door_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xa8 ("door_off" + 0xC4)
    END
    PATCH_IF NOT ("%anim_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xb0 ("anim_off" + 0xC4)
    END
    PATCH_IF NOT ("%tiled_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xb8 ("tiled_off" + 0xC4)
    END
    PATCH_IF NOT ("%song_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xbc ("song_off" + 0xC4)
    END
    PATCH_IF NOT ("%rest_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xc0 ("rest_off" + 0xC4)
    END
    PATCH_IF NOT ("%note_off%" < "%info_off%") BEGIN
      WRITE_LONG 0xc4 ("note_off" + 0xC4)
    END
    // Add 4 new vertices
    READ_LONG 0x54 "actor_off"
    READ_LONG 0x5c "info_off"
    READ_SHORT 0x5a "info_num"
    READ_LONG 0x60 "spawn_off"
    READ_LONG 0x68 "ent_off"
    READ_LONG 0x70 "cont_off"
    READ_LONG 0x78 "item_off"
    READ_LONG 0x7c "vert_off"
    READ_SHORT 0x80 "vert_num"
    READ_LONG 0x84 "amb_off"
    READ_LONG 0x88 "var_off"
    READ_LONG 0xa0 "bmp_off"
    READ_LONG 0xa8 "door_off"
    READ_LONG 0xb0 "anim_off"
    READ_LONG 0xb8 "tiled_off"
    READ_LONG 0xbc "song_off"
    READ_LONG 0xc0 "rest_off"
    READ_LONG 0xc4 "note_off"
    WRITE_SHORT 0x80 ("%vert_num%" + 4)
    INSERT_BYTES ("%vert_off%" + (0x04 * "%vert_num%")) 0x10
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%") 1029     // Vertex1.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 2) 1234 // Vertex1.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 4) 953  // Vertex2.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 6) 1217 // Vertex2.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" + 8) 953  // Vertex3.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +10) 1146 // Vertex3.Y
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +12) 1029 // Vertex4.X
        WRITE_SHORT ("%vert_off%" + 0x04 * "%vert_num%" +14) 1166 // Vertex4.Y
    PATCH_IF NOT ("%actor_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x54 ("%actor_off%" + 0x10)
    END
    PATCH_IF NOT ("%info_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x5c ("info_off" + 0x10)
    END
    PATCH_IF NOT ("%spawn_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x60 ("spawn_off" + 0x10)
    END
    PATCH_IF NOT ("%ent_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x68 ("ent_off" + 0x10)
    END
    PATCH_IF NOT ("%cont_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x70 ("cont_off" + 0x10)
    END
    PATCH_IF NOT ("%item_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x78 ("item_off" + 0x10)
    END
    PATCH_IF NOT ("%amb_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x84 ("amb_off" + 0x10)
    END
    PATCH_IF NOT ("%var_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0x88 ("var_off" + 0x10)
    END
    PATCH_IF NOT ("%bmp_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xa0 ("bmp_off" + 0x10)
    END
    PATCH_IF NOT ("%door_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xa8 ("door_off" + 0x10)
    END
    PATCH_IF NOT ("%anim_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xb0 ("anim_off" + 0x10)
    END
    PATCH_IF NOT ("%tiled_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xb8 ("tiled_off" + 0x10)
    END
    PATCH_IF NOT ("%song_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xbc ("song_off" + 0x10)
    END
    PATCH_IF NOT ("%rest_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xc0 ("rest_off" + 0x10)
    END
    PATCH_IF NOT ("%note_off%" < "%vert_off%") BEGIN
      WRITE_LONG 0xc4 ("note_off" + 0x10)
    END


// Updated .CRE files

COPY_EXISTING ~STGUARD1.CRE~  override                            // ST Guild door guard(s) (renamed to Sentry)
  SAY NAME1 @700 SAY NAME2 @700                                     // Shadow Thief Sentry
  REPLACE_CRE_ITEM ~LEAT04~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // Studded Leather Armor (non-magical)
  ADD_CRE_ITEM ~SW1H20~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON2~ EQUIP      // a Scimitar (non-magical)
  ADD_CRE_ITEM ~SW1H20~ #0 #0 #0 ~UNSTEALABLE~ ~SHIELD~             // a Scimitar (non-magical)
  ADD_CRE_ITEM ~RR#STS03~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~INV10~  // Tier 3 marker (undroppable, used by script)
  ADD_CRE_ITEM ~SCRL1H~ #0 #0 #0 ~UNSTEALABLE~ ~INV11~              // a scroll of Haste
  ADD_CRE_ITEM ~POTN10~ #2 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~QITEM1~ // 2x Potion of Invisibility (undroppable)
  ADD_CRE_ITEM ~POTN52~ #1 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~QITEM2~ // 1x Potion of Extra Healing (undroppable)
  ADD_CRE_ITEM ~POTN10~ #1 #0 #0 ~NONE~ ~QITEM3~                    // 1x Potion of Invisibility
  READ_LONG 0x10 "flags"                                            // flags
  WRITE_LONG 0x10 ("%flags%" BOR 0b00001000)                        // original class: fighter
  WRITE_LONG 0x14 4000                                              // XP value (when killed)
  WRITE_LONG 0x18 161000                                            // current XP
  WRITE_SHORT 0x24 85                                               // current hit points
  WRITE_SHORT 0x26 85                                               // maximum hit points
  WRITE_SHORT 0x28 25344                                            // Sets avatar to THIEF_MALE_HUMAN
  WRITE_BYTE 0x2C 0                                                 // metal color
  WRITE_BYTE 0x2D 0                                                 // minor color
  WRITE_BYTE 0x2E 0                                                 // major color
  WRITE_BYTE 0x2F 2                                                 // skin color
  WRITE_BYTE 0x30 0                                                 // leather color
  WRITE_BYTE 0x31 0                                                 // armor color
  WRITE_BYTE 0x32 2                                                 // hair color
  WRITE_BYTE 0x45 60                                                // Hide in Shadows skill
  WRITE_SHORT 0x46 10                                               // natural AC
  WRITE_SHORT 0x48 10                                               // effective AC
  WRITE_BYTE 0x52 12                                                // THAC0
  WRITE_BYTE 0x54 8                                                 // save vs. death
  WRITE_BYTE 0x55 10                                                // save vs. wands
  WRITE_BYTE 0x56 9                                                 // save vs. polymorph
  WRITE_BYTE 0x57 9                                                 // save vs. breath
  WRITE_BYTE 0x58 11                                                // save vs. spells
  WRITE_BYTE 0x64 75                                                // Detect Illusions skill
  WRITE_BYTE 0x65 0                                                 // Set Traps skill
  WRITE_BYTE 0x66 0                                                 // Lore
  WRITE_BYTE 0x67 0                                                 // Open Locks skill
  WRITE_BYTE 0x68 60                                                // Move Silently skill
  WRITE_BYTE 0x69 10                                                // Find Traps skill
  WRITE_BYTE 0x6a 0                                                 // Pick Pockets skill
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 9                                                // level (first class)
  WRITE_BYTE 0x235 10                                               // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x238 18                                               // Strength
  WRITE_BYTE 0x239 58                                               // Strength bonus
  WRITE_BYTE 0x23a 12                                               // Inteligence
  WRITE_BYTE 0x23b 10                                               // Wisdom
  WRITE_BYTE 0x23c 17                                               // Dexterity
  WRITE_BYTE 0x23d 16                                               // Constitution
  WRITE_BYTE 0x23e 11                                               // Charisma
  WRITE_BYTE 0x23f 17                                               // morale
  WRITE_BYTE 0x240 5                                                // morale break
  WRITE_BYTE 0x242 30                                               // morale recovery
  WRITE_ASCII 0x250 ~None~ #8                                       // disable class AI script (USEITEM.BCS)
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  WRITE_BYTE 0x272 1                                                // race
  WRITE_BYTE 0x273 9                                                // class
  WRITE_BYTE 0x27b 50                                               // alignment
  SET_BG2_PROFICIENCY ~PROFICIENCYSCIMITARWAKISASHININJATO~ 3       // Give ST Sentry 3 stars in the BG2 Scimitar proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCYLONGSWORD~ 2                      // Give ST Sentry 2 stars in the BG2 Longsword proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCY2WEAPON~ 3                        // Give ST Sentry 2 stars in the BG2 Two Weapon Style proficiency
BUT_ONLY

COPY_EXISTING ~GAELAN2.CRE~  override                             // Gaelan Bayle (hostile)
  REMOVE_CRE_ITEM ~xbow09~                                          // removes the Light Crossbow +2 (messes up DW)
  REMOVE_CRE_ITEM ~bolt04~                                          // removes the Bolts of Biting
  REMOVE_CRE_ITEM ~bolt02~                                          // removes the Bolts +1
  REMOVE_CRE_ITEM ~bolt01~                                          // removes the non-enchanted Bolts
  REMOVE_CRE_ITEM ~clck01~                                          // removes the Cloak of Protection +1 (can't be worn with magical armor)
  REMOVE_CRE_ITEM ~misc4s~                                          // removes the Shadow Thief Cellar key (because the default version is non-pickpocketable)
  REMOVE_CRE_ITEM ~potn10~                                          // removes the Potions of Invisibility (because the default versions were pickpocketable and thus disrupted the STI stealth path)
  REMOVE_CRE_ITEM ~potn52~                                          // removes the Potions of Extra Healing (because the default versions were pickpocketable and thus disrupted the STI stealth path)
  ADD_CRE_ITEM ~misc4s~ #0 #0 #0 ~NONE~ ~INV7~                      // Shadow Thief Cellar key (can now be pickpocketed)
  ADD_CRE_ITEM ~POTN10~ #3 #0 #0 ~UNSTEALABLE~ ~QITEM1~             // Gives Gaelan 3x Potion of Invisibility
  ADD_CRE_ITEM ~POTN52~ #2 #0 #0 ~UNSTEALABLE~ ~QITEM2~             // Gives Gaelan 2x Potion of Extra Healing
  ADD_CRE_ITEM ~SW1H29~ #0 #0 #0 ~UNSTEALABLE~ ~SHIELD~             // a Short Sword +2
  ADD_CRE_ITEM ~SCRLA3~ #1 #0 #0 ~UNSTEALABLE~ ~INV1~               // a scroll of Glitterdust
  ADD_CRE_ITEM ~SCRL1I~ #1 #0 #0 ~UNSTEALABLE~ ~INV2~               // a scroll of Hold Person
  ADD_CRE_ITEM ~SCRL96~ #1 #0 #0 ~UNSTEALABLE~ ~INV3~               // a scroll of Mirror Image
  REPLACE_CRE_ITEM ~LEAT15~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // Studded Leather Armor +2
  WRITE_LONG 0x14 6000                                              // XP value (when killed)
  WRITE_LONG 0x18 1100000                                           // current XP
  WRITE_SHORT 0x24 75                                               // current hit points
  WRITE_SHORT 0x26 75                                               // maximum hit points
  WRITE_ASCII 0x34 ~RR#GAELS~ #8                                    // Sets Gaelan's small portrait
  WRITE_BYTE 0x45 80                                                // Hide in Shadows skill
  WRITE_BYTE 0x54 10                                                // save vs. death
  WRITE_BYTE 0x55 8                                                 // save vs. wands
  WRITE_BYTE 0x56 9                                                 // save vs. polymorph
  WRITE_BYTE 0x57 13                                                // save vs. breath
  WRITE_BYTE 0x58 9                                                 // save vs. spells
  WRITE_BYTE 0x64 85                                                // Detect Illusions skill
  WRITE_BYTE 0x67 40                                                // Open Locks skill
  WRITE_BYTE 0x68 80                                                // Move Silently skill
  WRITE_BYTE 0x69 30                                                // Find Traps skill
  WRITE_BYTE 0x6a 30                                                // Pick Pockets skill
  WRITE_BYTE 0x6e 0                                                 // BG1 Proficiency slot (large sword)
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x70 0                                                 // BG1 Proficiency slot (bow)
  WRITE_BYTE 0x71 0                                                 // BG1 Proficiency slot (spear)
  WRITE_BYTE 0x72 0                                                 // BG1 Proficiency slot (blunt)
  WRITE_BYTE 0x73 0                                                 // BG1 Proficiency slot (spiked)
  WRITE_BYTE 0x74 0                                                 // BG1 Proficiency slot (axe)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x235 0                                                // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x23f 17                                               // morale
  WRITE_ASCII 0x248 ~RR#GAELN~ #8                                   // assign override AI script
  WRITE_ASCII 0x250 ~None~ #8                                       // disable class AI script (SHOUTDLG.BCS)
  WRITE_ASCII 0x258 ~None~ #8                                       // disable race AI script (GPUSE.BCS)
  WRITE_ASCII 0x260 ~None~ #8                                       // disable general AI script (NONE)
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTARSGT.BCS)
  SET_BG2_PROFICIENCY ~PROFICIENCYSHORTSWORD~ 2                     // Give Gaelan 2 stars in the BG2 Shortsword proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCY2WEAPON~ 3                        // Give Gaelan 3 stars in the BG2 Two Weapon Style proficiency
PATCH_IF FILE_EXISTS_IN_GAME ~RR#TSB01.SPL~ BEGIN           // check for the Thief kit revisions component
  SET opcode_to_delete = "0"                                     // mark opcode #0 (AC vs. Damage Type Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode_to_delete = "54"                                    // mark opcode #54 (THAC0 Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode = "0"                                               // effect: #0 (AC vs. Damage Type Modifier)
  SET target = "1"                                               // target: 1 (self)
  SET timing = "9"                                               // timing mode: 9 (permanent after death)
  SET parameter1 = "4"                                           // param1: 4
  SET parameter2 = "0"                                           // param2: 0
  SET parameter3 = "0"                                           // param3: 0
  SET parameter4 = "0"                                           // param4: 0
  SET power = "0"                                                // power: 0
  SET resist_dispel = "0"                                        // dispel/resistance: 0 (non-magical)
  SET duration = "0"                                             // duration: 0
  SET probability1 = "100"                                       // probability1: 100%
  SET probability2 = "0"                                         // probability2: 0%
  SET dicenumber = "0"                                           // dicenumber: 0
  SET dicesize = "0"                                             // dicesize: 0
  SET savingthrow = "0"                                          // saving throw type: 0 (none)
  SET savebonus = "0"                                            // save bonus: 0
  SET school = "0"                                               // school: 0 (schoolless)
  SET lowestafflvl = "0"                                         // lowest level affected: 0
  SET highestafflvl = "0"                                        // highest level affected: 0
  SET casterx = "0"                                              // casterx: 0
  SET castery = "0"                                              // castery: 0
  SET targetx = "0"                                              // targetx: 0
  SET targety = "0"                                              // targety: 0
  SET casterlvl  = "15"                                          // caster level: 15
  SET sectype = "0"                                              // secondary type: 0
  SPRINT ~resource~ ~~                                           // resref: none
  SPRINT ~resource2~ ~~                                          // resref2: none
  SPRINT ~resource3~ ~~                                          // resref3: none
  SPRINT ~vvcresource~ ~~                                        // vvcresref: none
  SPRINT ~effsource~ ~SPCL441~                                   // effsource: SPCL441.SPL (Swashbuckler's innate AC bonus)
  SPRINT ~effvar~ ~~                                             // effvar: none
  LAUNCH_PATCH_MACRO ~ADD_CRE_EFFECT~
  SET opcode = "284"                                             // effect: #284 (Melee THAC0 Modifier)
  SET target = "1"                                               // target: 1 (self)
  SET timing = "9"                                               // timing mode: 9 (permanent after death)
  SET parameter1 = "7"                                           // param1: 7
  SET parameter2 = "0"                                           // param2: 0
  SET parameter3 = "0"                                           // param3: 0
  SET parameter4 = "0"                                           // param4: 0
  SET power = "0"                                                // power: 0
  SET resist_dispel = "0"                                        // dispel/resistance: 0 (non-magical)

  SET duration = "0"                                             // duration: 0
  SET probability1 = "100"                                       // probability1: 100%
  SET probability2 = "0"                                         // probability2: 0%
  SET dicenumber = "0"                                           // dicenumber: 0
  SET dicesize = "0"                                             // dicesize: 0
  SET savingthrow = "0"                                          // saving throw type: 0 (none)
  SET savebonus = "0"                                            // save bonus: 0
  SET school = "0"                                               // school: 0 (schoolless)
  SET lowestafflvl = "0"                                         // lowest level affected: 0
  SET highestafflvl = "0"                                        // highest level affected: 0
  SET casterx = "0"                                              // casterx: 0
  SET castery = "0"                                              // castery: 0
  SET targetx = "0"                                              // targetx: 0
  SET targety = "0"                                              // targety: 0
  SET casterlvl  = "15"                                          // caster level: 15
  SET sectype = "0"                                              // secondary type: 0
  SPRINT ~resource~ ~~                                           // resref: none
  SPRINT ~resource2~ ~~                                          // resref2: none
  SPRINT ~resource3~ ~~                                          // resref3: none
  SPRINT ~vvcresource~ ~~                                        // vvcresref: none
  SPRINT ~effsource~ ~RR#TSB01~                                  // effsource: RR#TSB01.SPL (Swashbuckler's fighter THAC0 progression)
  SPRINT ~effvar~ ~~                                             // effvar: none
  LAUNCH_PATCH_MACRO ~ADD_CRE_EFFECT~
END
BUT_ONLY

COPY_EXISTING ~MOOK02.CRE~ override                               // Mook (hostile)
  REMOVE_CRE_ITEM ~rndtre01~                                        // removes the random treasure 01 item
  REPLACE_CRE_ITEM ~LEAT01~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // unstealable Leather Armor (non-magical)
  REPLACE_CRE_ITEM ~SW1H04~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON1~        // unstealable Long Sword (non-magical)
  ADD_CRE_ITEM ~BOW04~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON2~ EQUIP TWOHANDED // Long Bow +1
  ADD_CRE_ITEM ~AROW01~ #20 #0 #0 ~UNSTEALABLE~ ~QUIVER3~           // Arrows (non-magical)
  ADD_CRE_ITEM ~AROW02~ #20 #0 #0 ~UNSTEALABLE~ ~QUIVER2~           // Arrows +1
  ADD_CRE_ITEM ~AROW05~ #20 #0 #0 ~UNSTEALABLE~ ~QUIVER1~           // Arrows of Biting
  ADD_CRE_ITEM ~POTN10~ #2 #0 #0 ~UNSTEALABLE~ ~QITEM1~             // Gives Mook 2x Potion of Invisibility
  ADD_CRE_ITEM ~POTN52~ #2 #0 #0 ~UNSTEALABLE~ ~QITEM2~             // Gives Mook 2x Potion of Extra Healing
  WRITE_LONG 0x14 2500                                              // XP value (when killed)
  WRITE_LONG 0x18 161000                                            // current XP
  WRITE_ASCII 0x34 ~RR#MOOKS~ #8                                    // Sets Mook's small portrait
  WRITE_BYTE 0x45 75                                                // Hide in Shadows skill
  WRITE_BYTE 0x54 10                                                // save vs. death
  WRITE_BYTE 0x55 12                                                // save vs. wands
  WRITE_BYTE 0x56 11                                                // save vs. polymorph
  WRITE_BYTE 0x57 12                                                // save vs. breath
  WRITE_BYTE 0x58 13                                                // save vs. spells
  WRITE_BYTE 0x64 50                                                // Detect Illusions skill
  WRITE_BYTE 0x67  0                                                // Open Locks skill
  WRITE_BYTE 0x68 55                                                // Move Silently skill
  WRITE_BYTE 0x69 10                                                // Find Traps skill
  WRITE_BYTE 0x6a 25                                                // Pick Pockets skill
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 7                                                // level (first class)
  WRITE_BYTE 0x235 8                                                // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x238 12                                               // Strength
  WRITE_BYTE 0x23f 15                                               // morale
  WRITE_BYTE 0x273 9                                                // class
  WRITE_ASCII 0x248 ~RR#MOOK~ #8                                    // assign override AI script
  WRITE_ASCII 0x250 ~None~ #8                                       // disable class AI script (SHOUTDLG.BCS)
  WRITE_ASCII 0x258 ~None~ #8                                       // disable race AI script (NONE)
  WRITE_ASCII 0x260 ~None~ #8                                       // disable general AI script (NONE)
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  SET_BG2_PROFICIENCY ~PROFICIENCYLONGBOW~ 2                        // Give Mook 2 stars in the BG2 Longbow proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCYLONGSWORD~ 2                      // Give Mook 2 stars in the BG2 Longsword proficiency
BUT_ONLY


COPY_EXISTING ~ARKANISG.CRE~  override                            // Arkanis Gath (in Mook's shipment quest)
  REPLACE_CRE_ITEM ~LEAT07~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // Studded Leather Armor +2
  ADD_CRE_ITEM ~SW1H09~ #0 #0 #0 ~UNSTEALABLE~ ~SHIELD~             // Short Sword +2
  ADD_CRE_ITEM ~POTN10~ #2 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~QITEM1~ // 2x Potion of Invisibility (undroppable)
  ADD_CRE_ITEM ~POTN10~ #2 #0 #0 ~NONE~ ~QITEM2~                    // 2x Potion of Invisibility
  ADD_CRE_ITEM ~POTN52~ #2 #0 #0 ~NONE~ ~QITEM3~                    // 2x Potion of Extra Healing
  ADD_CRE_ITEM ~SCRL1H~ #1 #0 #0 ~UNSTEALABLE~ ~INV1~               // 1x Scroll of Haste
  ADD_CRE_ITEM ~RR#STS03~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~INV10~  // Tier 3 marker (undroppable, used by script)
  ADD_CRE_ITEM ~RR#STS01~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~INV11~  // Tier 1 marker (undroppable, used by script)
  READ_LONG 0x10 "flags"                                            // flags
  WRITE_LONG 0x10 ("%flags%" BOR 0b00001000)                        // original class: fighter
  WRITE_LONG 0x14 9000                                              // XP value (when killed)
  WRITE_LONG 0x18 1320000                                           // current XP
  WRITE_SHORT 0x24 100                                              // current hit points
  WRITE_SHORT 0x26 100                                              // maximum hit points
  WRITE_BYTE 0x2C 46                                                // metal color
  WRITE_BYTE 0x2D 47                                                // minor color
  WRITE_BYTE 0x2E 66                                                // major color
  WRITE_BYTE 0x2F 11                                                // skin color
  WRITE_BYTE 0x30 0                                                 // leather color
  WRITE_BYTE 0x31 0                                                 // armor color
  WRITE_BYTE 0x32 2                                                 // hair color
  WRITE_ASCII 0x34 ~RR#ARKNS~ #8                                    // Sets Arkanis' small portrait
  WRITE_BYTE 0x45 100                                               // Hide in Shadows skill
  WRITE_BYTE 0x52 12                                                // THAC0
  WRITE_BYTE 0x53 1                                                 // base number of attacks
  WRITE_BYTE 0x54 8                                                 // save vs. death
  WRITE_BYTE 0x55 8                                                 // save vs. wands
  WRITE_BYTE 0x56 9                                                 // save vs. polymorph
  WRITE_BYTE 0x57 9                                                 // save vs. breath
  WRITE_BYTE 0x58 9                                                 // save vs. spells
  WRITE_BYTE 0x64 80                                                // Detect Illusions skill
  WRITE_BYTE 0x65 0                                                 // Set Traps skill
  WRITE_BYTE 0x67 50                                                // Open Locks skill
  WRITE_BYTE 0x68 100                                               // Move Silently skill
  WRITE_BYTE 0x69 50                                                // Find Traps skill
  WRITE_BYTE 0x6a 15                                                // Pick Pockets skill
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x72 0                                                 // BG1 Proficiency slot (blunt)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 9                                                // level (first class)
  WRITE_BYTE 0x235 16                                               // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x23f 20                                               // morale
  WRITE_BYTE 0x240 5                                                // morale break
  WRITE_BYTE 0x242 30                                               // morale recovery
  WRITE_ASCII 0x248 ~RR#STF01~ #8                                   // assign override AI script
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  WRITE_BYTE 0x27b 50                                               // alignment
  SET_BG2_PROFICIENCY ~PROFICIENCYSHORTSWORD~ 5                     // Give Arkanis 5 stars in the BG2 Shortsword proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCY2WEAPON~ 3                        // Give Arkanis 3 stars in the BG2 Two Weapon Style proficiency
BUT_ONLY


COPY_EXISTING ~MOOKFT01.CRE~  override                            // Shadow Thief Thug (in Mook's shipment quest)
  SAY NAME1 @703 SAY NAME2 @703                                     // Shadow Thief Thug
  REMOVE_CRE_ITEM ~helm01~                                          // real thieves don't need helmets :)
  REPLACE_CRE_ITEM ~LEAT10~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~          // Hide Armor (non-magical)
  REPLACE_CRE_ITEM ~SW1H20~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON1~ EQUIP  // Scimitar (non-magical)
  ADD_CRE_ITEM ~RR#HIDN~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~ // Undroppable Amulet of Invisibility (for simulating initial Hide in Shadows state)
  ADD_CRE_ITEM ~POTN10~ #1 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~QITEM1~ // 1x Potion of Invisibility (undroppable)
  ADD_CRE_ITEM ~POTN10~ #1 #0 #0 ~NONE~ ~QITEM2~                    // 1x Potion of Invisibility
  ADD_CRE_ITEM ~POTN52~ #1 #0 #0 ~NONE~ ~QITEM3~                    // 1x Potion of Extra Healing
  ADD_CRE_ITEM ~RR#STS04~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~INV10~  // Tier 4 marker (undroppable, used by script)
  READ_LONG 0x10 "flags"                                            // flags
  WRITE_LONG 0x10 ("%flags%" BOR 0b00001000)                        // original class: fighter
  WRITE_LONG 0x14 2500                                              // XP value (when killed)
  WRITE_LONG 0x18 161000                                            // current XP
  WRITE_SHORT 0x24 60                                               // current hit points
  WRITE_SHORT 0x26 60                                               // maximum hit points
  WRITE_BYTE 0x2C 50                                                // metal color
  WRITE_BYTE 0x2D 50                                                // minor color
  WRITE_BYTE 0x2E 57                                                // major color
  WRITE_BYTE 0x2F 12                                                // skin color
  WRITE_BYTE 0x30 57                                                // leather color
  WRITE_BYTE 0x31 50                                                // armor color
  WRITE_BYTE 0x32 0                                                 // hair color
  WRITE_BYTE 0x45 70                                                // Hide in Shadows skill
  WRITE_BYTE 0x52 14                                                // THAC0
  WRITE_BYTE 0x54 10                                                // save vs. death
  WRITE_BYTE 0x55 10                                                // save vs. wands
  WRITE_BYTE 0x56 10                                                // save vs. polymorph
  WRITE_BYTE 0x57 12                                                // save vs. breath
  WRITE_BYTE 0x58 11                                                // save vs. spells
  WRITE_BYTE 0x64 50                                                // Detect Illusions skill
  WRITE_BYTE 0x67 20                                                // Open Locks skill
  WRITE_BYTE 0x68 75                                                // Move Silently skill
  WRITE_BYTE 0x69 0                                                 // Find Traps skill
  WRITE_BYTE 0x6a 20                                                // Pick Pockets skill
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x72 0                                                 // BG1 Proficiency slot (blunt)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 7                                                // level (first class)
  WRITE_BYTE 0x235 10                                               // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x238 16                                               // Strength
  WRITE_BYTE 0x23a 13                                               // Inteligence
  WRITE_BYTE 0x23b 12                                               // Wisdom
  WRITE_BYTE 0x23c 17                                               // Dexterity
  WRITE_BYTE 0x23d 16                                               // Constitution
  WRITE_BYTE 0x23f 15                                               // morale
  WRITE_BYTE 0x240 5                                                // morale break
  WRITE_ASCII 0x248 ~RR#STF01~ #8                                   // assign override AI script
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  WRITE_BYTE 0x273 9                                                // class
  WRITE_ASCII 0x280 ~MOOKFT01~ #32                                  // death variable
  SET_BG2_PROFICIENCY ~PROFICIENCYSCIMITARWAKISASHININJATO~ 2       // Give Shadow Thief Thug 2 stars in the BG2 Scimitar proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCYSWORDANDSHIELD~ 2                 // Give Shadow Thief Thug 2 stars in the BG2 Sword and Shield proficiency
BUT_ONLY


COPY_EXISTING ~MOOKFT02.CRE~  override                            // Shadow Thief, wields poisoned daggers (Mook's quest)
  REMOVE_CRE_ITEM ~potn20~                                          // removes the Antidote
  ADD_CRE_ITEM ~LEAT01~ #0 #0 #0 ~UNSTEALABLE~ ~ARMOR~              // Leather Armor (non-magical)
  ADD_CRE_ITEM ~SHLD08~ #0 #0 #0 ~UNSTEALABLE~ ~SHIELD~             // Buckler (non-magical)
  ADD_CRE_ITEM ~DAGG01~ #0 #0 #0 ~UNSTEALABLE~ ~WEAPON2~            // Dagger (non-magical)
  ADD_CRE_ITEM ~RR#HIDN~ #0 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~AMULET~ // Undroppable Amulet of Invisibility (for simulating initial Hide in Shadows state)
  ADD_CRE_ITEM ~POTN52~ #1 #0 #0 ~NONE~ ~QITEM1~                    // 1x Potion of Extra Healing
  ADD_CRE_ITEM ~RR#STS04~ #1 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~INV10~  // Tier 4 marker (undroppable, used by script)
  ADD_CRE_ITEM ~RR#STS02~ #1 #0 #0 ~UNSTEALABLE&UNDROPPABLE~ ~INV11~  // Tier 2 marker (undroppable, used by script)
  READ_LONG 0x10 "flags"                                            // flags
  WRITE_LONG 0x10 ("%flags%" BOR 0b00001000)                        // original class: fighter
  WRITE_LONG 0x14 2500                                              // XP value (when killed)
  WRITE_LONG 0x18 161000                                            // current XP
  WRITE_SHORT 0x24 55                                               // current hit points
  WRITE_SHORT 0x26 55                                               // maximum hit points
  WRITE_BYTE 0x45 75                                                // Hide in Shadows skill
  WRITE_BYTE 0x52 14                                                // THAC0
  WRITE_BYTE 0x54 10                                                // save vs. death
  WRITE_BYTE 0x55 10                                                // save vs. wands
  WRITE_BYTE 0x56 10                                                // save vs. polymorph
  WRITE_BYTE 0x57 12                                                // save vs. breath
  WRITE_BYTE 0x58 11                                                // save vs. spells
  WRITE_BYTE 0x64 55                                                // Detect Illusions skill
  WRITE_BYTE 0x68 55                                                // Move Silently skill
  WRITE_BYTE 0x69 20                                                // Find Traps skill
  WRITE_BYTE 0x6a 0                                                 // Pick Pockets skill
  WRITE_BYTE 0x6f 0                                                 // BG1 Proficiency slot (small sword)
  WRITE_BYTE 0x72 0                                                 // BG1 Proficiency slot (blunt)
  WRITE_BYTE 0x75 0                                                 // BG1 Proficiency slot (missile)
  WRITE_BYTE 0x234 7                                                // level (first class)
  WRITE_BYTE 0x235 10                                               // level (second class)
  WRITE_BYTE 0x236 0                                                // level (third class)
  WRITE_BYTE 0x238 15                                               // Strength
  WRITE_BYTE 0x23a 14                                               // Inteligence
  WRITE_BYTE 0x23b 10                                               // Wisdom
  WRITE_BYTE 0x23c 18                                               // Dexterity
  WRITE_BYTE 0x23d 12                                               // Constitution
  WRITE_BYTE 0x23e 11                                               // Charisma
  WRITE_BYTE 0x23f 15                                               // morale
  WRITE_BYTE 0x240 5                                                // morale break
  WRITE_ASCII 0x248 ~RR#STF01~ #8                                   // assign override AI script
  WRITE_ASCII 0x268 ~None~ #8                                       // disable default AI script (WTASIGHT.BCS)
  WRITE_BYTE 0x273 9                                                // class
  WRITE_ASCII 0x280 ~MOOKFT02~ #32                                  // death variable
  SET_BG2_PROFICIENCY ~PROFICIENCYDAGGER~ 3                         // Give Shadow Thief 3 stars in the BG2 Dagger proficiency
  SET_BG2_PROFICIENCY ~PROFICIENCYSWORDANDSHIELD~ 2                 // Give Shadow Thief 2 stars in the BG2 Sword and Shield proficiency
BUT_ONLY

COPY_EXISTING ~PALERN.CRE~  override                              // Palern, the halfling hostage captured by the Shadow Thieves
  WRITE_ASCII 0x248 ~RR#PALR~ #8                                    // assign Palern's new override AI script (for the stealth path)
BUT_ONLY

COPY ~RR/RR_STIM/ACTORS/RR#ARAN2.CRE~             override              // Aran Linvail (STI version)
COPY ~RR/RR_STIM/ACTORS/RR#BOOTR.CRE~             override              // Booter the torturer (STI version)
COPY ~RR/RR_STIM/ACTORS/RR#STGOL.CRE~             override              // STG basement guardian Golems (Haz's creations)
COPY ~RR/RR_STIM/ACTORS/RR#SAW01.CRE~             override              // STG female Elven F/T ranged (Arrows of Biting)
  SAY NAME1 @702 SAY NAME2 @702                                              // Shadow Thief Archer
COPY ~RR/RR_STIM/ACTORS/RR#SAW02.CRE~             override              // STG male Human F/T melee
  SAY NAME1 @703 SAY NAME2 @703                                              // Shadow Thief Thug
COPY ~RR/RR_STIM/ACTORS/RR#SAW03.CRE~             override              // STG male Human F/T ranged (Arrows of Detonation)
  SAY NAME1 @702 SAY NAME2 @702                                              // Shadow Thief Archer
COPY ~RR/RR_STIM/ACTORS/RR#SAW04.CRE~             override              // STG male Human F/T Assasin
PATCH_IF FILE_EXISTS_IN_GAME ~RR#TAS00.SPL~ BEGIN           // check for the Thief kit revisions component
  SET opcode_to_delete = "278"                                   // mark opcode #278 (To Hit Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode_to_delete = "73"                                    // mark opcode #73 (Extra Damage Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode = "33"                                              // effect: #33 (Save vs. Death Modifier)
  SET target = "1"                                               // target: 1 (self)
  SET timing = "9"                                               // timing mode: 9 (permanent after death)
  SET parameter1 = "1"                                           // param1: 1
  SET parameter2 = "0"                                           // param2: 0
  SET parameter3 = "0"                                           // param3: 0
  SET parameter4 = "0"                                           // param4: 0
  SET power = "0"                                                // power: 0
  SET resist_dispel = "0"                                        // dispel/resistance: 0 (non-magical)
  SET duration = "0"                                             // duration: 0
  SET probability1 = "100"                                       // probability1: 100%
  SET probability2 = "0"                                         // probability2: 0%
  SET dicenumber = "0"                                           // dicenumber: 0
  SET dicesize = "0"                                             // dicesize: 0
  SET savingthrow = "0"                                          // saving throw type: 0 (none)
  SET savebonus = "0"                                            // save bonus: 0
  SET school = "0"                                               // school: 0 (schoolless)
  SET lowestafflvl = "0"                                         // lowest level affected: 0
  SET highestafflvl = "0"                                        // highest level affected: 0
  SET casterx = "0"                                              // casterx: 0
  SET castery = "0"                                              // castery: 0
  SET targetx = "0"                                              // targetx: 0
  SET targety = "0"                                              // targety: 0
  SET casterlvl  = "8"                                           // caster level: 8
  SET sectype = "0"                                              // secondary type: 0
  SPRINT ~resource~ ~RR#TAS00~                                   // resref: RR#TAS00.SPL (Poison Expertise)
  SPRINT ~resource2~ ~~                                          // resref2: none
  SPRINT ~resource3~ ~~                                          // resref3: none
  SPRINT ~vvcresource~ ~~                                        // vvcresref: none
  SPRINT ~effsource~ ~~                                          // effsource: none
  SPRINT ~effvar~ ~~                                             // effvar: none
  LAUNCH_PATCH_MACRO ~ADD_CRE_EFFECT~
END
COPY ~RR/RR_STIM/ACTORS/RR#SAW08.CRE~             override              // Tizzak (Bodhi's imprisoned spy)
COPY ~RR/RR_STIM/ACTORS/RR#SAW09.CRE~             override              // Priestess of Mask (fem. Half-Elf C/M)
  SAY NAME1 @708 SAY NAME2 @708                                              // Priestess of Mask
COPY ~RR/RR_STIM/ACTORS/RR#HAZ.CRE~               override              // Haz (male Human Mage)
COPY ~RR/RR_STIM/ACTORS/RR#DEDRL.CRE~             override              // Dedral (male Human Fighter)
COPY ~RR/RR_STIM/ACTORS/RR#SFL01.CRE~             override              // STG male Human F/T Assassin melee
PATCH_IF FILE_EXISTS_IN_GAME ~RR#TAS00.SPL~ BEGIN           // check for the Thief kit revisions component
  SET opcode_to_delete = "278"                                   // mark opcode #278 (To Hit Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode_to_delete = "73"                                    // mark opcode #73 (Extra Damage Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode = "33"                                              // effect: #33 (Save vs. Death Modifier)
  SET target = "1"                                               // target: 1 (self)
  SET timing = "9"                                               // timing mode: 9 (permanent after death)
  SET parameter1 = "1"                                           // param1: 1
  SET parameter2 = "0"                                           // param2: 0
  SET parameter3 = "0"                                           // param3: 0
  SET parameter4 = "0"                                           // param4: 0
  SET power = "0"                                                // power: 0
  SET resist_dispel = "0"                                        // dispel/resistance: 0 (non-magical)
  SET duration = "0"                                             // duration: 0
  SET probability1 = "100"                                       // probability1: 100%
  SET probability2 = "0"                                         // probability2: 0%
  SET dicenumber = "0"                                           // dicenumber: 0
  SET dicesize = "0"                                             // dicesize: 0
  SET savingthrow = "0"                                          // saving throw type: 0 (none)
  SET savebonus = "0"                                            // save bonus: 0
  SET school = "0"                                               // school: 0 (schoolless)
  SET lowestafflvl = "0"                                         // lowest level affected: 0
  SET highestafflvl = "0"                                        // highest level affected: 0
  SET casterx = "0"                                              // casterx: 0
  SET castery = "0"                                              // castery: 0
  SET targetx = "0"                                              // targetx: 0
  SET targety = "0"                                              // targety: 0
  SET casterlvl  = "8"                                           // caster level: 8
  SET sectype = "0"                                              // secondary type: 0
  SPRINT ~resource~ ~RR#TAS00~                                   // resref: RR#TAS00.SPL (Poison Expertise)
  SPRINT ~resource2~ ~~                                          // resref2: none
  SPRINT ~resource3~ ~~                                          // resref3: none
  SPRINT ~vvcresource~ ~~                                        // vvcresref: none
  SPRINT ~effsource~ ~~                                          // effsource: none
  SPRINT ~effvar~ ~~                                             // effvar: none
  LAUNCH_PATCH_MACRO ~ADD_CRE_EFFECT~
END
COPY ~RR/RR_STIM/ACTORS/RR#SFL02.CRE~             override              // STG male Human F/T Kensai melee
  SAY NAME1 @701 SAY NAME2 @701                                              // Kara-Tur Mercenary
COPY ~RR/RR_STIM/ACTORS/RR#SFL03.CRE~             override              // STG male Human F/T Assassin melee
PATCH_IF FILE_EXISTS_IN_GAME ~RR#TAS00.SPL~ BEGIN           // check for the Thief kit revisions component
  SET opcode_to_delete = "278"                                   // mark opcode #278 (To Hit Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode_to_delete = "73"                                    // mark opcode #73 (Extra Damage Modifier) for deletion
  LAUNCH_PATCH_MACRO ~DELETE_CRE_EFFECT~
  SET opcode = "33"                                              // effect: #33 (Save vs. Death Modifier)
  SET target = "1"                                               // target: 1 (self)
  SET timing = "9"                                               // timing mode: 9 (permanent after death)
  SET parameter1 = "1"                                           // param1: 1
  SET parameter2 = "0"                                           // param2: 0
  SET parameter3 = "0"                                           // param3: 0
  SET parameter4 = "0"                                           // param4: 0
  SET power = "0"                                                // power: 0
  SET resist_dispel = "0"                                        // dispel/resistance: 0 (non-magical)
  SET duration = "0"                                             // duration: 0
  SET probability1 = "100"                                       // probability1: 100%
  SET probability2 = "0"                                         // probability2: 0%
  SET dicenumber = "0"                                           // dicenumber: 0
  SET dicesize = "0"                                             // dicesize: 0
  SET savingthrow = "0"                                          // saving throw type: 0 (none)
  SET savebonus = "0"                                            // save bonus: 0
  SET school = "0"                                               // school: 0 (schoolless)
  SET lowestafflvl = "0"                                         // lowest level affected: 0
  SET highestafflvl = "0"                                        // highest level affected: 0
  SET casterx = "0"                                              // casterx: 0
  SET castery = "0"                                              // castery: 0
  SET targetx = "0"                                              // targetx: 0
  SET targety = "0"                                              // targety: 0
  SET casterlvl  = "8"                                           // caster level: 8
  SET sectype = "0"                                              // secondary type: 0
  SPRINT ~resource~ ~RR#TAS00~                                   // resref: RR#TAS00.SPL (Poison Expertise)
  SPRINT ~resource2~ ~~                                          // resref2: none
  SPRINT ~resource3~ ~~                                          // resref3: none
  SPRINT ~vvcresource~ ~~                                        // vvcresref: none
  SPRINT ~effsource~ ~~                                          // effsource: none
  SPRINT ~effvar~ ~~                                             // effvar: none
  LAUNCH_PATCH_MACRO ~ADD_CRE_EFFECT~
END
COPY ~RR/RR_STIM/ACTORS/RR#SFL04.CRE~             override              // STG female Elf Mage-Enchanter
  SAY NAME1 @706 SAY NAME2 @706                                              // Zhentarim Mercenary
COPY ~RR/RR_STIM/ACTORS/RR#STI01.CRE~             override              // STG male Human F/T melee (ambusher)
COPY ~RR/RR_STIM/ACTORS/RR#STI02.CRE~             override              // STG male Human F/T melee (elite Kensai)
  SAY NAME1 @701 SAY NAME2 @701                                              // Kara-Tur Mercenary
COPY ~RR/RR_STIM/ACTORS/RR#STI03.CRE~             override              // STG male Human F/T ranged (Poisoned Dagger thrower)


// Give Booter And Aran the new daggers (only needed if the "Additional equipment for Thieves and Bards" component is not installed)

ACTION_IF NOT FILE_EXISTS_IN_GAME ~RR#GUARA.ITM~ BEGIN
COPY ~RR/RR_CORE/BAM/RR#PLAG.BAM~       override                // Plaguebearer (Dagger +3)
COPY ~RR/RR_CORE/ITEMS/RR#PLAG.ITM~     override
  SAY NAME2 @124 SAY DESC @125 // Plaguebearer
COPY ~RR/RR_CORE/SPELLS/RR#PLAG1.EFF~   override                // Filthy Fever immunity effect (applies to Undead, Constructs, Slimes and Elementals)
COPY ~RR/RR_CORE/SPELLS/RR#PLAG1.SPL~   override                // Filthy Fever disease (-2 to DEX and CON)
  SAY NAME1 @717 SAY NAME2 @717 // Filthy Fever
COPY ~RR/RR_CORE/SPELLS/RR#PLAG2.EFF~   override                // Devil Chills immunity effect (applies to Undead, Constructs, Slimes and Elementals)
COPY ~RR/RR_CORE/SPELLS/RR#PLAG2.SPL~   override                // Devil Chills disease (-2 to STR + Slow effect)
  SAY NAME1 @718 SAY NAME2 @718 // Devil Chills
COPY ~RR/RR_CORE/SPELLS/RR#PLAG3.EFF~   override                // Mummy Rot immunity effect (applies to Undead, Constructs, Slimes and Elementals)
COPY ~RR/RR_CORE/SPELLS/RR#PLAG3.SPL~   override                // Mummy Rot disease (deals 20 points of disease damage, 2 per round)
  SAY NAME1 @719 SAY NAME2 @719 // Mummy Rot

COPY_EXISTING  ~DAGG04.ITM~                  override             // Fix the Longtooth Dagger
 WRITE_LONG 0x80 "01"                                               // Increase range to 1 (was 0)
 WRITE_SHORT 0x42 60                                                // Require Lore value of 60 to identify (was 0 in BG2)
  BUT_ONLY

COPY ~RR/RR_CORE/BAM/RR#ACUMN.BAM~      override               // Dagger of Acumen icon
COPY ~RR/RR_CORE/ITEMS/RR#ACUMN.ITM~    override               // Dagger of Acumen (Mage Dagger +3)
  SAY NAME2 @146 SAY DESC @147
END

COPY ~RR/RR_STIM/ITEMS/RR#HGROD.ITM~    override               // Haz's Rod of Golem Control
  SAY NAME2 @721 SAY DESC @722

// PnP Wand of Fear (for Guildhall Basement, Container 7)

COPY ~RR/RR_STIM/ITEMS/RR#WND01.ITM~     override              // Wand of Fear
  SAY DESC @720

COPY ~RR/RR_STIM/BAM~                            override      // New portraits for the Shadow Thief characters
COPY_EXISTING ~ARAN.CRE~ override                                 // Aran Linvail (non-STI)
            ~ARAN02.CRE~ override                                 // Aran Linvail (Quest Pack & original game)
  WRITE_ASCII 0x34 ~RR#ARANS~ #8                                    // Sets Aran's small portrait
COPY_EXISTING ~GAELAN.CRE~ override                               // Gaelan Bayle (non-STI)
  WRITE_ASCII 0x34 ~RR#GAELS~ #8                                    // Sets Gaelan's small portrait
COPY_EXISTING ~MOOK.CRE~ override                                 // Mook (non-STI)
  WRITE_ASCII 0x34 ~RR#MOOKS~ #8                                    // Sets Mook's small portrait
COPY_EXISTING ~BOOTER.CRE~ override                               // Booter (non-STI)
  WRITE_ASCII 0x34 ~RR#BOOTS~ #8                                    // Sets Booter's small portrait
COPY_EXISTING ~PALERN.CRE~ override                               // Palern Flynn (Shadow Thief halfling hostge)
  WRITE_ASCII 0x34 ~RR#PALRS~ #8                                    // Sets Palern's small portrait
COPY_EXISTING ~ARNFGT06.CRE~ override                             // Haz (non-STI, aids party during Aran's tasks)
  WRITE_ASCII 0x34 ~RR#HAZS~ #8                                     // Sets Haz's small portrait
  ADD_CRE_ITEM ~CLCK14~ #0 #0 #0 ~NONE~ ~ARMOR~                     // Gives Haz an Adventurer's Robe (for cosmetic purposes)


// Updated area and AI scripts

COPY_EXISTING ~AR0300.BCS~                           override              // Docks area script, Mook spawn fix
  DECOMPILE_BCS_TO_BAF         // Switch the locations of MOOK02 and MOOKFT01 in order for Mook's dialogue to trigger first
  REPLACE_TEXTUALLY EXACT_MATCH ~CreateCreature("MOOK02",[1710.3625],12)~ ~CreateCreature("MOOK02",[1886.3659],6)~
  REPLACE_TEXTUALLY EXACT_MATCH ~CreateCreature("MOOKFT01",[1886.3659],12)~ ~CreateCreature("MOOKFT01",[1710.3625],12)~
  REPLACE_TEXTUALLY EXACT_MATCH ~CreateCreature("MOOKFT02",[1720.3560],0)~ ~CreateCreature("RR#STI03",[1720.3560],0)~
  COMPILE_BAF_TO_BCS
  BUT_ONLY

EXTEND_BOTTOM ~AR0300.BCS~  ~RR/RR_STIM/COMPILE/AR0300.BAF~                  // Activation block for the new STI areas

COMPILE ~RR/RR_STIM/COMPILE/RR#010.BAF~                                      // STI guildhall basement area script
COMPILE ~RR/RR_STIM/COMPILE/RR#011.BAF~                                      // STI guildhall main floor area script
COMPILE ~RR/RR_STIM/COMPILE/RR#012.BAF~                                      // STI guildhall top floor area script
COMPILE ~RR/RR_STIM/COMPILE/RR#STAMB.BAF~                                    // STI floor trigger for Dedral's ambush
COMPILE ~RR/RR_STIM/COMPILE/RR#RDBTN.BAF~                                    // STI trigger for the Red Button (for opening the first sanctum door)
COMPILE ~RR/RR_STIM/COMPILE/RR#PALR.BAF~                                     // Palern's override AI script, makes him escape if invisible (stealth path)

COMPILE ~RR/RR_STIM/COMPILE/RR#STF01.BAF~                                    // Shadow Thief melee combat AI
COMPILE ~RR/RR_STIM/COMPILE/RR#STF02.BAF~                                    // Shadow Thief ranged combat AI
COMPILE ~RR/RR_STIM/COMPILE/RR#STM01.BAF~                                    // Shadow Thief mage AI (main & top floor)
COMPILE ~RR/RR_STIM/COMPILE/RR#STM02.BAF~                                    // Shadow Thief mage/cleric AI (basement Priestess of Mask)
COMPILE ~RR/RR_STIM/COMPILE/RR#GAELN.BAF~                                    // Gaelan Bayle's AI (includes stealth path pickpocket code)
COMPILE ~RR/RR_STIM/COMPILE/RR#MOOK.BAF~                                     // Mook's AI (includes stealth path pickpocket code)
COMPILE ~RR/RR_STIM/COMPILE/RR#BOOTR.BAF~                                    // Booter's AI (includes stealth path pickpocket code)
COMPILE ~RR/RR_STIM/COMPILE/RR#DEDRL.BAF~                                    // Dedral's AI
COMPILE ~RR/RR_STIM/COMPILE/RR#HAZ.BAF~                                      // Haz's AI
COMPILE ~RR/RR_STIM/COMPILE/RR#ARAN2.BAF~                                    // Aran Livail's STI combat AI script
COMPILE ~RR/RR_STIM/COMPILE/RR#MSLD.BAF~                                     // Mislead script (for Aran's clone)
COMPILE ~RR/RR_STIM/COMPILE/RR#STGOL.BAF~                                    // Guardian Golem AI script (includes code for deactivation via control rod)
COMPILE ~RR/RR_STIM/COMPILE/RR#DOR01.BAF~                                    // Door script for Aran's chamber

COPY_EXISTING ~STGUARD1.BCS~ override                                      // STI Sentry override script fix & Detect -> See (needed for stealth path)
  DECOMPILE_BCS_TO_BAF
    REPLACE_TEXTUALLY EXACT_MATCH ~Allegiance(Myself,ENEMY)
!See([PC])~ ~Global("RR#Active","LOCALS",0)
Allegiance(Myself,ENEMY)
!See([PC])~
    REPLACE_TEXTUALLY EXACT_MATCH ~MoveToObject([PC])~ ~SetGlobal("RR#Active","LOCALS",1)
Shout(124)
ChangeAIScript("",CLASS)
ChangeAIScript("RR#STF01",OVERRIDE)~
    REPLACE_TEXTUALLY EXACT_MATCH ~Detect([PC])~ ~See([PC])~
  COMPILE_BAF_TO_BCS
   BUT_ONLY
 EXTEND_TOP ~STGUARD1.BCS~  ~RR/RR_STIM/COMPILE/STGUARD1.BAF~       // Makes the Sentries flee if Aran is already dead (i.e. via stealth path)


// New trap scripts

COMPILE ~RR/RR_STIM/COMPILE/RR#TRP01.BAF~                           // Recoverable Arrow of Dispelling trap (1 arrow)
COMPILE ~RR/RR_STIM/COMPILE/RR#TRP02.BAF~                           // Recoverable Arrow of Detonation trap (1 arrow)
COMPILE ~RR/RR_STIM/COMPILE/RR#TRP03.BAF~                           // Recoverable Arrow of Biting trap (5 arrows)
COMPILE ~RR/RR_STIM/COMPILE/RR#TRP04.BAF~                           // Recoverable Acid Arrow trap (5 arrows)
COMPILE ~RR/RR_STIM/COMPILE/RR#TRP05.BAF~                           // Recoverable Poisoned dart trap (10 darts)
COMPILE ~RR/RR_STIM/COMPILE/RR#TRP10.BAF~                           // New Grease spell trap

// Updated dialogue files
COMPILE ~RR/RR_STIM/COMPILE/GAELAN2.D~                              // STI Gaelan Bayle's updated dialogue (spawn allies)
COMPILE ~RR/RR_STIM/COMPILE/STGUARD1.D~                             // STI Guildhall Sentry's updated dialogue (spawn allies)
COMPILE ~RR/RR_STIM/COMPILE/PALERN.D~                               // Palern's updated dialogue (stealth path related)
COMPILE ~RR/RR_STIM/COMPILE/RR#DEDRL.D~                             // Daedral's new dialogue (due to new area)
COMPILE ~RR/RR_STIM/COMPILE/ARNWAR08.D~                             // Tizzak's updated dialogue (attempt to hide in shadows before escaping)

ACTION_IF NOT FILE_EXISTS_IN_GAME ~rr#guara.itm~ BEGIN              // Check for RR's Additional Equipment component
  COMPILE ~RR/RR_CORE/COMPILE/ARAN.D~                               // Aran Linvail's Chapter 6 SSoB dialogue line
  COMPILE ~RR/RR_CORE/COMPILE/RENAL.D~                              // Renal awards the party with a regular +3 Shortsword instead of the SSoB
END                                                                 // Ends check for RR's Additional Equipment component

// Make Tizzak's and hostile Booter's dialogue pause the game

COPY_EXISTING ARNWAR08.DLG override //Tizzak
              BOOTER02.DLG override //Hostile Booter
  WRITE_LONG 0x30 0
BUT_ONLY



//////////////////////////////////////////////////////
// Rogue Rebalancing - BG2-style icons for RR content
//////////////////////////////////////////////////////

BEGIN @999 DESIGNATED 999

COPY ~rr/rr_core/bam/bg2s~ override



// *********************************** END OF FILE ***********************************************
